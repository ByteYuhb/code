
> ğŸ”¥ **Hiï¼Œæˆ‘æ˜¯å°ä½™ã€‚**
>
> **æœ¬æ–‡å·²æ”¶å½•åˆ° [GitHub Â· Androider-Planet](https://github.com/ByteYuhb/Androider-Planet) ä¸­ã€‚è¿™é‡Œæœ‰ Android è¿›é˜¶æˆé•¿çŸ¥è¯†ä½“ç³»ï¼Œå…³æ³¨å…¬ä¼—å· [[å°ä½™çš„è‡ªä¹ å®¤](https://mp.weixin.qq.com/s?__biz=MzkwODI1NDEwMA==&mid=2247483986&idx=1&sn=57136c9c062caa1026edf9ed35915c2b&chksm=c0cd8ca9f7ba05bfcfadad10bd97006bbb57afdd048c9c46fe57d122af834f569aa9d8df0e48&token=2142008574&lang=zh_CN#rd)] ï¼Œåœ¨æˆåŠŸçš„è·¯ä¸Šä¸è¿·è·¯ï¼**
## å‰è¨€
å‰é¢æ–‡ç« æˆ‘ä»¬å°è£…äº†ç½‘ç»œè¯·æ±‚ç»„ä»¶`lib_nework`å’Œå›¾ç‰‡åŠ è½½ç»„ä»¶`lib_image_loader`ï¼Œä»Šå¤©æˆ‘ä»¬æ¥å°è£…ä¸€ä¸ªè¿›ç¨‹ä¿æ´»çš„ç»„ä»¶`lib_pull_alive`


ç›¸å…³æ–‡ç« ï¼š

 [Androidç»„ä»¶åŒ–å¼€å‘ï¼ˆä¸€ï¼‰--Mavenç§æœçš„æ­å»º](https://juejin.cn/post/7118646272323485709)

[ Androidç»„ä»¶åŒ–å¼€å‘ï¼ˆäºŒï¼‰--ç½‘ç»œè¯·æ±‚ç»„ä»¶å°è£…](https://juejin.cn/post/7119281692350611493)

[Androidç»„ä»¶åŒ–å¼€å‘ï¼ˆä¸‰ï¼‰--å›¾ç‰‡åŠ è½½ç»„ä»¶å°è£…](https://juejin.cn/post/7120791098775044103)


![ç»„ä»¶åŒ–å¼€å‘.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9b173a0d817645658eb0f5bc853bd2d4~tplv-k3u1fbpfcp-watermark.image?)

è¿œå¤æ—¶ä»£ï¼Œå‡ºç°è¿‡å¾ˆå¤šé»‘ç§‘æŠ€ï¼Œæ¯”å¦‚`MarsDaemon`ï¼Œä½¿ç”¨åŒè¿›ç¨‹å®ˆæŠ¤çš„æ–¹å¼è¿›è¡Œä¿æ´»ï¼Œåœ¨å½“æ—¶å¯è°“é£å…‰æ— é™ï¼Œå¯æƒœåœ¨`8.0`æ—¶ä»£åˆ°æ¥å°±è¢«åºŸå¼ƒäº†ã€‚

åˆæ¯”å¦‚åé¢å‡ºç°çš„`1åƒç´ Activity`çš„ä¿æ´»æ–¹å¼ï¼Œè¯´ä»–æµæ°“ä¸€ç‚¹ä¸è¿‡åˆ†ï¼Œå¦‚æœæ¯ä¸ªäººéƒ½ä½¿ç”¨è¿™äº›æ“ä½œï¼Œå› ä¸ºåŠŸè€—çš„å¤§å¤§å¢åŠ ï¼Œä¼šç›´æ¥å½±å“åˆ°æ‰‹æœºä½¿ç”¨å¯¿å‘½ã€‚
å› æ­¤å„å¤§æ‰‹æœºå‚å•†ä¸ºäº†è§£å†³è¿™ä¸€ç°è±¡çš„å‘ç”Ÿï¼Œåœ¨ç³»ç»Ÿå±‚é¢å¯¹è¿™äº›æµæ°“è¡Œä¸ºåšå‡ºäº†é™åˆ¶ï¼š
`åå°è¿›ç¨‹å³ä½¿ä½ æ˜¯è¦é»‘ç§‘æŠ€è®©è¿›ç¨‹ä¼˜å…ˆçº§å¾ˆé«˜ï¼Œä¹Ÿå¯èƒ½è¢«æ€æ­»`ï¼Œæ‰€ä»¥æˆ‘å®æ„¿ç§°æ˜¯åº”ç”¨çš„`æ±‚ç”Ÿ`è€Œä¸æ˜¯`ä¿æ´»`ã€‚

è¿™ç§æ–¹å¼åˆè¡·æ˜¯å¥½çš„ï¼Œé™ä½äº†è®¾å¤‡åŠŸè€—ï¼Œé™ä½äº†å†…å­˜ï¼Œé˜²æ­¢æ‰‹æœºå‘çƒ«ç­‰ï¼Œä½†æ˜¯å¯¹äºä¸€äº›çœŸæ­£éœ€è¦åšä¿æ´»æ“ä½œçš„åº”ç”¨æ¥è¯´ï¼Œå¯è°“è‹¦ä¸å ªè¨€ã€‚

**äºæ˜¯ä¹æ–°å‹çš„`æ±‚ç”Ÿ`æªæ–½åˆå‡ºç°äº†ã€‚**

## å¦‚ä½•ä¼˜é›…çš„è¿›è¡Œæ±‚ç”Ÿ

Android`6.0`ä»¥åç³»ç»Ÿæ¨å‡ºäº†ä¸€ä¸ªç”µæ± ä¼˜åŒ–æ–¹æ¡ˆï¼Œå¯¹ä¸€äº›é«˜è€—ç”µçš„è¿›ç¨‹ä¼šè¿›è¡Œç­–ç•¥æ€æ­»ã€‚

**é‚£å¯èƒ½æœ‰äººè¦é—®äº†ï¼Œå¾®ä¿¡å’Œqqè¿™äº›é«˜è€—ç”µåº”ç”¨æ˜¯æ€ä¹ˆåšåˆ°ä¿å­˜çš„å‘¢ï¼Ÿ**

`çœ‹ä¸‹å›¾`

![å¾®ä¿¡qqç™½åå•.awebp](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e462c39ddda84100b431204f2eefb0c2~tplv-k3u1fbpfcp-watermark.image?)


å¯ä»¥çœ‹åˆ°ç³»ç»Ÿå°†å¾®ä¿¡å’Œqqéƒ½æ”¾åˆ°äº†ä»–ä»¬çš„`ç™½åå•`é‡Œé¢äº†ï¼Œè¿™ä¸ªæ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿ

å…¶å®ï¼Œ
è¿™ä¸ªæ˜¯å¾®ä¿¡å’Œå‚å•†åšäº†åå•†ï¼Œå°†ä»–ä»¬è‡ªå·±çš„åº”ç”¨è®¾ç½®åˆ°äº†ä»–ä»¬çš„ç”µé‡ä¼˜åŒ–ç™½åå•ä¸­ã€‚
ä¸‹æ¬¡äº§å“å†é—®æˆ‘ä¸ºå•¥ä»–ä»¬å¯ä»¥åšåˆ°çš„æ—¶å€™ï¼Œæˆ‘å°±æŠŠè¿™å¼ å›¾ç”©ç»™ä»–ä»¬ã€‚ã€‚

é‚£æˆ‘ä»¬å¯ä¸å¯ä»¥ä¹Ÿè®©å‚å•†ç»™æˆ‘ä»¬åŠ åå•å‘¢ï¼Ÿå‘ƒå‘ƒå‘ƒã€‚ã€‚

![å°ä¼™å­å¾ˆæœ‰æƒ³æ³•.webp](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/66698e17f4384cacbabcadf51b6172f0~tplv-k3u1fbpfcp-watermark.image?)

**å¥½åœ¨æ‰‹æœºå‚å•†æ²¡æœ‰æŠŠè·¯å µæ­»ï¼Œç»™æˆ‘ä»¬ç•™äº†ä¸€æ¡åè·¯**

- 1.é¦–å…ˆä½¿ç”¨ä¸‹é¢çš„ä»£ç æ£€æµ‹æˆ‘ä»¬è¿›ç¨‹æ˜¯å¦åœ¨ç™½åå•ä¸­ï¼š

```java
@RequiresApi(api = Build.VERSION_CODES.M)
private boolean isIgnoringBatteryOptimizations() {
    boolean isIgnoring = false;
    PowerManager powerManager = (PowerManager) getSystemService(Context.POWER_SERVICE);
    if (powerManager != null) {
        isIgnoring = powerManager.isIgnoringBatteryOptimizations(getPackageName());
    }
    return isIgnoring;
}
```


- 2.å¦‚æœæ²¡æœ‰ï¼šè°ƒç”¨ä¸‹é¢çš„ä»£ç ç”³è¯·åŠ å…¥ç™½åå•

```java
@RequiresApi(api = Build.VERSION_CODES.M)
public void requestIgnoreBatteryOptimizations() {
    try {
        Intent intent = new Intent(Settings.ACTION_REQUEST_IGNORE_BATTERY_OPTIMIZATIONS);
        intent.setData(Uri.parse("package:" + getPackageName()));
        startActivity(intent);
    } catch (Exception e) {
        e.printStackTrace();
    }
}
```

ç”³è¯·æ—¶ä¼šå¼¹å‡ºä¸€ä¸ªè®©ç”¨æˆ·é€‰æ‹©çš„Dialogï¼š

![ç”µæ± ä¼˜åŒ–é€‰é¡¹.awebp](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b35cf0cb5d1147c2bbe226b33208d61d~tplv-k3u1fbpfcp-watermark.image?)
	
	
çª—å£ä¸­ä¼šæç¤ºè¯¥æ“ä½œå¯èƒ½æ˜¯å½±å“ç”µæ± çš„ä½¿ç”¨ï¼Œå¦‚æœéœ€è¦ç›‘å¬ç”¨æˆ·çš„æŒ‰é”®ï¼Œå¯ä»¥ä½¿ç”¨`startActivityResult`åœ¨`onActivityResult`ä¸­ç›‘å¬

**å¥½äº†ï¼Œç™½åå•æ˜¯åŠ å¥½äº†ï¼Œé‚£æ˜¯ä¸æ˜¯å°±æ˜¯ä¸‡äº‹å¤§å‰äº†å‘¢ï¼Ÿ**

**æ‰‹æœºå‚å•†**ï¼šå“ªæœ‰é‚£ä¹ˆå®¹æ˜“ï¼Œå°±ç®—ä½ åŠ å…¥äº†ç”µé‡ä¼˜åŒ–ç™½åå•ï¼Œä½ è¦æ˜¯ä¸æŒ‰è§„çŸ©æ¥ï¼Œåœ¨åå°è¿è¡Œçš„è¿›ç¨‹è¿˜æ˜¯ä¼šè¢«æˆ‘ä»¬æ€æ‰ï¼Ÿè¿˜æœ‰å•¥æ‹›å¼å¿«å¿«ä½¿å‡ºæ¥å§


![æ”¾å¤§æ‹›äº†.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/19cc78351b9845d39d2d0f81a4619630~tplv-k3u1fbpfcp-watermark.image?)
eeeã€‚ã€‚

æˆ‘ä»¬çŸ¥é“è¿›ç¨‹è¢«æ€æ­»ï¼Œæ˜¯å› ä¸ºç³»ç»Ÿçš„åå°ç®¡ç†ç³»ç»ŸæŠŠæˆ‘ä»¬é‡å¯çš„è·¯å µä½äº†ï¼Œä¸ºå•¥å µæˆ‘å•Šï¼ŸæŒ‰æˆ‘è¯´å¯èƒ½ç³»ç»Ÿçœ‹ä½ è¿™ä¸ªè¿›ç¨‹ä¸é¡ºçœ¼å§ï¼Œå“ˆå“ˆã€‚ã€‚

**è¨€å½’æ­£ä¼ ï¼š**

å…¶å®æ˜¯ä½ ä¸åœ¨åå°ç®¡ç†çš„`è‡ªå¯åŠ¨ç™½åå•`ä¸­ï¼Œè‡ªå¯åŠ¨ç™½åå•å°±åƒä¸€å¼ `é€šè¡Œè¯`ï¼Œä½ çš„åº”ç”¨éœ€è¦åœ¨ç³»ç»Ÿåå°è‡ªå¯åŠ¨ï¼Œå°±è¦åœ¨ç™½åå•ä¸Šï¼Œå¦åˆ™å“ªé‡Œæ¥å›å“ªé‡Œå»å§

`é‚£ç™½åå•è¿™ä¹ˆå¥½ï¼Œæ€ä¹ˆæ‰èƒ½åŠ å…¥TMå‘¢ï¼Ÿ`

è¦çŸ¥é“å¸‚é¢ä¸Šæ‰‹æœºå‚å®¶å¾ˆå¤šï¼Œæ¯ä¸ªå‚å®¶çš„`ç³»ç»Ÿéƒ½ä¸ä¸€æ ·`ï¼Œä¸€ä¸ªç³»ç»Ÿè¿˜æœ‰å¾ˆå¤šç”šè‡³å‡ åä¸ª`ç‰ˆæœ¬`ï¼Œè¿™è®©æˆ‘ä»¬æ€ä¹ˆåŠ å…¥å•Šï¼Ÿ

è€Œå¤§éƒ¨åˆ†è‡ªå¯åŠ¨æ“ä½œå¯ä»¥åœ¨å‚å•†çš„`æ‰‹æœºç®¡å®¶`çš„è®¾ç½®é‡Œé¢è®¾ç½®ï¼š

`æœ€ç†æƒ³çš„åšæ³•`:**æˆ‘ä»¬æ ¹æ®ä¸åŒæ‰‹æœºï¼Œç”šè‡³æ˜¯ä¸åŒçš„ç³»ç»Ÿç‰ˆæœ¬ï¼Œç»™ç”¨æˆ·å‘ˆç°ä¸€ä¸ªå›¾æ–‡æ“ä½œæ­¥éª¤ï¼Œå¹¶ä¸”æä¾›ä¸€ä¸ªæŒ‰é’®ï¼Œç›´æ¥è·³è½¬åˆ°æŒ‡å®šé¡µé¢è¿›è¡Œè®¾ç½®**

- æˆ‘ä»¬å…ˆå®šä¹‰ä¸‹é¢ä¸¤ä¸ªæ–¹æ³•ï¼š

```java
/**
 * è·³è½¬åˆ°æŒ‡å®šåº”ç”¨çš„é¦–é¡µ
 */
private static void showActivity(Context context,@NonNull String packageName) {
	Intent intent = context.getPackageManager().getLaunchIntentForPackage(packageName);
	context.startActivity(intent);
}

/**
 * è·³è½¬åˆ°æŒ‡å®šåº”ç”¨çš„æŒ‡å®šé¡µé¢
 */
private void showActivity(Context context,@NonNull String packageName, @NonNull String activityDir) {
	Intent intent = new Intent();
	intent.setComponent(new ComponentName(packageName, activityDir));
	intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
	context.startActivity(intent);
}
```




- æ‰‹æœºå‚å•†åˆ¤æ–­ï¼š

```java
åä¸ºï¼š
public boolean isHuawei() {
    if (Build.BRAND == null) {
        return false;
    } else {
        return Build.BRAND.toLowerCase().equals("huawei") || Build.BRAND.toLowerCase().equals("honor");
    }
}
å°ç±³
public static boolean isXiaomi() {
    return Build.BRAND != null && Build.BRAND.toLowerCase().equals("xiaomi");
}
OPPO
public static boolean isOPPO() {
    return Build.BRAND != null && Build.BRAND.toLowerCase().equals("oppo");
}

VIVO
public static boolean isVIVO() {
    return Build.BRAND != null && Build.BRAND.toLowerCase().equals("vivo");
}
é­…æ—
public static boolean isMeizu() {
    return Build.BRAND != null && Build.BRAND.toLowerCase().equals("meizu");
}
ä¸‰æ˜Ÿ
public static boolean isSamsung() {
    return Build.BRAND != null && Build.BRAND.toLowerCase().equals("samsung");
}

```

- æ‰‹æœºç®¡å®¶æˆ–è€…è‡ªå¯åŠ¨ç•Œé¢å¯åŠ¨æ–¹å¼ï¼š

```java
åä¸ºï¼š
private void goHuaweiSetting() {
    try {
        showActivity("com.huawei.systemmanager",
            "com.huawei.systemmanager.startupmgr.ui.StartupNormalAppListActivity");
    } catch (Exception e) {
        showActivity("com.huawei.systemmanager",
            "com.huawei.systemmanager.optimize.bootstart.BootStartActivity");
    }
}
å°ç±³ï¼š

private void goXiaomiSetting() {
    showActivity("com.miui.securitycenter",
        "com.miui.permcenter.autostart.AutoStartManagementActivity");
}

OPPOï¼š
private void goOPPOSetting() {
    try {
        showActivity("com.coloros.phonemanager");
    } catch (Exception e1) {
        try {
            showActivity("com.oppo.safe");
        } catch (Exception e2) {
            try {
                showActivity("com.coloros.oppoguardelf");
            } catch (Exception e3) {
                showActivity("com.coloros.safecenter");
            }
        }
    }
}

VIVO
private void goVIVOSetting() {
    showActivity("com.iqoo.secure");
}

é­…æ—ï¼š
private void goMeizuSetting() {
    showActivity("com.meizu.safe");
}
ä¸‰æ˜Ÿï¼š
private void goSamsungSetting() {
    try {
        showActivity("com.samsung.android.sm_cn");
    } catch (Exception e) {
        showActivity("com.samsung.android.sm");
    }
}

```

**æ€»ç»“ä¸‹ä¸Šé¢æˆ‘ä»¬æ‰€è®²ï¼š**

> - 1.ä¸ºäº†ä¸è¢«ç”µé‡ä¼˜åŒ–ï¼Œæˆ‘ä»¬éœ€è¦å°†åº”ç”¨æ·»åŠ è¿›ç”µé‡ä¼˜åŒ–ç™½åå•ä¸­
> - 2.ä¸ºäº†å¯ä»¥åœ¨è¢«æ€æ­»åï¼Œè‡ªå·±å¯ä»¥å¯åŠ¨è‡ªå·±ï¼Œéœ€è¦å°†åº”ç”¨è‡ªå¯åŠ¨å¼€å…³å¼€å¯ï¼Œå¯ä»¥ä½¿
> ç”¨å›¾æ–‡å¼•å¯¼çš„æ–¹å¼ï¼š

å‚è€ƒä¸‹é¢è¿™å¼ å›¾ï¼š

![è‡ªå¯åŠ¨.awebp](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e3bb0aa0bf14401aa8a03c7d55bdcb81~tplv-k3u1fbpfcp-watermark.image?)


## ä¿æ´»å¢å¼ºï¼š
æˆ‘ä»¬éƒ½çŸ¥é“ä¿æ´»æ“ä½œä¸€èˆ¬æ˜¯ä½¿ç”¨ä¸€ä¸ª`å‰å°æœåŠ¡æ¥æŒ‚èµ·æˆ‘ä»¬çš„åº”ç”¨`ï¼š
è¿˜æœ‰çš„ä¿æ´»æ“ä½œæ˜¯ä½¿ç”¨ä¸€ä¸ª`JobService`æ¥å¯¹è®©ç³»ç»Ÿåœ¨æŸä¸ªæ¡ä»¶ç¬¦åˆä¸‹å›è°ƒä¸€ä¸ªè¯·æ±‚æ“ä½œã€‚

åŸºäºä»¥ä¸Šåˆ†æ:
- ç¬”è€…è¿™è¾¹å°è£…äº†ä¸€ä¸ªä¿æ´»ç»„ä»¶-`lib_pull_alive`ï¼š
ç»“åˆäº†ï¼š`å‰å°æœåŠ¡`+`JobService`+`ç”µé‡ä¼˜åŒ–ç™½åå•`+`å¼•å¯¼ç”¨æˆ·åº”ç”¨è‡ªå¯åŠ¨çš„æ–¹å¼`å®ç°äº†ä¸€ä¸ª`æ±‚ç”Ÿ`æ–¹æ¡ˆï¼Œä»£ç å¦‚ä¸‹ï¼š


```java
keepAliveService.java
package com.anna.lib_keepalive.service;

import android.app.job.JobInfo;
import android.app.job.JobParameters;
import android.app.job.JobScheduler;
import android.app.job.JobService;
import android.content.ComponentName;
import android.content.Context;
import android.content.Intent;
import android.os.Build;
import android.os.Handler;
import android.os.Message;
import android.util.Log;

import androidx.annotation.RequiresApi;

import com.anna.lib_keepalive.forground.ForgroundNF;
import com.anna.lib_keepalive.utils.Utils;

/**
 * åˆ›å»ºä¸€ä¸ªJobServiceç”¨äºæé«˜åº”ç”¨ä¼˜å…ˆçº§
 */
@RequiresApi(api = Build.VERSION_CODES.LOLLIPOP)
public class KeepAliveService extends JobService {
    private static final String TAG = KeepAliveService.class.getSimpleName();
    private JobScheduler mJobScheduler;
    private static final int JOB_ID = 1;
    private ComponentName JOB_PG;
    private int NOTIFICATION_ID = 10;
    private ForgroundNF mForgroundNF;


    private Handler mJobHandler = new Handler(new Handler.Callback() {

        @Override
        public boolean handleMessage(Message msg) {
            Log.d(TAG, "pull alive.");
            jobFinished((JobParameters) msg.obj, true);
            return true;
        }
    });
    @Override
    public void onCreate() {
        super.onCreate();
        mJobScheduler = (JobScheduler) getSystemService(Context.JOB_SCHEDULER_SERVICE);
        JOB_PG = new ComponentName(getPackageName(),KeepAliveService.class.getName());
        mForgroundNF = new ForgroundNF(this);
        Utils.requestIgnoreBatteryOptimizations(this);
    }
    @RequiresApi(api = Build.VERSION_CODES.LOLLIPOP)
    public static void start(Context context){
        Intent intent = new Intent(context,KeepAliveService.class);
        context.startService(intent);
    }

    @Override
    public boolean onStartJob(JobParameters params) {
        Log.d(TAG,"onStartJob");
        mJobHandler.sendMessage(Message.obtain(mJobHandler, 1, params));
        return true;
    }

    /**ç³»ç»Ÿå›è°ƒä½¿ç”¨ï¼Œè¯´æ˜è§¦å‘äº†jobæ¡ä»¶
     * @param params
     * @return
     */
    @Override
    public boolean onStopJob(JobParameters params) {
        Log.d(TAG,"onStopJob");
        mJobHandler.sendEmptyMessage(1);
        return false;
    }

    @Override
    public int onStartCommand(Intent intent, int flags, int startId) {
        JobInfo job = initJob();
        mJobScheduler.schedule(job);
        startNotificationForGround();
        return START_STICKY;
    }

    /**
     * å¤§äº18å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå–æ¶ˆNotificationçš„æœåŠ¡
     */
    private void startNotificationForGround(){
        if(Build.VERSION.SDK_INT<18){
            mForgroundNF.startForegroundNotification();
        }else{
            mForgroundNF.startForegroundNotification();
            Intent it = new Intent(this, CancelNotifyervice.class);
            startService(it);
        }
    }

    /**åˆå§‹åŒ–Jobä»»åŠ¡
     * @return
     */
    private JobInfo initJob() {
        JobInfo.Builder builder = new JobInfo.Builder(JOB_ID, JOB_PG);
        if(Build.VERSION.SDK_INT>=Build.VERSION_CODES.N){
            builder.setMinimumLatency(JobInfo.DEFAULT_INITIAL_BACKOFF_MILLIS); //æ‰§è¡Œçš„æœ€å°å»¶è¿Ÿæ—¶é—´
            builder.setOverrideDeadline(JobInfo.DEFAULT_INITIAL_BACKOFF_MILLIS);  //æ‰§è¡Œçš„æœ€é•¿å»¶æ—¶æ—¶é—´
            builder.setBackoffCriteria(JobInfo.DEFAULT_INITIAL_BACKOFF_MILLIS,
                    JobInfo.BACKOFF_POLICY_LINEAR);//çº¿æ€§é‡è¯•æ–¹æ¡ˆ
        }else {
            builder.setPeriodic(JobInfo.DEFAULT_INITIAL_BACKOFF_MILLIS);
        }
        builder.setPersisted(false);
        builder.setRequiredNetworkType(JobInfo.NETWORK_TYPE_NONE);
        builder.setRequiresCharging(false);
        return builder.build();
    }

    @Override
    public void onDestroy() {
        super.onDestroy();
        mForgroundNF.stopForegroundNotification();
    }

}

```

```java
ForgroundNF.java
package com.anna.lib_keepalive.forground;

import android.app.Notification;
import android.app.NotificationChannel;
import android.app.NotificationManager;
import android.app.Service;
import android.content.Context;
import android.os.Build;

import androidx.core.app.NotificationCompat;

import com.anna.lib_keepalive.R;

public class ForgroundNF {
    private static final int START_ID = 101;
    private static final String CHANNEL_ID = "app_foreground_service";
    private static final String CHANNEL_NAME = "å‰å°ä¿æ´»æœåŠ¡";

    private Service service;
    private NotificationManager notificationManager;
    private NotificationCompat.Builder mNotificationCompatBuilder;
    public ForgroundNF(Service service){
        this.service = service;
        initNotificationManager();
        initCompatBuilder();
    }


    /**
     * åˆå§‹åŒ–NotificationCompat.Builder
     */
    private void initCompatBuilder() {
        mNotificationCompatBuilder = new NotificationCompat.Builder(service,CHANNEL_ID);
        //æ ‡é¢˜
        mNotificationCompatBuilder.setContentTitle("test keep alive");
        //é€šçŸ¥å†…å®¹
        mNotificationCompatBuilder.setContentText("test alive");
        mNotificationCompatBuilder.setSmallIcon(R.mipmap.ic_launcher_round);
    }

    /**
     * åˆå§‹åŒ–notificationManagerå¹¶åˆ›å»ºNotificationChannel
     */
    private void initNotificationManager(){
        notificationManager = (NotificationManager) service.getSystemService(Context.NOTIFICATION_SERVICE);
        //é’ˆå¯¹8.0+ç³»ç»Ÿ
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
            NotificationChannel channel  = new NotificationChannel(CHANNEL_ID,CHANNEL_NAME,NotificationManager.IMPORTANCE_LOW);
            channel.setLockscreenVisibility(Notification.VISIBILITY_PUBLIC);
            channel.setShowBadge(false);
            notificationManager.createNotificationChannel(channel);
        }
    }

    public void startForegroundNotification(){
        service.startForeground(START_ID,mNotificationCompatBuilder.build());
    }

    public void stopForegroundNotification(){
        notificationManager.cancelAll();
        service.stopForeground(true);
    }

}

```

**å®Œæ•´ä»£ç å¯ä»¥æŸ¥çœ‹githubä¸Šçš„Demoï¼š**
https://github.com/ByteYuhb/anna_music_app

## æ€»ç»“ï¼š
æœ¬æ–‡æ˜¯ç»„ä»¶åŒ–å¼€å‘çš„ç¬¬å››ç¯‡ï¼Œä¹Ÿæ˜¯ç¬¬ä¸‰ä¸ªåŠŸèƒ½ç»„ä»¶çš„å°è£…ï¼Œéƒ½å·²ä¸Šä¼ åˆ°Githubï¼ŒåæœŸä¼šé™†ç»­æ¨èå…¶ä»–ç»„ä»¶çš„å°è£…ã€‚


![ç»„ä»¶åŒ–å¼€å‘.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d1c46c1fc2d94299b60a9504737559af~tplv-k3u1fbpfcp-watermark.image?)