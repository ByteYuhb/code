
> ğŸ”¥ **Hiï¼Œæˆ‘æ˜¯å°ä½™ã€‚**
>
> **æœ¬æ–‡å·²æ”¶å½•åˆ° [GitHub Â· Androider-Planet](https://github.com/ByteYuhb/Androider-Planet) ä¸­ã€‚è¿™é‡Œæœ‰ Android è¿›é˜¶æˆé•¿çŸ¥è¯†ä½“ç³»ï¼Œå…³æ³¨å…¬ä¼—å· [å°ä½™çš„è‡ªä¹ å®¤] ï¼Œåœ¨æˆåŠŸçš„è·¯ä¸Šä¸è¿·è·¯ï¼**
## å‰è¨€
å‰é¢å‡ ç¯‡ç³»åˆ—æ–‡ç« æˆ‘ä»¬è®²è§£äº†`ç»„ä»¶åŒ–å¼€å‘`ä¸­å‡ ä¸ªå¸¸ç”¨åŠŸèƒ½ç»„ä»¶çš„å¼€å‘ï¼ŒåŒ…æ‹¬ï¼š`ç½‘ç»œè¯·æ±‚ç»„ä»¶`ï¼Œ`å›¾ç‰‡åŠ è½½è¯·æ±‚ç»„ä»¶`ï¼Œ`åº”ç”¨ä¿æ´»ç»„ä»¶`ã€‚ä»Šå¤©æˆ‘ä»¬æ¥å°è£…ä¸€ä¸ª`éŸ³ä¹æ’­æ”¾ç»„ä»¶`ã€‚

**ç»„ä»¶åŒ–ç›¸å…³ç³»åˆ—æ–‡ç« ï¼š**

 [Androidç»„ä»¶åŒ–å¼€å‘ï¼ˆä¸€ï¼‰--Mavenç§æœçš„æ­å»º](https://juejin.cn/post/7118646272323485709)

[ Androidç»„ä»¶åŒ–å¼€å‘ï¼ˆäºŒï¼‰--ç½‘ç»œè¯·æ±‚ç»„ä»¶å°è£…](https://juejin.cn/post/7119281692350611493)

[Androidç»„ä»¶åŒ–å¼€å‘ï¼ˆä¸‰ï¼‰--å›¾ç‰‡åŠ è½½ç»„ä»¶å°è£…](https://juejin.cn/post/7120791098775044103)

[Androidç»„ä»¶åŒ–å¼€å‘ï¼ˆå››ï¼‰--è¿›ç¨‹ä¿æ´»ç»„ä»¶çš„å°è£…](https://juejin.cn/post/7121643256495996936)


![ç»„ä»¶åŒ–å¼€å‘.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/049e14f881e942aabcc4201c2062d195~tplv-k3u1fbpfcp-watermark.image?)

è¿˜è®°å¾—å¼€å§‹å†™è¿™ä¸ªç³»åˆ—æ—¶å€™è¯´è¿‡ï¼Œæˆ‘ä»¬è¿™ä¸ªç»„ä»¶åŒ–ç³»åˆ—ä¼šä»¥ä¸€ä¸ª`å®æˆ˜`é¡¹ç›®å±•å¼€ï¼Œé‚£è¿™ä¸ªé¡¹ç›®å°±æ˜¯ä¸€ä¸ª`éŸ³ä¹æ’­æ”¾å™¨`ï¼Œæš‚ä¸”å«ä»–`xxäº‘éŸ³ä¹`å§



åœ¨å†™è¿™ç¯‡æ–‡ç« ä¹‹å‰ï¼Œæˆ‘åœ¨ç½‘ä¸ŠæŸ¥æ‰¾äº†ä¸€äº›ç±»ä¼¼æ–‡ç« ï¼Œå‘ç°å¾ˆå¤šè¦ä¹ˆæ˜¯ç›´æ¥è´´ä»£ç ï¼Œè¦ä¹ˆå°±æ˜¯è®²è§£äº†ä¸€äº›æ€è·¯ï¼Œå¹¶æ²¡æœ‰ç»™å‡ºå¤ªå¤šå…·ä½“çš„ä»£ç ï¼Œçœ‹äº†ä¹‹åå¾ˆå®¹æ˜“å°±å¿˜äº†ã€‚ä»Šå¤©ç¬”è€…ä½¿ç”¨æ¶æ„æ€ç»´å’Œå…·ä½“ä»£ç ç»“åˆçš„æ–¹å¼å¸¦å¤§å®¶æ¥çœ‹ä¸‹ç¬”è€…æ˜¯å¦‚ä½•å»å°è£…ä¸€ä¸ªéŸ³ä¹æ’­æ”¾ç»„ä»¶çš„ã€‚

é‚£æˆ‘ä»¬å°±å¼€å§‹å§ã€‚

çœ‹è¿‡æˆ‘ä¹‹å‰æ–‡ç« éƒ½çŸ¥é“ï¼Œç¬”è€…å¾ˆæ³¨é‡`éœ€æ±‚çš„åˆ†æ`ã€‚

> ä¸€åˆ‡ä»£ç çš„å¼€å‘éƒ½åŸè‡ªéœ€æ±‚ï¼Œåšå¥½éœ€æ±‚åˆ†æç›´è§‚é‡è¦ã€‚

## éœ€æ±‚åˆ†æï¼š
å¾€å¤§äº†è®²ï¼š
- 1.å°è£…ä¸€ä¸ªéŸ³ä¹æ’­æ”¾ç»„ä»¶ï¼š

å¾€ç»†äº†è®²ï¼š

    - 1.åŸºç¡€åŠŸèƒ½ï¼šæ’­æ”¾ï¼Œæš‚åœï¼Œä¸‹ä¸€é¦–ï¼Œä¸Šä¸€é¦–
    - 2.æ’­æ”¾æ¨¡å¼ï¼šå•æ›²å¾ªç¯ï¼Œé¡ºåºæ’­æ”¾ï¼Œéšæœºæ’­æ”¾
    - 3.ç”¨æˆ·ç™»å½•ï¼Œæ”¶è—ç­‰
    - 4.å†æ‰©å±•ä¸€ç‚¹ï¼Œå¼€å‘ä¸€ä¸ªç±»ä¼¼æœ‹å‹åœˆçš„åŠŸèƒ½ã€‚ã€‚ã€‚èµ°è¿œäº†å“ˆ

æœ‰äº†ä¸Šé¢çš„éœ€æ±‚åˆ†æï¼Œæˆ‘ä»¬å°±æœ‰äº†ä¸€ä¸ªåˆ‡å…¥ç‚¹ã€‚
## æŠ€æœ¯é€‰å‹
è¦å®ç°ä¸Šé¢éœ€æ±‚ï¼š

> ç¬”è€…å¯ä»¥æƒ³åˆ°çš„æ˜¯ä½¿ç”¨ä¸€ä¸ª`MediaPlayer`æ¥å®ç°æˆ‘ä»¬çš„éœ€æ±‚

å¦‚æœå¯¹`MediaPlayer`è¿˜ä¸æ˜¯å¾ˆäº†è§£çš„ï¼Œè¯·è½¬åˆ°å®˜ç½‘æŸ¥çœ‹ï¼š
https://developer.android.google.cn/guide/topics/media/mediaplayer?hl=zh_cn

å¼•ç”¨å®˜ç½‘çš„è¯ï¼š
> `MediaPlayer` ç±»æ˜¯åª’ä½“æ¡†æ¶æœ€é‡è¦çš„ç»„æˆéƒ¨åˆ†ä¹‹ä¸€ã€‚æ­¤ç±»çš„å¯¹è±¡èƒ½å¤Ÿè·å–ã€è§£ç ä»¥åŠæ’­æ”¾éŸ³é¢‘å’Œè§†é¢‘ï¼Œè€Œä¸”åªéœ€æå°‘é‡è®¾ç½®ã€‚å®ƒæ”¯æŒå¤šç§ä¸åŒçš„åª’ä½“æºï¼Œä¾‹å¦‚ï¼š
>
> -   æœ¬åœ°èµ„æº
> -   å†…éƒ¨ URIï¼Œä¾‹å¦‚æ‚¨å¯èƒ½ä»å†…å®¹è§£æå™¨é‚£è·å–çš„ URI
> -   å¤–éƒ¨ç½‘å€ï¼ˆæµå¼ä¼ è¾“ï¼‰

`MediaPlayer`æœ€é‡è¦çš„æ˜¯ï¼š

ä»–å†…éƒ¨ç»´æŠ¤äº†ä¸€å¥—éŸ³ä¹æ’­æ”¾`çŠ¶æ€æœº`ï¼Œ**æ¯ä¸ªæ­¥éª¤éƒ½éœ€è¦æ ¹æ®ä¸Šä¸€ä¸ªçŠ¶æ€æ¥åšæ”¹å˜**ï¼Œå¦‚æœåœ¨æŸä¸ªçŠ¶æ€æ‰§è¡Œäº†é”™è¯¯çš„æ­¥éª¤å°±ä¼šå‡ºå¼‚å¸¸ç”šè‡³å´©æºƒï¼Œä½ å¯èƒ½ä¸æƒ³çœ‹åˆ°è¿™ç§äº‹ä»¶å‘ç”Ÿåœ¨ä½ çš„appä¸­å§ã€‚ã€‚
æ‰€ä»¥æ¥ä¸‹æ¥ä½ ä¼šåœ¨æˆ‘çš„ä»£ç ä¸­çœ‹åˆ°å¾ˆå¤šå…³äºçŠ¶æ€çš„åˆ¤æ–­ã€‚

`MediaPlayer`**æ’­æ”¾çŠ¶æ€åˆ‡æ¢å›¾**ï¼š

![éŸ³ä¹æ’­æ”¾çŠ¶æ€æœº.awebp](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cca4804d272d4701908eda69b688d646~tplv-k3u1fbpfcp-watermark.image?)


å¯ä»¥çœ‹åˆ°å†…éƒ¨è°ƒç”¨è¿‡ç¨‹è¿˜æ˜¯æŒºå¤æ‚çš„ã€‚å¥½åœ¨è¿™äº›éƒ½æ˜¯MediaPlayerè‡ªå·±å†…éƒ¨ç»´æŠ¤ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸éœ€è¦äººä¸ºå»å¤„ç†ã€‚

å¥½äº†ï¼Œæœ‰äº†å‰é¢çš„çŸ¥è¯†é“ºå«æˆ‘ä»¬å°±**æ­£å¼å¼€å§‹å°è£…å•¦**ã€‚

## å°è£…

è¿™é‡Œå…ˆæ”¾ä¸€å¼ ç¬”è€…è®¾è®¡çš„ä¸€ä¸ªUMLç±»å›¾ï¼š
![éŸ³ä¹æ’­æ”¾ç»„ä»¶.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b0f68827018844eb9c76776285c2e329~tplv-k3u1fbpfcp-watermark.image?)

- `CustomMediaPlayer`:

è¿™ä¸ªç±»ç»§æ‰¿`MediaPlayer`ï¼Œå†…éƒ¨ä¸»è¦ç»´æŠ¤äº†`MediaPlayer`çš„å„ä¸ªé˜¶æ®µçŠ¶æ€ï¼Œ`MediaPlayer`å†…éƒ¨ä¹Ÿç»´æŠ¤äº†ä¸€ä¸ªçŠ¶æ€å€¼ï¼Œä½†æ˜¯ä½¿ç”¨èµ·æ¥ä¸å¤Ÿæ–¹ä¾¿å’Œä¼˜é›…ï¼Œè¿˜æ˜¯è‡ªå·±æŒæ§æ¯”è¾ƒæ–¹ä¾¿å¥½ç”¨ã€‚

- `AudioPlayer`ï¼š

è¿™ä¸ªç±»ä¸»è¦ä½œç”¨æ˜¯å¯¹å¤–æä¾›ä¸€äº›åŸºç¡€åŠŸèƒ½ï¼šå¦‚å¯¹ä¼ å…¥çš„éŸ³ä¹è¿›è¡ŒåŒæ­¥æˆ–è€…å¼‚æ­¥åŠ è½½ï¼Œå¯¹éŸ³ä¹è¿›è¡Œæš‚åœï¼Œæ¢å¤ç­‰æ“ä½œã€‚å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª`CustomMediaPlayer`å¯¹è±¡ï¼Œæ‰€ä»¥æ“ä½œéƒ½æ˜¯ä½¿ç”¨è¿™ä¸ª`CustomMediaPlayer`æ¥å®ç°çš„.è¿™ä¸ªç±»è¿˜ä¼šå¯¹`MediaPlayer`çš„çŠ¶æ€å¯¹å¤–å‘å¸ƒï¼Œè®©å¤–éƒ¨åšå‡ºå¯¹åº”çš„å¤„ç†ã€‚
- `AudioController`ï¼š

ä¸€ä¸ª`å•ä¾‹ç±»`ï¼Œè¿™ä¸ªç±»å¾ˆå…³é”®ï¼Œæ˜¯æ•´ä¸ªå°è£…åº“çš„æ ¸å¿ƒï¼Œåšåˆ°æ‰¿ä¸Šå¯ä¸‹çš„ä½œç”¨ï¼Œ
æ‰¿ä¸Šï¼šç®¡ç†éŸ³ä¹æ’­æ”¾æ­Œæ›²åˆ—è¡¨`Queue`å’Œæ’­æ”¾æ¨¡å¼`PlayModel`
å¯ä¸‹ï¼šå†…éƒ¨ç»´æŠ¤ä¸€ä¸ª`AudioPlayer`çš„å¯¹è±¡ï¼Œä½¿ç”¨`AudioPlayer`æä¾›çš„æ–¹æ³•ï¼Œåšåˆ°å¯¹éŸ³ä¹åˆ—è¡¨çš„æ’­æ”¾ï¼Œæš‚åœï¼Œæ¢å¤ç­‰æ“ä½œä¹Ÿå¯¹å¤–å‘å¸ƒä¸€äº›äº‹ä»¶ï¼Œå¦‚æ’­æ”¾æ¨¡å¼çš„æ”¹å˜ç­‰ï¼Œéœ€è¦å¤–éƒ¨UIåšå‡ºä¸€äº›ååº”ã€‚
- `MusicPlayerService`ï¼š

è¿™æ˜¯ä¸€ä¸ªæ’­æ”¾éŸ³ä¹ç”¨çš„`Service`ï¼Œå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª`AudioProvider.stub`çš„`binder`é€šè®¯ä½¿ç”¨çš„ç±»ï¼šå¯¹å¤–æä¾›é€šè®¯æ¥å£ï¼šå¦‚è®¾ç½®æ’­æ”¾é˜Ÿåˆ—ï¼Œæš‚åœä»¥åŠæ¢å¤ç­‰æ“ä½œã€‚è¿™ä¸ªæŒ‚æ¥äº†ä¸€ä¸ªæ’­æ”¾å™¨çš„`Notification`ï¼Œå¯ä»¥è®©æœåŠ¡å˜ä¸ºå‰å°æœåŠ¡ï¼Œè¿›ä¸€æ­¥å¢åŠ åº”ç”¨çš„ä¿æ´»èƒ½åŠ›ã€‚
- `NotificationHelper`:

è¿™ä¸ªæ˜¯ä¸€ä¸ª`Notification`çš„è¾…åŠ©ç±»ï¼Œç”¨äºåœ¨é€šçŸ¥æ æ˜¾ç¤ºæˆ‘ä»¬çš„éŸ³ä¹æ’­æ”¾äº‹ä»¶ã€‚
- `GreenDaoHelper`:

è¿™ä¸ªç±»ç”¨æ¥å¤„ç†å¯¹`æ”¶è—`çš„æ­Œæ›²ç²¾é€‰æŒä¹…åŒ–
- `AudioBean`:

è¿™ä¸ªç±»æ˜¯è´¯å½»æ•´ä¸ªæ’­æ”¾ä½“ç³»çš„`æ­Œæ›²ä¿¡æ¯å°è£…ç±»`ã€‚

> æ•´ä¸ªä½“ç³»ä¸»è¦å°±æ˜¯ç”±è¿™å‡ ä¸ªç±»æ’‘èµ·æ¥çš„ï¼Œæ¯ä¸ªç±»ä»ä¸‹å¾€ä¸Šéƒ½æœ‰ä¸åŒèŒè´£ï¼Œç›¸è¾…ç›¸æˆã€‚

**ç»è¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬å¤§æ¦‚äº†è§£äº†æœ¬æ¬¡å°è£…çš„ä¸€ä¸ªä½“ç³»æ¶æ„ï¼š**

> ä¸‹é¢å¯¹å…·ä½“ä»£ç æ¥è®²è§£ï¼š

ç¬”è€…åœ¨ä»£ç ä¸­å·²ç»ç»™å‡ºäº†å¾ˆå¤šéå¸¸è¯¦ç»†çš„æ³¨è§£ï¼Œæ–¹ä¾¿å¤§å®¶æŸ¥çœ‹ï¼š

- **CustomMediaPlayer.java**

```java
/**
 * è¿™ä¸ªç±»ä¸»è¦æ˜¯æä¾›MediaPlayerçš„å„ç§çŠ¶æ€ï¼Œå†…éƒ¨å›è°ƒ
 */
public class CustomMediaPlayer extends MediaPlayer implements MediaPlayer.OnCompletionListener,
        MediaPlayer.OnPreparedListener, MediaPlayer.OnErrorListener {
    //ä½¿ç”¨æšä¸¾ç±»è¡¨ç¤ºå½“å‰æ’­æ”¾å™¨çš„å„ç§çŠ¶æ€
    public enum Status{
        IDLE, INITIALIZED, PREPARED,STARTED, PAUSED, STOPPED, COMPLETED
    }

    //å½“å‰æ’­æ”¾å™¨çŠ¶æ€
    private Status mStatus;

    public CustomMediaPlayer(){
        super();
        //é»˜è®¤çŠ¶æ€ IDLE
        mStatus = Status.IDLE;
        //è®¾ç½®æ’­æ”¾å®Œæ¯•åçš„å›è°ƒ
        setOnCompletionListener(this);
        //è®¾ç½®æ•°æ®å‡†å¤‡å®Œæ¯•ï¼Œå‡†å¤‡æ’­æ”¾çš„å›è°ƒ
        setOnPreparedListener(this);
        //è®¾ç½®å‘ç”Ÿé”™è¯¯äº‹ä»¶çš„å›è°ƒ
        setOnErrorListener(this);
    }

    //è®¾ç½®æ’­æ”¾å®Œæ¯•åçš„å›è°ƒ
    @Override
    public void onCompletion(MediaPlayer mp) {
        mStatus = Status.COMPLETED;
        listener.omCompleted();
    }

    //æ’­æ”¾å™¨é‡ç½®ï¼šçŠ¶æ€è®¾ç½®ä¸ºIDLE
    @Override
    public void reset() {
        super.reset();
        mStatus = Status.IDLE;
    }

    //è®¾ç½®æ•°æ®å…ƒçš„å›è°ƒï¼šçŠ¶æ€è®¾ç½®ä¸ºï¼šINITIALIZED
    @Override
    public void setDataSource(String path) throws IOException, IllegalArgumentException, IllegalStateException, SecurityException {
        super.setDataSource(path);
        mStatus = Status.INITIALIZED;
    }

    //æ•°æ®å‡†å¤‡å®Œæ¯•åï¼Œå¼€å§‹æ’­æ”¾å‰çš„çŠ¶æ€ï¼šPREPARED
    @Override
    public void onPrepared(MediaPlayer mp) {
        mStatus = Status.PREPARED;
        listener.onPrepared();
    }

    //å‘é€é”™è¯¯äº‹ä»¶çš„å›è°ƒï¼Œè¿”å›trueè¡¨ç¤ºæ¶ˆè´¹æ‰äº‹ä»¶ï¼Œå¦‚æœä¸ºfalseåˆ™è¿˜ä¼šå›è°ƒonCompleteæ¥å£å›è°ƒ
    @Override
    public boolean onError(MediaPlayer mp, int what, int extra) {
        listener.onError();
        return true;
    }

    //å¼€å§‹æ’­æ”¾çŠ¶æ€
    @Override
    public void start() throws IllegalStateException {
        super.start();
        mStatus = Status.STARTED;
    }

    //åœæ­¢æ’­æ”¾çŠ¶æ€
    @Override
    public void stop() throws IllegalStateException {
        super.stop();
        mStatus = Status.STOPPED;
    }

    //æš‚åœçŠ¶æ€
    @Override
    public void pause() throws IllegalStateException {
        super.pause();
        mStatus = Status.PAUSED;
    }

    public void setmStatus(Status mStatus) {
        this.mStatus = mStatus;
    }

    public Status getmStatus() {
        return mStatus;
    }

    private MediaPlayerListener listener;

    public void setListener(MediaPlayerListener listener) {
        this.listener = listener;
    }

    /**
     * è¿™ä¸ªListenerç”¨é€”AudioPlayerçš„äº‹ä»¶å›è°ƒ
     */
    public interface MediaPlayerListener{
        void onPrepared();
        void omCompleted();
        void onError();
    }
}
```

çœ‹ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œè¿™ä¸ªç±»åªæ˜¯ç»™MediaPlayerè®¾ç½®äº†ä¸€äº›ä¾›å›è°ƒçš„æ¥å£ï¼Œä¸”ç»´æŠ¤äº†å½“å‰MediaPlayerçš„æ’­æ”¾çŠ¶æ€ã€‚


- **AudioPlayer.java**

```
/**
 *æ’­æ”¾å™¨äº‹ä»¶æº
 */
public class AudioPlayer implements CustomMediaPlayer.MediaPlayerListener {
    private CustomMediaPlayer mMediaPlayer;
    private WifiManager.WifiLock mWifiLock;
    private static final String TAG = "AudioPlayer";
    private static final int TIME_MSG = 0x01;
    private static final int TIME_INVAL = 100;
    //æ˜¯å¦æ˜¯å› ä¸ºç³»ç»Ÿå¼•èµ·çš„ç„¦ç‚¹é—®é¢˜
    private boolean isPausedByFocusLossTransient;
    //éŸ³é¢‘ç„¦ç‚¹ç›‘å¬å™¨
    private AudioFocusManager mAudioFocusManager;

    public AudioPlayer() {
        isPausedByFocusLossTransient = false;
        mMediaPlayer = new CustomMediaPlayer();
        init();
    }

    /**
     * åˆå§‹åŒ–mMediaPlayerçš„äº‹ä»¶ï¼Œå¦‚ï¼šä½¿ç”¨å”¤é†’é”ï¼Œè®¾ç½®éŸ³é¢‘æ ¼å¼ï¼Œè®¾ç½®wifilockï¼Œè®¾ç½®mAudioFocusManager
     *
     */
    private void init() {
        //ä½¿ç”¨å”¤é†’é”
        mMediaPlayer.setWakeMode(AudioHelper.getmContext(), PowerManager.PARTIAL_WAKE_LOCK);
        //è®¾ç½®éŸ³é¢‘æ ¼å¼
        mMediaPlayer.setAudioStreamType(AudioManager.STREAM_MUSIC);
        //è®¾ç½®æ•°æ®å‡†å¤‡å®Œæ¯•å›è°ƒ
        mMediaPlayer.setListener(this);
        //è®¾ç½®wifilockï¼Œå¯ä»¥è®©åœ¨åå°ä¹Ÿå¯ä»¥è¿è¡Œwifiä¸‹è½½åŠ è½½æ•°æ®
        mWifiLock = ((WifiManager) AudioHelper.getmContext()
                .getApplicationContext()
                .getSystemService(Context.WIFI_SERVICE)).createWifiLock(WifiManager.WIFI_MODE_FULL, "AudioPlayer");
        //è®¾ç½®Audioç®¡ç†å›è°ƒå™¨ï¼Œåœ¨ä¸€äº›åœºæ™¯ä¸‹ä¼šå›è°ƒï¼Œå¦‚ä¸­é€”é‡åˆ°æ‰“ç”µè¯ï¼Œå…¶ä»–åº”ç”¨å ç”¨éŸ³é¢‘ç«¯å£
        mAudioFocusManager = new AudioFocusManager(AudioHelper.getmContext(),audioFocusListener);
    }

    //æ’­æ”¾è¿›åº¦æ›´æ–°handler
    private Handler mHandler = new Handler(Looper.getMainLooper()) {
        @Override public void handleMessage(Message msg) {
            switch (msg.what) {
                case TIME_MSG:
                    //æš‚åœä¹Ÿè¦æ›´æ–°è¿›åº¦ï¼Œé˜²æ­¢UIä¸åŒæ­¥ï¼Œåªä¸è¿‡è¿›åº¦ä¸€ç›´ä¸€æ ·
                    if (getStatus() == CustomMediaPlayer.Status.STARTED
                            || getStatus() == CustomMediaPlayer.Status.PAUSED) {
                        //UIç±»å‹å¤„ç†äº‹ä»¶
                        EventBus.getDefault()
                                .post(new AudioProgressEvent(getStatus(), getCurrentPosition(), getDuration()));
                        sendEmptyMessageDelayed(TIME_MSG, TIME_INVAL);
                    }
                    break;
            }
        }
    };

    AudioFocusManager.AudioFocusListener audioFocusListener = new AudioFocusManager.AudioFocusListener() {
        // é‡æ–°è·å¾—ç„¦ç‚¹
        @Override
        public void audioFocusGrant() {
            setVolumn(1.0f,1.0f);
            if(isPausedByFocusLossTransient){
                resume();
            }
            isPausedByFocusLossTransient = false;
        }

        // æ°¸ä¹…ä¸¢å¤±ç„¦ç‚¹ï¼Œå¦‚è¢«å…¶ä»–æ’­æ”¾å™¨æŠ¢å 
        @Override
        public void audioFocusLoss() {
            if(mMediaPlayer != null) {
                pause();
            }
            isPausedByFocusLossTransient = true;
        }
        // çŸ­æš‚ä¸¢å¤±ç„¦ç‚¹ï¼Œå¦‚æ¥ç”µ
        @Override
        public void audioFocusLossTransient() {
            if (mMediaPlayer != null) pause();
            isPausedByFocusLossTransient = true;
        }
        // ç¬é—´ä¸¢å¤±ç„¦ç‚¹ï¼Œå¦‚é€šçŸ¥
        @Override
        public void audioFocusLossDuck() {
            //ç¬é—´å¤±å»ç„¦ç‚¹,
            setVolumn(0.5f, 0.5f);
        }
    };

    /**
     * å¼€å§‹å¯åŠ¨æ’­æ”¾éŸ³ä¹,ç”±å¼‚æ­¥onPreparedå›è°ƒè°ƒç”¨
     */
    private void start(){
        mMediaPlayer.setmStatus(CustomMediaPlayer.Status.PREPARED);
        mMediaPlayer.start();
        // å¯ç”¨wifié”
        mWifiLock.acquire();
        //æ›´æ–°è¿›åº¦
        mHandler.sendEmptyMessage(TIME_MSG);
        //å‘é€startäº‹ä»¶ï¼ŒUIç±»å‹å¤„ç†äº‹ä»¶
        EventBus.getDefault().post(new AudioStartEvent());
    }

    /**
     * å¯¹å¤–æä¾›çš„åŠ è½½éŸ³é¢‘çš„æ–¹æ³•
     */
    public void load(AudioBean audioBean) {
        try {
            mMediaPlayer.reset();
            mMediaPlayer.setDataSource(audioBean.mUrl);
            mMediaPlayer.prepareAsync();
            //å‘é€åŠ è½½éŸ³é¢‘äº‹ä»¶ï¼ŒUIç±»å‹å¤„ç†äº‹ä»¶
            EventBus.getDefault().post(new AudioLoadEvent(audioBean));
        } catch (IOException e) {
            e.printStackTrace();
            EventBus.getDefault().post(new AudioErrorEvent());
        }
    }
    /**
     * å¯¹å¤–æä¾›çš„æ’­æ”¾æ–¹æ³•
     */
    public void resume() {
        if(getStatus() == CustomMediaPlayer.Status.PAUSED){
            start();
        }
    }
    /**
     * å¯¹å¤–æš´éœ²pauseæ–¹æ³•
     */
    public void pause() {
        if (getStatus() == CustomMediaPlayer.Status.STARTED) {
            mMediaPlayer.pause();
            //å…³æ³¨wifié”
            if(mWifiLock.isHeld()){
                mWifiLock.release();
            }
            // å–æ¶ˆéŸ³é¢‘ç„¦ç‚¹
            if (mAudioFocusManager != null) {
                mAudioFocusManager.abandonAudioFocus();
            }
            //å‘é€æš‚åœäº‹ä»¶,UIç±»å‹äº‹ä»¶
            EventBus.getDefault().post(new AudioPauseEvent());
        }
    }
    /**
     * é”€æ¯å”¯ä¸€mediaplayerå®ä¾‹,åªæœ‰åœ¨é€€å‡ºappæ—¶ä½¿ç”¨
     */
    public void release() {
        if(mMediaPlayer == null){
            return;
        }
        mMediaPlayer.release();
        mMediaPlayer = null;
        // å…³é—­wifié”
        if (mWifiLock.isHeld()) {
            mWifiLock.release();
        }
        mWifiLock = null;
        // å–æ¶ˆéŸ³é¢‘ç„¦ç‚¹
        if (mAudioFocusManager != null) {
            mAudioFocusManager.abandonAudioFocus();
        }
        mAudioFocusManager = null;
        //å‘é€é”€æ¯æ’­æ”¾å™¨äº‹ä»¶,æ¸…é™¤é€šçŸ¥ç­‰
        EventBus.getDefault().post(new AudioReleaseEvent());
    }

    /**è·å–å½“å‰çŠ¶æ€
     * @return
     */
    public CustomMediaPlayer.Status getStatus(){
        return mMediaPlayer.getmStatus();
    }

    /**
     * æ•°æ®å…ƒå‡†å¤‡å®Œæ¯•çš„å›è°ƒï¼Œå¯ä»¥ç›´æ¥å¯åŠ¨startå¼€å§‹æ’­æ”¾
     */
    @Override
    public void onPrepared() {
        start();
    }

    /**
     * æ’­æ”¾å®Œæˆäº‹ä»¶
     */
    @Override
    public void omCompleted() {
        //å‘é€æ’­æ”¾å®Œæˆäº‹ä»¶,é€»è¾‘ç±»å‹äº‹ä»¶
        EventBus.getDefault().post(new AudioCompleteEvent());
    }

    @Override
    public void onError() {
        //å‘é€å½“æ¬¡æ’­æ”¾å®è´¥äº‹ä»¶,é€»è¾‘ç±»å‹äº‹ä»¶
        EventBus.getDefault().post(new AudioErrorEvent());
    }

    /**
     * è·å–å½“å‰éŸ³ä¹æ€»æ—¶é•¿,æ›´æ–°è¿›åº¦ç”¨
     */
    public int getDuration() {
        if (getStatus() == CustomMediaPlayer.Status.STARTED
                || getStatus() == CustomMediaPlayer.Status.PAUSED) {
            return mMediaPlayer.getDuration();
        }
        return 0;
    }

    /**å‘¼æ°”å½“å‰çš„æ’­æ”¾è¿›åº¦
     * @return
     */
    public int getCurrentPosition() {
        if (getStatus() == CustomMediaPlayer.Status.STARTED
                || getStatus() == CustomMediaPlayer.Status.PAUSED) {
            return mMediaPlayer.getCurrentPosition();
        }
        return 0;
    }

    /**è®¾ç½®éŸ³é‡ï¼Œ
     * @param left å·¦å£°é“ 0-1.0f
     * @param right å³å£°é“ 0-1.0f
     */
    public void setVolumn(float left, float right) {
        if (mMediaPlayer != null) mMediaPlayer.setVolume(left, right);
    }
}
```
è¿™ä¸ªç±»å†…éƒ¨åšçš„äº‹æƒ…å°±æ¯”è¾ƒå¤šäº†ï¼š

- 1.ç›‘å¬`MediaPlayer`å½“å‰çŠ¶æ€
     å¦‚æœæ˜¯`prepare`çŠ¶æ€ï¼šåˆ™å¯åŠ¨å†…éƒ¨çš„`start`æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æˆ‘å°†å…¶è®¾ç½®ä¸ºäº†`private`ï¼Œè¯´æ˜æ˜¯ä¸€ä¸ªå†…éƒ¨æ–¹æ³•ã€‚
      ç›‘å¬å½“å‰æ’­æ”¾ä½ç½®ï¼Œå¹¶å›è°ƒç»™ä¸šåŠ¡å±‚ã€‚

- 2.å¯¹å¤–æä¾›ï¼š`loadï¼Œpauseï¼Œresumeï¼ŒgetCurrentPosition`è·å–å½“å‰æ’­æ”¾ä½ç½®ç­‰æ¥å£ã€‚

è¿™äº›æ–¹æ³•ä¼šå¯¹æˆ‘ä»¬å½“å‰æ’­æ”¾å™¨çŠ¶æ€åšåˆ¤æ–­ï¼š
å¦‚è°ƒç”¨pauseï¼Œä¸€å®šè¦å½“å‰çŠ¶æ€æ˜¯startçŠ¶æ€
è°ƒç”¨resumeï¼Œä¸€å®šè¦å½“å‰çŠ¶æ€æ˜¯pauseç­‰ã€‚
è¿™äº›çŠ¶æ€éƒ½æ˜¯MediaPlayerç»Ÿä¸€ç®¡ç†çš„ï¼Œä¸èƒ½ä¹±è®¾ç½®ã€‚

- 3.ä½¿ç”¨`EventBus`å¯¹å¤–å‘é€ä¸€äº›å†…éƒ¨çŠ¶æ€äº‹ä»¶ï¼š
åŒ…æ‹¬ï¼š`AudioLoadEvent AudioErrorEvent AudioPauseEvent AudioCompleted`ç­‰äº‹ä»¶
å¤–éƒ¨å¯ä»¥åœ¨éœ€è¦çš„åœ°æ–¹æ³¨å†Œè¿™äº›`Event`

- 4.ç›‘å¬æ’­æ”¾å™¨`ç„¦ç‚¹äº‹ä»¶`ï¼šå¦‚æœ‰ç”µè¯æ¥ï¼Œé€šçŸ¥æˆ–è€…å…¶ä»–è·å–ç„¦ç‚¹çš„äº‹ä»¶ï¼Œ
  è¿™äº›äº‹ä»¶å¦‚ä½•å¤„ç†ï¼Ÿ
    1.é‡æ–°è·å¾—ç„¦ç‚¹ï¼šåˆ™åˆ¤æ–­æ˜¯ä¸æ˜¯ç³»ç»Ÿè¡Œä¸ºçš„ç„¦ç‚¹äº‹ä»¶ï¼šå¦‚æœæ˜¯åˆ™è°ƒç”¨resumeæ¢å¤æ’­æ”¾
    2.æ°¸ä¹…å¤±å»ç„¦ç‚¹ï¼Œå¦‚è¢«å…¶ä»–æ’­æ”¾å™¨æŠ¢å äº†ï¼šåˆ™è°ƒç”¨æš‚åœpauseäº‹ä»¶
    3.çŸ­æš‚å¤±å»ç„¦ç‚¹ï¼šå¦‚æœ‰ç”µè¯æ¥äº†ï¼šä¹Ÿæ˜¯æš‚åœ
    4.ç¬é—´å¤±å»ç„¦ç‚¹ï¼šå¦‚é€šçŸ¥ï¼šåˆ™å°†éŸ³é‡è®¾ç½®å°ä¸€ç‚¹å³å¯

æ’­æ”¾å™¨ç„¦ç‚¹ç›‘å¬ä½¿ç”¨çš„æ˜¯ï¼š`AudioManager.OnAudioFocusChangeListener`

- 5.ä½¿ç”¨`å”¤é†’é”`å’Œ`Wifi_lock`:
å”¤é†’é”å¯ä»¥è®©è®¾å¤‡åœ¨æ¯å±çŠ¶æ€ä¹Ÿèƒ½ç»§ç»­æ‰§è¡Œæ’­æ”¾äº‹ä»¶
Wifi_lockå¯ä»¥è®©è®¾å¤‡åœ¨åå°è¿è¡Œä¸‹è½½æ•°æ®ï¼Œ
è®°å¾—æ·»åŠ å¯¹åº”çš„æƒé™ï¼š
```
<uses-permission android:name="android.permission.WAKE_LOCK"/>
```


> å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„AudioPlayerå†…éƒ¨æ‰§è¡Œé€»è¾‘è¿˜æ˜¯æ¯”è¾ƒå¤šçš„ï¼Œå…ˆæ…¢æ…¢æ¶ˆåŒ–ä¸‹å§ã€‚

- **AudioController.java**
```java
/**
 * æ§åˆ¶æ’­æ”¾é€»è¾‘ç±»ï¼Œæ³¨æ„æ·»åŠ ä¸€äº›æ§åˆ¶æ–¹æ³•æ—¶ï¼Œè¦è€ƒè™‘æ˜¯å¦éœ€è¦å¢åŠ Event,æ¥æ›´æ–°UI
 */
public class AudioController {

    /**
     * æ’­æ”¾æ–¹å¼
     */
    public enum PlayMode {
        /**
         * åˆ—è¡¨å¾ªç¯
         */
        LOOP,
        /**
         * éšæœº
         */
        RANDOM,
        /**
         * å•æ›²å¾ªç¯
         */
        REPEAT
    }
    private AudioPlayer mAudioPlayer;
    //æ’­æ”¾é˜Ÿåˆ—,ä¸èƒ½ä¸ºç©º,ä¸è®¾ç½®ä¸»åŠ¨æŠ›é”™
    private ArrayList<AudioBean> mQueue = new ArrayList<>();
    private int mQueueIndex = 0;
    private PlayMode mPlayMode = PlayMode.LOOP;

    private AudioController() {
        EventBus.getDefault().register(this);
        mAudioPlayer = new AudioPlayer();
    }

    /**è®¾ç½®æ­Œæ›²åˆ—è¡¨
     * @param listBean
     */
    public void setmQueue(List<AudioBean> listBean) {
        setmQueue(listBean,0);
    }
    public void setmQueue(List<AudioBean> listBean,int index){
        if(mQueue == null) mQueue = new ArrayList<>();
        mQueue.addAll(listBean);
        mQueueIndex = index;
    }

    public ArrayList<AudioBean> getmQueue() {
        return mQueue;
    }

    public PlayMode getmPlayMode() {
        return mPlayMode;
    }

    public void setmPlayMode(PlayMode mPlayMode) {
        this.mPlayMode = mPlayMode;
        EventBus.getDefault().post(new AudioPlayModeEvent(mPlayMode));
    }



    /**
     * é˜Ÿåˆ—å¤´æ·»åŠ æ’­æ”¾å“¥æ›²
     */
    public void addAudio(AudioBean bean) {
        this.addAudio(bean,0);
    }
    public void addAudio(AudioBean bean,int index){
        if (mQueue == null){
            mQueue = new ArrayList<>();
        }
        int queryId = queryBean(bean);
        if(queryId<=-1){
            //æ²¡æ·»åŠ è¿‡æ­¤idçš„æ­Œæ›²ï¼Œæ·»åŠ ä¸”ç›´æ’­ç•ªæ”¾
            addCustomBean(bean,index);
            setPlayIndex(index);
        }else{
            AudioBean currentBean = getNowPlaying();
            if(!currentBean.id.equals(queryId)){
                setPlayIndex(queryId);
            }
        }
    }

    /**
     * å¯¹å¤–æä¾›è·å–å½“å‰æ’­æ”¾æ—¶é—´
     */
    public int getNowPlayTime() {
        return mAudioPlayer.getCurrentPosition();
    }

    /**
     * å¯¹å¤–æä¾›è·å–æ€»æ’­æ”¾æ—¶é—´
     */
    public int getTotalPlayTime() {
        return mAudioPlayer.getCurrentPosition();
    }

    /**
     * å¯¹å¤–æä¾›çš„è·å–å½“å‰æ­Œæ›²ä¿¡æ¯
     */
    public AudioBean getNowPlaying() {
        return getPlaying(mQueueIndex);
    }

    /**è·å–ä¸‹ä¸€é¦–AudioBean
     * @return
     */
    private AudioBean getNextPlaying() {
        switch (mPlayMode) {
            case LOOP:
                mQueueIndex = (mQueueIndex + 1) % mQueue.size();
                return getPlaying(mQueueIndex);
            case RANDOM:
                mQueueIndex = new Random().nextInt(mQueue.size()) % mQueue.size();
                return getPlaying(mQueueIndex);
            case REPEAT:
                return getPlaying(mQueueIndex);
        }
        return null;
    }

    /**è·å–å‰ä¸€ä¸ªAudioBean
     * @return
     */
    private AudioBean getPreviousPlaying() {
        switch (mPlayMode) {
            case LOOP:
                mQueueIndex = (mQueueIndex + mQueue.size() - 1) % mQueue.size();
                return getPlaying(mQueueIndex);
            case RANDOM:
                mQueueIndex = new Random().nextInt(mQueue.size()) % mQueue.size();
                return getPlaying(mQueueIndex);
            case REPEAT:
                return getPlaying(mQueueIndex);
        }
        return null;
    }

    /**è·å–å½“å‰æ’­æ”¾çš„AudioBean
     * @param index
     * @return
     */
    private AudioBean getPlaying(int index) {
        if (mQueue != null && !mQueue.isEmpty() && index >= 0 && index < mQueue.size()) {
            return mQueue.get(index);
        } else {
            throw new AudioQueueEmptyException("å½“å‰æ’­æ”¾é˜Ÿåˆ—ä¸ºç©º,è¯·å…ˆè®¾ç½®æ’­æ”¾é˜Ÿåˆ—.");
        }
    }

    /**è®¾ç½®å½“å‰æ’­æ”¾åˆ—è¡¨
     * @param index
     */
    public void setPlayIndex(int index) {
        if (mQueue == null) {
            throw new AudioQueueEmptyException("å½“å‰æ’­æ”¾é˜Ÿåˆ—ä¸ºç©º,è¯·å…ˆè®¾ç½®æ’­æ”¾é˜Ÿåˆ—.");
        }
        mQueueIndex  = index;
        play();
    }

    /**
     * åŠ è½½å½“å‰indexæ­Œæ›²
     */
    public void play() {
        AudioBean bean = getPlaying(mQueueIndex);
        load(bean);
    }

    /**
     * åŠ è½½next indexæ­Œæ›²
     */
    public void next() {
        AudioBean bean = getNextPlaying();
        load(bean);
    }

    /**
     * åŠ è½½previous indexæ­Œæ›²
     */
    public void previous() {
        AudioBean bean = getPreviousPlaying();
        load(bean);
    }
    private void load(AudioBean bean) {
        mAudioPlayer.load(bean);
    }

    /**
     * æ·»åŠ /ç§»é™¤åˆ°æ”¶è—
     */
    public void changeFavourite() {
        if (null != GreenDaoHelper.selectFavourite(getNowPlaying())) {
            //å·²æ”¶è—ï¼Œç§»é™¤
            GreenDaoHelper.removeFavourite(getNowPlaying());
            EventBus.getDefault().post(new AudioFavouriteEvent(false));
        } else {
            //æœªæ”¶è—ï¼Œæ·»åŠ æ”¶è—
            GreenDaoHelper.addFavourite(getNowPlaying());
            EventBus.getDefault().post(new AudioFavouriteEvent(true));
        }
    }
    private void addCustomBean(AudioBean bean, int index) {
        if (mQueue == null) {
            throw new AudioQueueEmptyException("å½“å‰æ’­æ”¾é˜Ÿåˆ—ä¸ºç©º,è¯·å…ˆè®¾ç½®æ’­æ”¾é˜Ÿåˆ—.");
        }
        mQueue.add(index,bean);
    }

    /**æŸ¥æ‰¾beanåœ¨é˜Ÿåˆ—ä¸­çš„ä½ç½®
     *  -1:è¡¨ç¤ºæ¯æ‰¾åˆ°ï¼Œæ‰¾åˆ°è¿”å›ç´¢å¼•ä½ç½®
     * @return
     */
    private int queryBean(AudioBean bean) {
        if(mQueue==null){
            throw new AudioQueueEmptyException("å½“å‰é˜Ÿåˆ—ä¸ºç©º");
        }
        return mQueue.indexOf(bean);
    }

    public void resume() {
        mAudioPlayer.resume();
    }

    public void pause() {
        mAudioPlayer.pause();
    }
    /**
     * æ’­æ”¾/æš‚åœåˆ‡æ¢
     */
    public void playOrPause() {
        if (isStartState()) {
            pause();
        } else if (isPauseState()) {
            resume();
        }
    }
    public void release() {
        mAudioPlayer.release();
        EventBus.getDefault().unregister(this);
    }
    /*
     * è·å–æ’­æ”¾å™¨å½“å‰çŠ¶æ€
     */
    private CustomMediaPlayer.Status getStatus() {
        return mAudioPlayer.getStatus();
    }
    /**
     * å¯¹å¤–æä¾›æ˜¯å¦æ’­æ”¾ä¸­çŠ¶æ€
     */
    public boolean isStartState() {
        return CustomMediaPlayer.Status.STARTED == getStatus();
    }

    /**
     * å¯¹å¤–ææä¾›æ˜¯å¦æš‚åœçŠ¶æ€
     */
    public boolean isPauseState() {
        return CustomMediaPlayer.Status.PAUSED == getStatus();
    }

    //æ’æ”¾å®Œæ¯•äº‹ä»¶å¤„ç†
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onAudioCompleteEvent(
            AudioCompleteEvent event) {
        next();
    }

    //æ’­æ”¾å‡ºé”™äº‹ä»¶å¤„ç†
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onAudioErrorEvent(AudioErrorEvent event) {
        next();
    }


    public static AudioController getInstance() {
        return AudioController.SingletonHolder.instance;
    }
    private static class SingletonHolder {
        private static AudioController instance = new AudioController();
    }
}
```
**è¿™ä¸ªç±»æ˜¯æ•´ä¸ªä½“ç³»çš„æ ¸å¿ƒç±»ï¼šèµ·æ‰¿ä¸Šå¯ä¸‹ä½œç”¨**

1.å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªListçš„æ­Œæ›²åˆ—è¡¨ï¼Œä¸€ä¸ªå½“å‰ç´¢å¼•indexä»¥åŠå½“å‰æ’­æ”¾æ¨¡å¼ï¼š
æ’­æ”¾æ¨¡å¼ï¼š
loopï¼šé¡ºåºæ’­æ”¾
randomï¼šéšæœºæ’­æ”¾
repeatï¼šå•æ›²å¾ªç¯

2.æä¾›äº†å¾ˆå¤šå¤–éƒ¨æ–¹æ³•ï¼š
playï¼Œpauseï¼Œresumeï¼Œnextï¼Œprevç­‰è¿™äº›æ–¹æ³•å®é™…æ˜¯å°†æ•°æ®å…ƒä¼ é€’ç»™AudioPlayeræ‰§è¡Œï¼ŒAudioPlayerä¼ é€’ç»™MediaPlayeræ‰§è¡Œã€‚

3.æ¥æ”¶MediaPlayerå¯¹å¤–è¾“å‡ºçš„äº‹ä»¶ï¼Œå¹¶æ‰§è¡Œå¯¹åº”çš„æ–¹æ³•ã€‚å¯¹å¤–è¾“å‡ºä¸€äº›Eventï¼šå¦‚æ’­æ”¾æ¨¡å¼çš„æ”¹å˜ç­‰

**è¿™ä¸ªæ–¹æ³•æ˜¯æ ¸å¿ƒç±»ï¼Œä½†æ˜¯å¥½åƒåšçš„äº‹æƒ…å¹¶æ²¡æœ‰AudioPlayerå¤šå‘¢ã€‚ã€‚**

- **MusicPlayerService.java**

```java
public class MusicPlayerService extends Service{
    @Nullable
    @Override
    public IBinder onBind(Intent intent) {
        return new AudioProvider.Stub() {

            @Override
            public void setQueue(List<AudioBean> audioList) throws RemoteException {
                AudioController.getInstance().setmQueue(audioList);
                //åˆå§‹åŒ–å‰å°Notification
                NotificationHelper.getInstance().init(new NotificationHelper.NotificationHelperListener() {
                    @Override
                    public void onNotificationInit() {
                        //è®©æœåŠ¡å¤„äºå‰å°ï¼Œæé«˜ä¼˜å…ˆçº§ï¼Œå¢åŠ ä¿æ´»èƒ½åŠ›
                        startForeground(NotificationHelper.NOTIFICATION_ID,NotificationHelper.getInstance().getNotification());
                    }
                });
            }

            @Override
            public void addAudio(AudioBean bean) throws RemoteException {
                AudioController.getInstance().addAudio(bean);
            }

            @Override
            public void play() throws RemoteException {
                AudioController.getInstance().play();

            }

            @Override
            public void playNext() throws RemoteException {
                AudioController.getInstance().next();
            }

            @Override
            public void playPre() throws RemoteException {
                AudioController.getInstance().previous();
            }

            @Override
            public void pause() throws RemoteException {
                AudioController.getInstance().pause();
            }

            @Override
            public void resume() throws RemoteException {
                AudioController.getInstance().resume();
            }

            @Override
            public void release() throws RemoteException {
                AudioController.getInstance().release();
            }
        };
    }

    @Override
    public void onCreate() {
        EventBus.getDefault().register(this);
        registerBroadcastReceiver();
    }

    @Override
    public void onDestroy() {
        super.onDestroy();
        EventBus.getDefault().unregister(this);
        AudioController.getInstance().release();
        unRegisterBroadcastReceiver();
    }

    private void registerBroadcastReceiver() {
        if (mReceiver == null) {
            mReceiver = new NotificationReceiver();
            IntentFilter filter = new IntentFilter();
            filter.addAction(NotificationReceiver.ACTION_STATUS_BAR);
            registerReceiver(mReceiver, filter);
        }
    }

    private NotificationReceiver mReceiver;
    private void unRegisterBroadcastReceiver() {
        if (mReceiver != null) {
            unregisterReceiver(mReceiver);
        }
    }
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onAudioLoadEvent(AudioLoadEvent event) {
        //æ›´æ–°notifacationä¸ºloadçŠ¶æ€
        NotificationHelper.getInstance().showLoadStatus(event.mAudioBean);
    }

    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onAudioPauseEvent(AudioPauseEvent event) {
        //æ›´æ–°notifacationä¸ºæš‚åœçŠ¶æ€
        NotificationHelper.getInstance().showPauseStatus();
    }

    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onAudioStartEvent(AudioStartEvent event) {
        //æ›´æ–°notifacationä¸ºæ’­æ”¾çŠ¶æ€
        NotificationHelper.getInstance().showPlayStatus();
    }

    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onAudioFavouriteEvent(AudioFavouriteEvent event) {
        //æ›´æ–°notifacationæ”¶è—çŠ¶æ€
        NotificationHelper.getInstance().changeFavouriteStatus(event.isFavourite);
    }

    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onAudioReleaseEvent(AudioReleaseEvent event) {
        //ç§»é™¤notifacation
    }

    /**
     * æ¥æ”¶Notificationå‘é€çš„å¹¿æ’­
     */
    public static class NotificationReceiver extends BroadcastReceiver {
        public static final String ACTION_STATUS_BAR =
                AudioHelper.getmContext().getPackageName() + ".NOTIFICATION_ACTIONS";
        public static final String EXTRA = "extra";
        public static final String EXTRA_PLAY = "play_pause";
        public static final String EXTRA_NEXT = "play_next";
        public static final String EXTRA_PRE = "play_previous";
        public static final String EXTRA_FAV = "play_favourite";

        @Override
        public void onReceive(Context context, Intent intent) {
            if (intent == null || TextUtils.isEmpty(intent.getAction())) {
                return;
            }
            String extra = intent.getStringExtra(EXTRA);
            switch (extra) {
                case EXTRA_PLAY:
                    //å¤„ç†æ’­æ”¾æš‚åœäº‹ä»¶,å¯ä»¥å°åˆ°AudioControllerä¸­
                    AudioController.getInstance().playOrPause();
                    break;
                case EXTRA_PRE:
                    AudioController.getInstance().previous(); //ä¸ç®¡å½“å‰çŠ¶æ€ï¼Œç›´æ¥æ’­æ”¾
                    break;
                case EXTRA_NEXT:
                    AudioController.getInstance().next();
                    break;
                case EXTRA_FAV:
                    AudioController.getInstance().changeFavourite();
                    break;
            }
        }
    }
}
```

æˆ‘ä»¬çœ‹åˆ°è¿™ä¸ªç±»ï¼š

1.å†…éƒ¨å®ç°äº†ä¸€ä¸ª`AudioProvider.Stub`ç±»ï¼Œè¿™ä¸ªç±»å®ç°äº†å¾ˆå¤šå¤–éƒ¨è°ƒç”¨å¸¸ç”¨æ–¹æ³•;è¿™ä¹ˆåšçš„è®¾è®¡åŸåˆ™æ˜¯ä¸ºäº†æŠŠæˆ‘ä»¬å°è£…çš„ä»£ç æ–¹ä¾¿ç¬¬ä¸‰æ–¹åº”ç”¨è°ƒç”¨ï¼Œå°±ä¸å¿…é‡å¤å¼€å‘äº†ã€‚

2.æ³¨å†Œäº†ä¸€ä¸ª`NotificationReceiver`çš„å¹¿æ’­ç±»ï¼Œè¿™ä¸ªç±»æ˜¯ç”¨äºæˆ‘ä»¬çš„éŸ³ä¹æœåŠ¡å’Œé€šçŸ¥æ é€šè®¯ã€‚

3.æ³¨å†Œäº†ä¸€äº›`EventBus`äº‹ä»¶ï¼Œè¿™äº›äº‹ä»¶å¯ä»¥ç”¨æ¥ç›‘å¬å½“å‰`MediaPlayer`çš„çŠ¶æ€ï¼Œå¹¶å¯¹é€šçŸ¥æ ä¸­çš„`UI`è¿›è¡Œä¿®æ”¹ã€‚


è¿˜æœ‰å…¶ä»–å‡ ä¸ªç±»æˆ‘è¿™è¾¹å°±ä¸ç»§ç»­è®²äº†ï¼š

**æ€»ç»“ä¸‹æˆ‘ä»¬è¿™ä¸ªç‰ˆæœ¬çš„`äº‹ä»¶æµç¨‹å›¾`ï¼š**

![äº‹ä»¶æµç¨‹å›¾.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/38bbed5ca6ef4c0fb02523919dcd8313~tplv-k3u1fbpfcp-watermark.image?)


**æˆ‘è¿™è¾¹é¡ºä¾¿å°è£…äº†å‡ ä¸ªè‡ªå®šä¹‰Viewå’Œä¸€ä¸ªæ’­æ”¾å™¨é€šçŸ¥æ ç•Œé¢ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š**

- ä¸€ä¸ªMusicBottomDialogçš„ç»„ä»¶
```
/**
 * åº•éƒ¨å¼¹å‡ºæ­Œæ›²åˆ—è¡¨ï¼š
 * 1.åŠŸèƒ½ï¼š
 *  å¾ªç¯æ¨¡å¼ï¼š
 *  æ”¶è—åŠŸèƒ½
 *  åˆ é™¤åˆ—è¡¨åŠŸèƒ½
 *  æ­Œæ›²åˆ—è¡¨
    å·¦è¾¹æ˜¯ä¸€ä¸ªåœ†å½¢çš„å¯æ—‹è½¬ä¸“è¾‘å›¾ç‰‡ï¼Œä½¿ç”¨çš„æ˜¯ä¹‹å‰å°è£…çš„å›¾ç‰‡åŠ è½½åº“åŠ è½½çš„
 */
public class MusicBottomDialog extends BottomSheetDialog {
```

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9bda114f88464252b514a1179651ae28~tplv-k3u1fbpfcp-watermark.image?)




- è¿™æ˜¯é€šçŸ¥æ çš„éŸ³ä¹æ’­æ”¾ç»„ä»¶ï¼š


![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a8443b6bbbfa4312bfdada23cfb854ec~tplv-k3u1fbpfcp-watermark.image?)


- æœ€åè¿™å„¿æ˜¯éŸ³ä¹æ’­æ”¾å•æ›²ç•Œé¢ï¼Œå¯ä»¥å·¦å³æ»‘åŠ¨å¬å…¶ä»–æ­Œæ›²


![device-2022-07-22-003546.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/82e188c0f7f1468ca1034611a3bb12ff~tplv-k3u1fbpfcp-watermark.image?)



**å¾—ç›Šäºå‰é¢æˆ‘ä»¬å°è£…çš„éŸ³ä¹æ’­æ”¾ç»„ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå¿«çš„å¼€å‘å‡ºä¸€ä¸ªéŸ³ä¹æ’­æ”¾ç•Œé¢ï¼Œå¯ä»¥æŠŠé‡å¿ƒæ”¾åœ¨ç•Œé¢çš„è®¾è®¡å’Œæ¸²æŸ“ä¸Šé¢ã€‚**

**å®Œæ•´ä»£ç å¯ä»¥æŸ¥çœ‹githubä¸Šçš„Demoï¼š**
https://github.com/ByteYuhb/anna_music_app

## æ€»ç»“
**æˆ‘ä»¬ä»Šå¤©è¦å°è£…çš„éŸ³ä¹æ’­æ”¾ç»„ä»¶åœ¨è¿™ä¸ªé¡¹ç›®ä¸­çš„æ¯”é‡å¾ˆå¤§ï¼Œç®—æ˜¯è¯¥ç³»åˆ—ä¸­çš„æ ¸å¿ƒéƒ¨åˆ†ã€‚å¸Œæœ›å¤§å®¶å¯ä»¥ä»ä¸­è·å–åˆ°è‡ªå·±æƒ³è¦çš„ä¸œè¥¿ã€‚**

åˆ°ä»Šå¤©æˆ‘ä»¬ç»„ä»¶åŒ–å®æˆ˜é¡¹ç›®å·²ç»å¼€å‘äº†å·®ä¸å¤šä¸€åŠäº†ï¼Œåé¢è¿˜ä¼šå¯¹`åˆ†äº«ç»„ä»¶`ä»¥åŠ`è§†é¢‘æ’­æ”¾ç»„ä»¶`è¿›è¡Œå°è£…ï¼Œä»¥åŠå¯¹`baseåº“çš„å°è£…ï¼Œaroutåº“çš„ä½¿ç”¨ï¼Œè®©ç»„ä»¶ä¹‹é—´è¿›è¡Œè§£è€¦`ã€‚
æŒç»­è¾“å‡ºä¸­ã€‚ã€‚


![ç»„ä»¶åŒ–å¼€å‘.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/eee1398548e146ed86b49fa42ec2bbbe~tplv-k3u1fbpfcp-watermark.image?)
    