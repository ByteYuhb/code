æºæ‰‹åˆ›ä½œï¼Œå…±åŒæˆé•¿ï¼è¿™æ˜¯æˆ‘å‚ä¸ã€Œæ˜é‡‘æ—¥æ–°è®¡åˆ’ Â· 8 æœˆæ›´æ–‡æŒ‘æˆ˜ã€çš„ç¬¬7å¤©ï¼Œ[ç‚¹å‡»æŸ¥çœ‹æ´»åŠ¨è¯¦æƒ…](https://juejin.cn/post/7123120819437322247 "https://juejin.cn/post/7123120819437322247") >>
> ğŸ”¥ **Hiï¼Œæˆ‘æ˜¯å°ä½™ã€‚**
>
> **æœ¬æ–‡å·²æ”¶å½•åˆ° [GitHub Â· Androider-Planet](https://github.com/ByteYuhb/Androider-Planet) ä¸­ã€‚è¿™é‡Œæœ‰ Android è¿›é˜¶æˆé•¿çŸ¥è¯†ä½“ç³»ï¼Œå…³æ³¨å…¬ä¼—å· [å°ä½™çš„è‡ªä¹ å®¤] ï¼Œåœ¨æˆåŠŸçš„è·¯ä¸Šä¸è¿·è·¯ï¼**
## å‰è¨€
æœ€è¿‘ç»„é‡Œéœ€è¦è¿›è¡Œ**ç»„ä»¶åŒ–æ¡†æ¶**çš„æ”¹é€ ï¼Œç”¨åˆ°äº†**ARouter**è¿™ä¸ªå¼€æºæ¡†æ¶ï¼Œä¸ºäº†æ›´å¥½çš„å¯¹é¡¹ç›®è¿›è¡Œæ”¹é€ ï¼Œç¬”è€…èŠ±äº†ä¸€äº›æ—¶é—´å»äº†è§£äº†ä¸‹ARouter

`ARouter`æ˜¯é˜¿é‡Œå·´å·´å›¢é˜Ÿåœ¨17å¹´åˆå‘å¸ƒçš„ä¸€æ¬¾é’ˆå¯¹**ç»„ä»¶åŒ–**æ¨¡å—ä¹‹é—´**æ— æ¥è§¦é€šè®¯**çš„ä¸€ä¸ªå¼€æºæ¡†æ¶ï¼Œç»è¿‡å¤šä¸ªç‰ˆæœ¬çš„è¿­ä»£ï¼Œç°åœ¨å·²ç»éå¸¸æˆç†Ÿäº†ã€‚

`ARouter`**ä¸»è¦ä½œç”¨**ï¼š**ç»„ä»¶é—´é€šè®¯ï¼Œç»„ä»¶è§£è€¦ï¼Œè·¯ç”±è·³è½¬ï¼Œæ¶‰åŠåˆ°æˆ‘ä»¬å¸¸ç”¨çš„Activityï¼ŒProviderï¼ŒFragmentç­‰å¤šä¸ªåœºæ™¯çš„è·³è½¬**

æ¥ä¸‹æ¥ç¬”è€…ä¼šä»¥å‡ ä¸ªé˜¶æ®µæ¥å¯¹`Arouter`è¿›è¡Œè®²è§£ï¼š

> - [Androidå¼€æºç³»åˆ—-ç»„ä»¶åŒ–æ¡†æ¶Arouter-(ä¸€)ä½¿ç”¨æ–¹å¼è¯¦è§£](https://juejin.cn/post/7134326382565261348)
> - [Androidå¼€æºç³»åˆ—-ç»„ä»¶åŒ–æ¡†æ¶Arouter-(äºŒ)æ·±åº¦åŸç†è§£æ](https://juejin.cn/post/7134632360087126023)
> - Androidå¼€æºç³»åˆ—-ç»„ä»¶åŒ–æ¡†æ¶Arouter-(ä¸‰)APTæŠ€æœ¯è¯¦è§£
> - Androidå¼€æºç³»åˆ—-ç»„ä»¶åŒ–æ¡†æ¶Arouter-(å››)AGPæ’ä»¶è¯¦è§£

è¿™ç¯‡æ–‡ç« æˆ‘ä»¬æ¥è®²è§£ä¸‹ï¼š**Arouterçš„åŸºæœ¬åŸç†**

## 1.ARouterè®¤çŸ¥
é¦–å…ˆæˆ‘ä»¬ä»å‘½åæ¥çœ‹:ARouterç¿»è¯‘è¿‡æ¥å°±æ˜¯`ä¸€ä¸ªè·¯ç”±å™¨`ã€‚

`å®˜æ–¹å®šä¹‰`ï¼š
> ä¸€ä¸ªç”¨äºå¸®åŠ© Android App è¿›è¡Œç»„ä»¶åŒ–æ”¹é€ çš„æ¡†æ¶ â€”â€” æ”¯æŒæ¨¡å—é—´çš„è·¯ç”±ã€é€šä¿¡ã€è§£è€¦

é‚£ä¹ˆä»€ä¹ˆæ˜¯è·¯ç”±å‘¢ï¼Ÿ
ç®€å•ç†è§£å°±æ˜¯ï¼š**ä¸€ä¸ªå…¬å…±å¹³å°è½¬å‘ç³»ç»Ÿ**

## å·¥ä½œæ–¹å¼ï¼š

![arouteråŸç†.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9d2e47eeaa2c4a9f83bb6fa48c6ac835~tplv-k3u1fbpfcp-watermark.image?)
- 1.**æ³¨å†ŒæœåŠ¡**ï¼šå°†æˆ‘ä»¬éœ€è¦å¯¹å¤–æš´éœ²çš„é¡µé¢æˆ–è€…æœåŠ¡æ³¨å†Œåˆ°ARouterå…¬å…±å¹³å°ä¸­
- 2.**è°ƒç”¨æœåŠ¡**ï¼šè°ƒç”¨ARouterçš„æ¥å£ï¼Œä¼ å…¥åœ°å€å’Œå‚æ•°ï¼ŒARouterè§£æä¼ å…¥çš„åœ°å€å’Œå‚æ•°è½¬å‘åˆ°å¯¹åº”çš„æœåŠ¡ä¸­

é€šè¿‡ARouterå½¢æˆäº†ä¸€ä¸ªæ— æ¥è§¦è§£è€¦çš„è°ƒç”¨è¿‡ç¨‹

## 2.ARouteræ¶æ„è§£æ
æˆ‘ä»¬æ¥çœ‹ä¸‹`ARouter`çš„æºç æ¶æ„ï¼š

![ARouteræºç æ¶æ„.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/814a072417a140679f71e75a8979bd0f~tplv-k3u1fbpfcp-watermark.image?)

- **app**:æ˜¯ARouteræä¾›çš„ä¸€ä¸ªæµ‹è¯•Demo
- **arouter-annotation**ï¼šè¿™ä¸ªlibæ¨¡å—ä¸­å£°æ˜äº†å¾ˆå¤šæ³¨è§£ä¿¡æ¯å’Œä¸€äº›æšä¸¾ç±»
- **arouter-api**ï¼šARouterçš„æ ¸å¿ƒapiï¼Œè½¬æ¢è¿‡ç¨‹çš„æ ¸å¿ƒæ“ä½œéƒ½åœ¨è¿™ä¸ªæ¨¡å—é‡Œé¢
- **arouter-compiler**ï¼šAPTå¤„ç†å™¨ï¼Œè‡ªåŠ¨ç”Ÿæˆè·¯ç”±è¡¨çš„è¿‡ç¨‹å°±æ˜¯åœ¨è¿™é‡Œé¢å®ç°çš„
- **arouter-gradle-plugin**ï¼šè¿™æ˜¯ä¸€ä¸ªç¼–è¯‘æœŸä½¿ç”¨çš„Pluginæ’ä»¶ï¼Œä¸»è¦ä½œç”¨æ˜¯ç”¨äºç¼–è¯‘å™¨è‡ªåŠ¨åŠ è½½è·¯ç”±è¡¨ï¼ŒèŠ‚çœåº”ç”¨çš„å¯åŠ¨æ—¶é—´ã€‚

## 3.åŸç†è®²è§£

è¿™é‡Œæˆ‘ä»¬ä¸ä¼šä¸€å¼€å§‹å°±å¤§ç¯‡å¹…å¯¹æºç è¿›è¡Œè®²è§£:
æˆ‘ä»¬å…ˆæ¥ä»‹ç»ARouterä¸­çš„å‡ ä¸ªé‡è¦æ¦‚å¿µï¼šæœ‰äº†è¿™å‡ ä¸ªæ¦‚å¿µï¼Œåé¢åœ¨å»çœ‹æºç å°±ä¼šè½»æ¾å¤šäº†

### å‰ç½®åŸºç¡€æ¦‚å¿µï¼š

#### æ¦‚å¿µ1ï¼š`PostCard`(æ˜ä¿¡ç‰‡)
æ—¢ç„¶æ˜¯æ˜ä¿¡ç‰‡è¦å°†ä¿¡ä»¶å¯„åˆ°ç›®çš„äººçš„æ‰‹ä¸Šå°±è‡³å°‘éœ€è¦ï¼šæ”¶ä»¶äººçš„å§“åå’Œåœ°å€ï¼Œå¯„ä»¶äººä»¥åŠç”µè¯å’Œåœ°å€ç­‰

ARouterå°±æ˜¯ä½¿ç”¨`PostCard`è¿™ä¸ªç±»æ¥å­˜å‚¨**å¯„ä»¶äººå’Œæ”¶ä»¶äººä¿¡æ¯**çš„ã€‚

```java
public final class Postcard extends RouteMeta {
    // Base
    private Uri uri; //å¦‚æœä½¿ç”¨Uriæ–¹å¼å‘èµ·luyou
    private Object tag;             // A tag prepare for some thing wrong. inner params, DO NOT USE!
    private Bundle mBundle;         // éœ€è¦ä¼ é€’çš„å‚æ•°ä½¿ç”¨bundleå­˜å‚¨
    private int flags = 0;         // å¯åŠ¨Activityçš„æ ‡å¿—ï¼šå¦‚NEW_FALG
    private int timeout = 300;      // è·¯ç”±è¶…æ—¶
    private IProvider provider;     // ä½¿ç”¨IProviderçš„æ–¹å¼è·³è½¬
    private boolean greenChannel;	//ç»¿è‰²é€šé“ï¼Œå¯ä»¥ä¸ç»è¿‡æ‹¦æˆªå™¨
    private SerializationService serializationService; //åºåˆ—åŒ–æœåŠ¡serializationServiceï¼šéœ€è¦ä¼ é€’Objectè‡ªå®šä¹‰ç±»å‹å¯¹è±¡ï¼Œå°±éœ€è¦å®ç°è¿™ä¸ªæœåŠ¡
    private Context context;        // May application or activity, check instance type before use it.
    private String action;			//Activityè·³è½¬çš„Action

    // Animation
    private Bundle optionsCompat;    // The transition animation of activity
    private int enterAnim = -1;
    private int exitAnim = -1;
	...
}

```

`PostCard`ç»§æ‰¿äº†`RouteMeta`ï¼š

```java
public class RouteMeta {
    private RouteType type;         // è·¯ç”±ç±»å‹ï¼šå¦‚Activityï¼ŒFragmentï¼ŒProviderç­‰
    private Element rawType;        // è·¯ç”±åŸå§‹ç±»å‹ï¼Œåœ¨ç¼–è¯‘æ—¶ç”¨æ¥åˆ¤æ–­
    private Class<?> destination;   // ç›®çš„Classå¯¹è±¡
    private String path;            // è·¯ç”±æ³¨å†Œçš„path
    private String group;           // è·¯ç”±æ³¨å†Œçš„groupåˆ†ç»„
    private int priority = -1;      // è·¯ç”±æ‰§è¡Œä¼˜å…ˆçº§ï¼Œpriorityè¶Šä½ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œè¿™ä¸ªä¸€èˆ¬åœ¨æ‹¦æˆªå™¨ä¸­ä½¿ç”¨
    private int extra;              // Extra data
    private Map<String, Integer> paramsType;  //  å‚æ•°ç±»å‹ï¼Œä¾‹å¦‚activityä¸­ä½¿ç”¨@Autowiredçš„å‚æ•°ç±»å‹
    private String name; //è·¯ç”±åå­—ï¼Œç”¨äºç”Ÿæˆjavadoc

    private Map<String, Autowired> injectConfig;  // å‚æ•°é…ç½®ï¼ˆå¯¹åº”paramsTypeï¼‰.

}
```
`RouteMeta`:ä¸»è¦å­˜å‚¨çš„æ˜¯ä¸€äº›ç›®çš„å¯¹è±¡çš„ä¿¡æ¯ï¼Œè¿™äº›å¯¹è±¡æ˜¯åœ¨è·¯ç”±æ³¨å†Œçš„æ—¶å€™æ‰ä¼šç”Ÿæˆã€‚


#### æ¦‚å¿µ2ï¼š`Interceptor`æ‹¦æˆªå™¨
äº†è§£`OkHttp`çš„éƒ½çŸ¥é“ï¼Œå…¶å†…éƒ¨è°ƒç”¨è¿‡ç¨‹å°±æ˜¯ä½¿ç”¨çš„æ‹¦æˆªå™¨æ¨¡å¼ï¼Œæ¯ä¸ªæ‹¦æˆªå™¨æ‰§è¡Œçš„å¯¹åº”çš„ä»»åŠ¡ã€‚

è€Œ`ARouter`ä¸­ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œæ‰€æœ‰çš„è·¯ç”±è°ƒç”¨è¿‡ç¨‹åœ¨åˆ°è¾¾ç›®çš„åœ°å‰éƒ½ä¼šå…ˆç»è¿‡è‡ªå®šä¹‰çš„ä¸€ç³»åˆ—æ‹¦æˆªå™¨ï¼Œå®ç°ä¸€äº›`AOPåˆ‡é¢`ç¼–ç¨‹ã€‚

```java
public interface IInterceptor extends IProvider {

    /**
     * The operation of this interceptor.
     *
     * @param postcard meta
     * @param callback cb
     */
    void process(Postcard postcard, InterceptorCallback callback);
}

```

`IInterceptor`æ˜¯ä¸€ä¸ªæ¥å£ï¼Œç»§æ‰¿äº†`IProvider`ï¼Œæ‰€ä»¥å…¶ä¹Ÿæ˜¯ä¸€ä¸ªæœåŠ¡ç±»å‹

åªéœ€è¦å®ç°`process`æ–¹æ³•å°±å¯ä»¥å®ç°æ‹¦æˆªæ“ä½œã€‚


#### æ¦‚å¿µ3ï¼š`greenChannel`:ç»¿è‰²é€šé“
è®¾ç½®äº†**ç»¿è‰²é€šé“**çš„è·³è½¬è¿‡ç¨‹ï¼Œå¯ä»¥ä¸ç»è¿‡æ‹¦æˆªå™¨


#### æ¦‚å¿µ4ï¼š`Warehouse`ï¼šè·¯ç”±ä»“åº“
**Warehouse**æ„ä¸ºä»“åº“ï¼Œç”¨äºå­˜æ”¾è¢« `@Routeã€@Interceptor`æ³¨é‡Šçš„ è·¯ç”±ç›¸å…³çš„ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å…³æ³¨çš„`destination`ç­‰ä¿¡æ¯

ä¸¾ä¸ªä¾‹å­ï¼š
> moduleBå‘èµ·è·¯ç”±è·³è½¬åˆ°moduleAçš„activityï¼ŒmoduleBæ²¡æœ‰ä¾èµ–moduleAï¼Œåªæ˜¯åœ¨moduleAçš„activityä¸Šå¢åŠ äº†@Routeæ³¨è§£ã€‚ ç”±äºè¿›è¡Œactivityè·³è½¬éœ€è¦ç›®æ ‡Activityçš„classå¯¹è±¡æ¥æ„å»ºintentï¼Œæ‰€ä»¥å¿…é¡»æœ‰ä¸€ä¸ªä¸­é—´äººï¼ŒæŠŠè·¯å¾„"/test/activity"ç¿»è¯‘æˆActivityçš„classå¯¹è±¡ï¼Œç„¶åmoduleBæ‰èƒ½å®ç°è·³è½¬ã€‚ï¼ˆå› æ­¤åœ¨ARouterçš„ä½¿ç”¨ä¸­ moduleAã€moduleB éƒ½æ˜¯éœ€è¦ä¾èµ– arouter-apiçš„ï¼‰

è¿™ä¸ªä¸­é—´äººé‚£å°±æ˜¯`ARouter`äº†ï¼Œè€Œè¿™ä¸ªç¿»è¯‘å·¥æ‰€ä½œç”¨åˆ°çš„è¯å…¸å°±æ˜¯`Warehouse`ï¼Œå®ƒå­˜ç€æ‰€æœ‰è·¯ç”±ä¿¡æ¯ã€‚

```java
class Warehouse {
    //æ‰€æœ‰IRouteGroupå®ç°ç±»çš„classå¯¹è±¡ï¼Œæ˜¯åœ¨ARouteråˆå§‹åŒ–ä¸­èµ‹å€¼ï¼Œkeyæ˜¯pathç¬¬ä¸€çº§
    //ï¼ˆIRouteGroupå®ç°ç±»æ˜¯ç¼–è¯‘æ—¶ç”Ÿæˆï¼Œä»£è¡¨ä¸€ä¸ªç»„ï¼Œå³pathç¬¬ä¸€çº§ç›¸åŒçš„æ‰€æœ‰è·¯ç”±ï¼ŒåŒ…æ‹¬Activityå’ŒProvideræœåŠ¡ï¼‰
    static Map<String, Class<? extends IRouteGroup>> groupsIndex = new HashMap<>(); 
    //æ‰€æœ‰è·¯ç”±å…ƒä¿¡æ¯ï¼Œæ˜¯åœ¨completionä¸­èµ‹å€¼ï¼Œkeyæ˜¯path
    //é¦–æ¬¡è¿›è¡ŒæŸä¸ªè·¯ç”±æ—¶å°±ä¼šåŠ è½½æ•´ä¸ªgroupçš„è·¯ç”±ï¼Œå³IRouteGroupå®ç°ç±»ä¸­æ‰€æœ‰è·¯ç”±ä¿¡æ¯ã€‚åŒ…æ‹¬Activityå’ŒProvideræœåŠ¡
    static Map<String, RouteMeta> routes = new HashMap<>();
    
    //æ‰€æœ‰æœåŠ¡providerå®ä¾‹ï¼Œåœ¨completionä¸­èµ‹å€¼ï¼Œkeyæ˜¯IProviderå®ç°ç±»çš„class
    static Map<Class, IProvider> providers = new HashMap<>();
    //æ‰€æœ‰provideræœåŠ¡çš„å…ƒä¿¡æ¯(å®ç°ç±»çš„classå¯¹è±¡)ï¼Œæ˜¯åœ¨ARouteråˆå§‹åŒ–ä¸­èµ‹å€¼ï¼Œkeyæ˜¯IProviderå®ç°ç±»çš„å…¨ç±»åã€‚
    //ä¸»è¦ç”¨äºä½¿ç”¨IProviderå®ç°ç±»çš„classå‘èµ·çš„è·å–æœåŠ¡çš„è·¯ç”±ï¼Œä¾‹å¦‚ARouter.getInstance().navigation(HelloService.class)
    static Map<String, RouteMeta> providersIndex = new HashMap<>();
    
    //æ‰€æœ‰æ‹¦æˆªå™¨å®ç°ç±»çš„classå¯¹è±¡ï¼Œæ˜¯åœ¨ARouteråˆå§‹åŒ–æ—¶æ”¶é›†åˆ°ï¼Œkeyæ˜¯ä¼˜å…ˆçº§
    static Map<Integer, Class<? extends IInterceptor>> interceptorsIndex = new UniqueKeyTreeMap<>("...");
    //æ‰€æœ‰æ‹¦æˆªå™¨å®ä¾‹ï¼Œæ˜¯åœ¨ARouteråˆå§‹åŒ–å®Œæˆåç«‹å³åˆ›å»º
    static List<IInterceptor> interceptors = new ArrayList<>();
...
}
```

**Warehouse**å­˜äº†å“ªäº›ä¿¡æ¯å‘¢ï¼Ÿ

- **groupsIndex**ï¼šå­˜å‚¨æ‰€æœ‰è·¯ç”±ç»„å…ƒä¿¡æ¯:

![1661149556811.jpg](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/af7ee377eccd490180364b0fb6eac8fc~tplv-k3u1fbpfcp-watermark.image?)
```js
keyï¼šgroupçš„åç§°
valueï¼šè·¯ç”±ç»„çš„æ¨¡å—ç±»classç±»ï¼š
èµ‹å€¼æ—¶æœºï¼šåˆå§‹åŒ–çš„æ—¶å€™
```
- **routes**ï¼šå­˜å‚¨æ‰€æœ‰è·¯ç”±å…ƒä¿¡æ¯ã€‚åˆ‡è®°å’Œä¸Šé¢è·¯ç”±ç»„åˆ†å¼€ï¼Œè·¯ç”±æ˜¯å•ä¸ªè·¯ç”±ï¼Œè·¯ç”±ç»„æ˜¯ä¸€æ‰¹æ¬¡è·¯ç”±

![routes.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fe1a7c128f274544a635310abb5b760a~tplv-k3u1fbpfcp-watermark.image?)
```js
key:è·¯ç”±çš„path
value:è·¯ç”±å…ƒä¿¡æ¯
èµ‹å€¼æ—¶æœºï¼šLogisticsCenter.completionä¸­èµ‹å€¼
å¤‡æ³¨ï¼šé¦–æ¬¡è¿›è¡ŒæŸä¸ªè·¯ç”±æ—¶å°±ä¼šåŠ è½½æ•´ä¸ªgroupçš„è·¯ç”±ï¼Œå³IRouteGroupå®ç°ç±»ä¸­æ‰€æœ‰è·¯ç”±ä¿¡æ¯ã€‚åŒ…æ‹¬Activityå’ŒProvideræœåŠ¡
```
- **providers**ï¼šå­˜å‚¨æ‰€æœ‰æœåŠ¡providerå®ä¾‹ã€‚

```js
key:IProviderå®ç°ç±»çš„class
value:IProviderå®ä¾‹
èµ‹å€¼æ—¶æœºï¼šåœ¨LogisticsCenter.completionä¸­èµ‹å€¼
```
- **providersIndex**ï¼šå­˜å‚¨æ‰€æœ‰provideræœåŠ¡å…ƒä¿¡æ¯(å®ç°ç±»çš„classå¯¹è±¡)ã€‚

![provider.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/aae367d629b7473c879c6d66c8d35b66~tplv-k3u1fbpfcp-watermark.image?)
```js
keyï¼šIProviderå®ç°ç±»çš„å…¨ç±»å
value:provideræœåŠ¡å…ƒä¿¡æ¯
èµ‹å€¼æ—¶æœºï¼šARouteråˆå§‹åŒ–ä¸­èµ‹å€¼ã€‚
å¤‡æ³¨ï¼šç”¨äºä½¿ç”¨IProviderå®ç°ç±»classå‘èµ·çš„è·å–æœåŠ¡çš„è·¯ç”±ï¼Œä¾‹å¦‚ARouter.getInstance().navigation(HelloService.class)
```

- **interceptorsIndex**ï¼šå­˜å‚¨æ‰€æœ‰æ‹¦æˆªå™¨å®ç°ç±»classå¯¹è±¡ã€‚

![Interceptor.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/df87641330cf4e82a1a584bd8346213c~tplv-k3u1fbpfcp-watermark.image?)
```js
keyï¼šä¼˜å…ˆçº§
value:æ‰€æœ‰æ‹¦æˆªå™¨å®ç°ç±»classå¯¹è±¡
èµ‹å€¼æ—¶æœºï¼šæ˜¯åœ¨ARouteråˆå§‹åŒ–æ—¶æ”¶é›†åˆ°

```

- **interceptors**ï¼Œæ‰€æœ‰æ‹¦æˆªå™¨å®ä¾‹ã€‚æ˜¯åœ¨ARouteråˆå§‹åŒ–å®Œæˆåç«‹å³åˆ›å»º

å…¶ä¸­**groupsIndexã€providersIndexã€interceptorsIndex**æ˜¯ARouteråˆå§‹åŒ–æ—¶å°±å‡†å¤‡å¥½çš„åŸºç¡€ä¿¡æ¯ï¼Œä¸ºä¸šåŠ¡ä¸­éšæ—¶å‘èµ·è·¯ç”±æ“ä½œï¼ˆActivityè·³è½¬ã€æœåŠ¡è·å–ã€æ‹¦æˆªå™¨å¤„ç†ï¼‰åšå¥½å‡†å¤‡ã€‚

#### æ¦‚å¿µ5ï¼š`APT`æ³¨è§£å¤„ç†å™¨
ARouterä½¿ç”¨æ³¨è§£å¤„ç†å™¨ï¼Œè‡ªåŠ¨ç”Ÿæˆè·¯ç”±å¸®åŠ©ç±»ï¼š
æˆ‘ä»¬ä½¿ç”¨ARouterç¼–è¯‘åï¼Œä¼šåœ¨å¯¹åº”æ¨¡å—ä¸‹è‡ªåŠ¨ç”Ÿæˆä»¥ä¸‹ç±»ï¼š
è¿™äº›ç±»çš„ç”Ÿæˆè§„åˆ™éƒ½æ˜¯é€šè¿‡APTåœ¨ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œå…³äºAPTåœ¨ARouterä¸­çš„ä½¿ç”¨æ–¹å¼ï¼Œåé¢ä¼šå•ç‹¬æ‹¿ä¸€èŠ‚å‡ºæ¥è®²è§£ï¼š
- Androidå¼€æºç³»åˆ—-ç»„ä»¶åŒ–æ¡†æ¶Arouter-(ä¸‰)APTæŠ€æœ¯è¯¦è§£


#### æ¦‚å¿µ6ï¼š`AGP`æ’ä»¶
ARouterä½¿ç”¨äº†ä¸€ä¸ªå¯é€‰æ’ä»¶ï¼š"com.alibaba:arouter-register:1.0.2"
ä½¿ç”¨è¿™ä¸ªæ’ä»¶å¯ä»¥åœ¨ç¼–è¯‘å™¨åœ¨åŒ…ä¸­è‡ªåŠ¨æ£€æµ‹ä»¥åŠåŠ è½½è·¯ç”±è¡¨ä¿¡æ¯ï¼Œè€Œä¸éœ€è¦åœ¨è¿è¡Œå¯åŠ¨é˜¶æ®µå†ä½¿ç”¨åŒ…åå»dexæ–‡ä»¶ä¸­åŠ è½½ï¼Œæé«˜appå¯åŠ¨æ•ˆç‡
å…³äºè¿™å—çš„ï¼Œåé¢ä¼šåœ¨ï¼š
- Androidå¼€æºç³»åˆ—-ç»„ä»¶åŒ–æ¡†æ¶Arouter-(å››)AGPæ’ä»¶è¯¦è§£


æœ‰äº†ä»¥ä¸Šå‡ ä¸ªæ¦‚å¿µåšåŸºç¡€ç°åœ¨æˆ‘ä»¬å†åˆ°æºç ä¸­å»çœ‹çœ‹ARouteræ˜¯å¦‚ä½•è·¨æ¨¡å—è¿è¡Œèµ·æ¥çš„

### æºç åˆ†æï¼š
é¦–å…ˆæˆ‘ä»¬æ¥çœ‹è·¯ç”±è¿‡ç¨‹ï¼š
- æ­¥éª¤1ï¼šåˆå§‹åŒ–ARouter

```js
ARouter.init(this)
```

- æ­¥éª¤2ï¼šæ³¨å†ŒActivityè·¯ç”±

```js
@Route(path = "/test/activity1", name = "æµ‹è¯•ç”¨ Activity")
public class Test1Activity extends BaseActivity {
    @Autowired
    int age = 10;
	protected void onCreate(Bundle savedInstanceState) {
		ARouter.getInstance().inject(this);
	}
}
```

- æ­¥éª¤3ï¼šé€šè¿‡pathå¯åŠ¨å¯¹åº”çš„Activity

```js
ARouter.getInstance().build("/test/activity2").navigation();
```

ä¸‹é¢æˆ‘ä»¬åˆ†åˆ«æ¥åˆ†æä»¥ä¸Šè¿‡ç¨‹ï¼š

#### æ­¥éª¤1åˆ†æï¼šARouter.init(this)

```java
/**
 * Init, it must be call before used router.
 */
public static void init(Application application) {
	if (!hasInit) {
		logger = _ARouter.logger;
		_ARouter.logger.info(Consts.TAG, "ARouter init start.");
		hasInit = _ARouter.init(application);

		if (hasInit) {
			_ARouter.afterInit();
		}

		_ARouter.logger.info(Consts.TAG, "ARouter init over.");
	}
}

```

è°ƒç”¨äº†_ARouteråŒåinitæ–¹æ³•ï¼Œè¿›å…¥çœ‹çœ‹

```java
protected static synchronized boolean init(Application application) {
	mContext = application;
	LogisticsCenter.init(mContext, executor);
	logger.info(Consts.TAG, "ARouter init success!");
	hasInit = true;
	mHandler = new Handler(Looper.getMainLooper());

	return true;
}
```

å†…éƒ¨åˆå§‹åŒ–äº†ä¸€äº›mContextï¼ŒmHandlerä»¥åŠå­—æ®µä¿¡æ¯
æœ€é‡è¦çš„æ˜¯`LogisticsCenter.init`(mContext, executor)ï¼šè¿™å¥
è¿›å…¥çœ‹çœ‹ï¼š

```java
/**
 * LogisticsCenter init, load all metas in memory. Demand initialization
 */
public synchronized static void init(Context context, ThreadPoolExecutor tpe) throws HandlerException {
	
	try {
		//ä½¿ç”¨AGPæ’ä»¶è¿›è¡Œè·¯ç”±è¡¨çš„è‡ªåŠ¨åŠ è½½
		loadRouterMap();
		//å¦‚æœregisterByPluginè¢«è®¾ç½®ä¸ºtrueï¼Œè¯´æ˜ä½¿ç”¨çš„æ˜¯æ’ä»¶åŠ è½½ï¼Œç›´æ¥è·³è¿‡
		if (registerByPlugin) {
			logger.info(TAG, "Load router map by arouter-auto-register plugin.");
		} else {
			//å¦‚æœæ˜¯falseï¼Œåˆ™è°ƒç”¨ä¸‹é¢æ­¥éª¤åŠ è½½
			Set<String> routerMap;

			// å¦‚æœæ˜¯debugæ¨¡å¼æˆ–è€…æ˜¯æ–°ç‰ˆæœ¬çš„ï¼Œåˆ™æ¯æ¬¡éƒ½ä¼šå»åŠ è½½routerMapï¼Œè¿™ä¼šæ˜¯ä¸€ä¸ªè€—æ—¶æ“ä½œ
			if (ARouter.debuggable() || PackageUtils.isNewVersion(context)) {
				logger.info(TAG, "Run with debug mode or new install, rebuild router map.");
				// These class was generated by arouter-compiler.
				routerMap = ClassUtils.getFileNameByPackageName(mContext, ROUTE_ROOT_PAKCAGE);
				if (!routerMap.isEmpty()) {
					context.getSharedPreferences(AROUTER_SP_CACHE_KEY, Context.MODE_PRIVATE).edit().putStringSet(AROUTER_SP_KEY_MAP, routerMap).apply();
				}

				PackageUtils.updateVersion(context);    // Save new version name when router map update finishes.
			} else {
				//å¦‚æœæ˜¯å…¶ä»–çš„æƒ…å†µï¼Œåˆ™ç›´æ¥å»æ–‡ä»¶ä¸­è¯»å–ã€‚
				logger.info(TAG, "Load router map from cache.");
				routerMap = new HashSet<>(context.getSharedPreferences(AROUTER_SP_CACHE_KEY, Context.MODE_PRIVATE).getStringSet(AROUTER_SP_KEY_MAP, new HashSet<String>()));
			}
			//è¿™é‡Œå¾ªç¯è·å–routerMapä¸­çš„ä¿¡æ¯
			for (String className : routerMap) {
				//å¦‚æœclassName = "com.alibaba.android.arouter.routes.ARouter$$Root"æ ¼å¼ï¼Œåˆ™å°†è·¯ç”±ç»„ä¿¡æ¯æ·»åŠ åˆ°Warehouse.groupsIndexä¸­
				if (className.startsWith(ROUTE_ROOT_PAKCAGE + DOT + SDK_NAME + SEPARATOR + SUFFIX_ROOT)) {
					// This one of root elements, load root.
					((IRouteRoot) (Class.forName(className).getConstructor().newInstance())).loadInto(Warehouse.groupsIndex);
				//å¦‚æœclassName = "com.alibaba.android.arouter.routes.ARouter$$Interceptors"æ ¼å¼ï¼Œåˆ™å°†æ‹¦æˆªå™¨ä¿¡æ¯æ·»åŠ åˆ°Warehouse.interceptorsIndexä¸­
				} else if (className.startsWith(ROUTE_ROOT_PAKCAGE + DOT + SDK_NAME + SEPARATOR + SUFFIX_INTERCEPTORS)) {
					// Load interceptorMeta
					((IInterceptorGroup) (Class.forName(className).getConstructor().newInstance())).loadInto(Warehouse.interceptorsIndex);
				//å¦‚æœclassName = "com.alibaba.android.arouter.routes.ARouter$$Providers"æ ¼å¼ï¼Œåˆ™å°†æœåŠ¡Providerä¿¡æ¯æ·»åŠ åˆ°Warehouse.providersIndexä¸­
				} else if (className.startsWith(ROUTE_ROOT_PAKCAGE + DOT + SDK_NAME + SEPARATOR + SUFFIX_PROVIDERS)) {
					// Load providerIndex
					((IProviderGroup) (Class.forName(className).getConstructor().newInstance())).loadInto(Warehouse.providersIndex);
				}
			}
		}
	} catch (Exception e) {
		throw new HandlerException(TAG + "ARouter init logistics center exception! [" + e.getMessage() + "]");
	}
}
```

**æ€»ç»“_ARouterçš„initæ“ä½œï¼š**

- 1.ä¼˜å…ˆä½¿ç”¨æ’ä»¶åŠ è½½è·¯ç”±è¡¨ä¿¡æ¯åˆ°ä»“åº“ä¸­ï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨æ’ä»¶ï¼Œåˆ™ä½¿ç”¨åŒ…åcom.alibaba.android.arouter.routeså»dexæ–‡ä»¶ä¸­æŸ¥æ‰¾å¯¹åº”çš„ç±»å¯¹è±¡
æŸ¥æ‰¾åˆ°åï¼Œä¿å­˜åˆ°spæ–‡ä»¶ä¸­ï¼Œédebugæˆ–è€…æ–°ç‰ˆæœ¬çš„æƒ…å†µä¸‹ï¼Œä¸‹æ¬¡å°±ç›´æ¥ä½¿ç”¨spæ–‡ä»¶ä¸­ç¼“å­˜çš„ç±»ä¿¡æ¯å³å¯ã€‚
- 2.æŸ¥æ‰¾åˆ°å¯¹åº”çš„ç±»æ–‡ä»¶åï¼Œä½¿ç”¨åå°„è°ƒç”¨å¯¹åº”çš„ç±»çš„loadIntoæ–¹æ³•ï¼Œå°†è·¯ç”±ç»„ï¼Œæ‹¦æˆªå™¨ä»¥åŠæœåŠ¡Providerä¿¡æ¯åŠ è½½åˆ°Warehouseä»“åº“ä¸­


ç»§ç»­çœ‹initæ–¹æ³•ä¸­ç»™çš„_ARouter.afterInit

```java
static void afterInit() {
	// Trigger interceptor init, use byName.
	interceptorService = (InterceptorService) ARouter.getInstance().build("/arouter/service/interceptor").navigation();
}
```
æ‰¾åˆ°`/arouter/service/interceptor`æ³¨è§£å¤„

```java
@Route(path = "/arouter/service/interceptor")
public class InterceptorServiceImpl implements InterceptorService 

```

è¿™é‡Œç»™ARouteråˆ›å»ºäº†ä¸€ä¸ª`InterceptorServiceImpl`æœåŠ¡çš„å®ä¾‹å¯¹è±¡ï¼Œåé¢è®²åˆ°æ‹¦æˆªå™¨çš„æ—¶å€™ä¼šç”¨åˆ°

#### æ­¥éª¤2åˆ†æï¼šæ³¨å†ŒActivityè·¯ç”±
æˆ‘ä»¬æ³¨å†Œçš„Activityï¼ŒProviderç­‰è·¯ç”±ä¿¡æ¯ï¼Œä¼šåœ¨ç¼–è¯‘å™¨è¢«æ³¨è§£å¤„ç†å™¨å¤„ç†åç”Ÿæˆå¯¹åº”çš„è·¯ç”±è¡¨ï¼š

è·¯ç”±è¡¨åœ¨æ­¥éª¤1ä¸­`ARouter`åˆå§‹åŒ–çš„æ—¶å€™è¢«åŠ è½½åˆ°`Warehouse`ä¸­

#### æ­¥éª¤3åˆ†æï¼šé€šè¿‡pathå¯åŠ¨å¯¹åº”çš„Activity

```java
ARouter.getInstance().build("/test/activity2").navigation();
```

è¿™é‡Œæˆ‘ä»¬æ‹†åˆ†æˆä¸‰ä¸ªéƒ¨åˆ†ï¼š`getInstance`ï¼Œ`build`ï¼Œ`navigation`

- 3.1:**getInstance**

```java
public static ARouter getInstance() {
	if (!hasInit) {
		throw new InitException("ARouter::Init::Invoke init(context) first!");
	} else {
		if (instance == null) {
			synchronized (ARouter.class) {
				if (instance == null) {
					instance = new ARouter();
				}
			}
		}
		return instance;
	}
}
```

åšäº†initæ£€æŸ¥å¹¶åˆ›å»ºäº†ä¸€ä¸ªARouterå¯¹è±¡

- 3.2ï¼š**build**

```java
public Postcard build(String path) {
	return _ARouter.getInstance().build(path);
}
è°ƒç”¨äº†_ARouterçš„åŒåbuildæ–¹æ³•
protected Postcard build(String path) {
	if (TextUtils.isEmpty(path)) {
		throw new HandlerException(Consts.TAG + "Parameter is invalid!");
	} else {
		PathReplaceService pService = ARouter.getInstance().navigation(PathReplaceService.class);
		if (null != pService) {
			path = pService.forString(path);
		}
		return build(path, extractGroup(path), true);
	}
}
1.ä½¿ç”¨PathReplaceServiceï¼Œå¯ä»¥æ›¿æ¢åŸpathä¸ºæ–°çš„path
ç»§ç»­çœ‹buildæ–¹æ³•ï¼š
protected Postcard build(String path, String group, Boolean afterReplace) {
	if (TextUtils.isEmpty(path) || TextUtils.isEmpty(group)) {
		throw new HandlerException(Consts.TAG + "Parameter is invalid!");
	} else {
		if (!afterReplace) {
			PathReplaceService pService = ARouter.getInstance().navigation(PathReplaceService.class);
			if (null != pService) {
				path = pService.forString(path);
			}
		}
		return new Postcard(path, group);
	}
}
```

çœ‹åˆ°è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ª`Postcard`ï¼Œä¼ å…¥pathå’Œgroupï¼Œå¯¹Postcardå‰é¢æœ‰è®²è§£ï¼Œè¿™é‡Œä¸å†é‡å¤


- 3.3ï¼š**navigation**

æœ€åä¼šèµ°åˆ°`_ARouter`ä¸­çš„åŒå`navigation`æ–¹æ³•ä¸­ï¼š

```java
protected Object navigation(final Context context, final Postcard postcard, final int requestCode, final NavigationCallback callback) {
	//é¢„å¤„ç†æœåŠ¡
	PretreatmentService pretreatmentService = ARouter.getInstance().navigation(PretreatmentService.class);
	if (null != pretreatmentService && !pretreatmentService.onPretreatment(context, postcard)) {
		// Pretreatment failed, navigation canceled.
		return null;
	}
	try {
		//å®Œå–„PostCardä¿¡æ¯ ç•™ä¸ªç‚¹1
		LogisticsCenter.completion(postcard);
	} catch (NoRouteFoundException ex) {
		logger.warning(Consts.TAG, ex.getMessage());

		if (debuggable()) {
			// Show friendly tips for user.
			runInMainThread(new Runnable() {
				@Override
				public void run() {
					Toast.makeText(mContext, "There's no route matched!\n" +
							" Path = [" + postcard.getPath() + "]\n" +
							" Group = [" + postcard.getGroup() + "]", Toast.LENGTH_LONG).show();
				}
			});
		}
		
		//æ²¡æœ‰æ‰¾åˆ°è·¯ç”±ä¿¡æ¯ï¼Œåˆ™ç›´æ¥è¿”å›callback.onLost
		if (null != callback) {
			callback.onLost(postcard);
		} else {
			// æ²¡æœ‰callbackåˆ™è°ƒç”¨å…¨å±€é™çº§æœåŠ¡DegradeServiceçš„onLostæ–¹æ³•
			DegradeService degradeService = ARouter.getInstance().navigation(DegradeService.class);
			if (null != degradeService) {
				degradeService.onLost(context, postcard);
			}
		}

		return null;
	}
	//å›è°ƒcallback.onFoundæé†’ç”¨æˆ·å·²ç»æ‰¾åˆ°path
	if (null != callback) {
		callback.onFound(postcard);
	}
	//éç»¿è‰²é€šé“èµ°åˆ°æ‹¦æˆªå™¨ä¸­
	if (!postcard.isGreenChannel()) {   // It must be run in async thread, maybe interceptor cost too mush time made ANR.
		interceptorService.doInterceptions(postcard, new InterceptorCallback() {
			/**
			 * Continue process
			 *
			 * @param postcard route meta
			 */
			@Override
			public void onContinue(Postcard postcard) {
				_navigation(postcard, requestCode, callback);
			}

			/**
			 * Interrupt process, pipeline will be destory when this method called.
			 *
			 * @param exception Reson of interrupt.
			 */
			@Override
			public void onInterrupt(Throwable exception) {
				if (null != callback) {
					callback.onInterrupt(postcard);
				}

				logger.info(Consts.TAG, "Navigation failed, termination by interceptor : " + exception.getMessage());
			}
		});
	} else {
		//ç»¿è‰²é€šé“ç›´æ¥è°ƒç”¨_navigation
		return _navigation(postcard, requestCode, callback);
	}

	return null;
}
```

æ–¹æ³•ä»»åŠ¡ï¼š
- 1.é¢„å¤„ç†æœåŠ¡
- 2.å®Œå–„`PostCard`ä¿¡æ¯
- 3.å¦‚æœæ˜¯éç»¿è‰²é€šé“ï¼Œåˆ™ä½¿ç”¨æ‹¦æˆªå™¨å¤„ç†è¯·æ±‚
- 4.è°ƒç”¨`_navigation`å¤„ç†

è¿™é‡Œæˆ‘ä»¬çœ‹ä¸‹ç¬¬3ç‚¹ï¼šæ‹¦æˆªå™¨å¤„ç†

```java
interceptorService.doInterceptions{
	public void onContinue(Postcard postcard) {
		_navigation(postcard, requestCode, callback);
	}
	public void onInterrupt(Throwable exception) {
		if (null != callback) {
			callback.onInterrupt(postcard);
		}
	}
}
```

å¦‚æœè¢«æ‹¦æˆªå›è°ƒcallback.onInterrupt
å¦‚æœæ²¡æœ‰å°±æ‰§è¡Œ_navigationæ–¹æ³•

è¿›å…¥interceptorService.doInterceptionsçœ‹ä¸‹ï¼š

å‰é¢åˆ†æè¿‡interceptorServiceæ˜¯InterceptorServiceImplå¯¹è±¡

```java
@Route(path = "/arouter/service/interceptor")
public class InterceptorServiceImpl implements InterceptorService {
    private static boolean interceptorHasInit;
    private static final Object interceptorInitLock = new Object();

    @Override
    public void doInterceptions(final Postcard postcard, final InterceptorCallback callback) {
        if (MapUtils.isNotEmpty(Warehouse.interceptorsIndex)) {

            checkInterceptorsInitStatus();

            if (!interceptorHasInit) {
                callback.onInterrupt(new HandlerException("Interceptors initialization takes too much time."));
                return;
            }

            LogisticsCenter.executor.execute(new Runnable() {
                @Override
                public void run() {
					//ä½¿ç”¨CancelableCountDownLatchè®¡æ•°å™¨
                    CancelableCountDownLatch interceptorCounter = new CancelableCountDownLatch(Warehouse.interceptors.size());
                    try {
                        _execute(0, interceptorCounter, postcard);
                        interceptorCounter.await(postcard.getTimeout(), TimeUnit.SECONDS);
                        if (interceptorCounter.getCount() > 0) {    // Cancel the navigation this time, if it hasn't return anythings.
							//æ‹¦æˆªå™¨å¤„ç†è¶…æ—¶
                            callback.onInterrupt(new HandlerException("The interceptor processing timed out."));
                        } else if (null != postcard.getTag()) {    // Maybe some exception in the tag.
							//æ‹¦æˆªå™¨è¿‡ç¨‹å‡ºç°å¼‚å¸¸
                            callback.onInterrupt((Throwable) postcard.getTag());
                        } else {
							//ç»§ç»­æ‰§è¡Œä¸‹é¢ä»»åŠ¡onContinue
                            callback.onContinue(postcard);
                        }
                    } catch (Exception e) {
                        callback.onInterrupt(e);
                    }
                }
            });
        } else {
            callback.onContinue(postcard);
        }
    }
	private static void _execute(final int index, final CancelableCountDownLatch counter, final Postcard postcard) {
        if (index < Warehouse.interceptors.size()) {
            IInterceptor iInterceptor = Warehouse.interceptors.get(index);
            iInterceptor.process(postcard, new InterceptorCallback() {
                @Override
                public void onContinue(Postcard postcard) {
                    // Last interceptor excute over with no exception.
                    counter.countDown();
					//é€’å½’è°ƒç”¨_executeæ‰§è¡Œæ‹¦æˆªå™¨
                    _execute(index + 1, counter, postcard);  // When counter is down, it will be execute continue ,but index bigger than interceptors size, then U know.
                }

                @Override
                public void onInterrupt(Throwable exception) {
                    // Last interceptor execute over with fatal exception.

                    postcard.setTag(null == exception ? new HandlerException("No message.") : exception);    // save the exception message for backup.
                    counter.cancel();
                    // Be attention, maybe the thread in callback has been changed,
                    // then the catch block(L207) will be invalid.
                    // The worst is the thread changed to main thread, then the app will be crash, if you throw this exception!
//                    if (!Looper.getMainLooper().equals(Looper.myLooper())) {    // You shouldn't throw the exception if the thread is main thread.
//                        throw new HandlerException(exception.getMessage());
//                    }
                }
            });
        }
    }
}
```

æ‹¦æˆªå™¨æ€»ç»“ï¼š
- 1.ä½¿ç”¨è®¡æ•°å™¨å¯¹æ‹¦æˆªå™¨æŠ€æœ¯ï¼Œæ‰§è¡Œå¼€å§‹è®¡æ•°å™¨+1ï¼Œæ‰§è¡Œç»“æŸè®¡æ•°å™¨-1ï¼Œå¦‚æœæ‹¦æˆªå™¨æ‰§è¡Œæ—¶é—´åˆ°ï¼Œè®¡æ•°å™¨æ•°å¤§äº0ï¼Œåˆ™è¯´æ˜è¿˜æœ‰æœªæ‰§è¡Œå®Œæˆçš„æ‹¦æˆªå™¨ï¼Œè¿™ä¸ªæ—¶å€™å°±è¶…æ—¶äº†é€€å‡º
- 2.æ‹¦æˆªå™¨æ‰§è¡Œä½¿ç”¨é€’å½’çš„æ–¹å¼è¿›è¡Œ
- 3.æ‹¦æˆªå™¨æ‰§è¡Œå®Œæˆç»§ç»­æ‰§è¡Œ`_navigation`æ–¹æ³•

æˆ‘ä»¬æ¥çœ‹_navigationæ–¹æ³•ï¼š

```java
private Object _navigation(final Postcard postcard, final int requestCode, final NavigationCallback callback) {
	final Context currentContext = postcard.getContext();

	switch (postcard.getType()) {
		case ACTIVITY:
			// Build intent
			final Intent intent = new Intent(currentContext, postcard.getDestination());
			intent.putExtras(postcard.getExtras());

			// Set flags.
			int flags = postcard.getFlags();
			if (0 != flags) {
				intent.setFlags(flags);
			}

			// Non activity, need FLAG_ACTIVITY_NEW_TASK
			if (!(currentContext instanceof Activity)) {
				intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
			}

			// Set Actions
			String action = postcard.getAction();
			if (!TextUtils.isEmpty(action)) {
				intent.setAction(action);
			}

			// Navigation in main looper.
			runInMainThread(new Runnable() {
				@Override
				public void run() {
					startActivity(requestCode, currentContext, intent, postcard, callback);
				}
			});

			break;
		case PROVIDER:
			return postcard.getProvider();
		case BOARDCAST:
		case CONTENT_PROVIDER:
		case FRAGMENT:
			Class<?> fragmentMeta = postcard.getDestination();
			try {
				Object instance = fragmentMeta.getConstructor().newInstance();
				if (instance instanceof Fragment) {
					((Fragment) instance).setArguments(postcard.getExtras());
				} else if (instance instanceof android.support.v4.app.Fragment) {
					((android.support.v4.app.Fragment) instance).setArguments(postcard.getExtras());
				}

				return instance;
			} catch (Exception ex) {
				logger.error(Consts.TAG, "Fetch fragment instance error, " + TextUtils.formatStackTrace(ex.getStackTrace()));
			}
		case METHOD:
		case SERVICE:
		default:
			return null;
	}

	return null;
}

```

è¿™ä¸ªæ–¹æ³•å…¶å®å°±æ˜¯æ ¹æ®`PostCard`çš„`type`æ¥å¤„ç†ä¸åŒçš„è¯·æ±‚äº†
- 1.**Activity**ï¼Œç›´æ¥è·³è½¬
- 2.**Fragmentï¼ŒProviderï¼ŒBroadcaseReceiverå’ŒContentProvider**ï¼Œç›´æ¥è¿”å›ç±»çš„å®ä¾‹å¯¹è±¡ã€‚

æ•´ä¸ªè¿‡ç¨‹æˆ‘ä»¬å°±åŸºæœ¬äº†è§£äº†ã€‚
ä¸Šé¢è¿˜ç•™äº†ä¸€ä¸ªç‚¹ï¼š

**ç•™çš„ç‚¹1**ï¼š`ARouter`æ˜¯å¦‚ä½•å®Œå–„`PostCard`ä¿¡æ¯

çœ‹LogisticsCenter.completion(postcard);

è¿›å…¥è¿™ä¸ªæ–¹æ³•ï¼š

```java
public synchronized static void completion(Postcard postcard) {
        if (null == postcard) {
            throw new NoRouteFoundException(TAG + "No postcard!");
        }
		//å»Warehouse.routeså»å–è·¯ç”±å…ƒæ•°æ®ï¼Œå¼€å§‹è‚¯å®šæ˜¯æ²¡æœ‰çš„
        RouteMeta routeMeta = Warehouse.routes.get(postcard.getPath());
		//æ²¡è·å–åˆ°
        if (null == routeMeta) {
            // Maybe its does't exist, or didn't load.
			//åˆ¤æ–­Warehouse.groupsIndexè·¯ç”±ç»„ä¸­æ˜¯å¦æœ‰è¿™ä¸ªgroup
            if (!Warehouse.groupsIndex.containsKey(postcard.getGroup())) {
                throw new NoRouteFoundException(TAG + "There is no route match the path [" + postcard.getPath() + "], in group [" + postcard.getGroup() + "]");
            } else {
                
                try {
                    //åŠ¨æ€æ·»åŠ è·¯ç”±å…ƒä¿¡æ¯åˆ°è·¯ç”±ä¸­
                    addRouteGroupDynamic(postcard.getGroup(), null);
                } catch (Exception e) {              
                }
				//é‡æ–°åŠ è½½ã€‚è¿™ä¸ªæ—¶å€™å°±ä¼šæœ‰è·¯ç”±å…ƒä¿¡æ¯äº†
                completion(postcard);   // Reload
            }
        } else {
			//ç»™postcardè®¾ç½®ç›®çš„åœ°ï¼Œè®¾ç½®ç±»å‹ï¼Œè®¾ç½®ä¼˜å…ˆçº§ï¼Œè®¾ç½®Extraç­‰ä¿¡æ¯
            postcard.setDestination(routeMeta.getDestination());
            postcard.setType(routeMeta.getType());
            postcard.setPriority(routeMeta.getPriority());
            postcard.setExtra(routeMeta.getExtra());

            Uri rawUri = postcard.getUri();
            ...
            switch (routeMeta.getType()) {
                case PROVIDER:  // if the route is provider, should find its instance
                    // Its provider, so it must implement IProvider
                    Class<? extends IProvider> providerMeta = (Class<? extends IProvider>) routeMeta.getDestination();
                    IProvider instance = Warehouse.providers.get(providerMeta);
                    if (null == instance) { // There's no instance of this provider
                        IProvider provider;
                        try {
                            provider = providerMeta.getConstructor().newInstance();
                            provider.init(mContext);
                            Warehouse.providers.put(providerMeta, provider);
                            instance = provider;
                        } catch (Exception e) {
                            logger.error(TAG, "Init provider failed!", e);
                            throw new HandlerException("Init provider failed!");
                        }
                    }
                    postcard.setProvider(instance);
                    postcard.greenChannel();    // Provider should skip all of interceptors
                    break;
                case FRAGMENT:
                    postcard.greenChannel();    // Fragment needn't interceptors
                default:
                    break;
            }
        }
    }

è¿›å…¥addRouteGroupDynamic
public synchronized static void addRouteGroupDynamic(String groupName, IRouteGroup group) throws NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException {
	if (Warehouse.groupsIndex.containsKey(groupName)){
		// If this group is included, but it has not been loaded
		// load this group first, because dynamic route has high priority.
		Warehouse.groupsIndex.get(groupName).getConstructor().newInstance().loadInto(Warehouse.routes);
		Warehouse.groupsIndex.remove(groupName);
	}

	// cover old group.
	if (null != group) {
		group.loadInto(Warehouse.routes);
	}
}
```

çœ‹ä¸Šé¢ä»£ç å¯çŸ¥ï¼š
**æ•°æ®å®Œå–„è¿‡ç¨‹æ˜¯é€šè¿‡ç»„ågroupå»groupsIndexè·å–å¯¹åº”çš„ç»„çš„classå¯¹è±¡ï¼Œç„¶åè°ƒç”¨classå¯¹è±¡çš„loadIntoæ–¹æ³•ï¼Œå°†è·¯ç”±å…ƒæ•°æ®åŠ è½½åˆ°Warehouse.routes
ç„¶åé‡æ–°è°ƒç”¨completionå®Œå–„æ–¹æ³•å»Warehouse.routesä¸­å–å‡ºè·¯ç”±ä¿¡æ¯å¹¶åŠ è½½åˆ°PostCardä¸­ï¼Œè¿™æ ·PostCardä¸­å°±è·å–åˆ°äº†ç›®çš„åœ°å€ä¿¡æ¯ã€‚**



ä¸‹é¢æˆ‘ç”»äº†ä¸€å¼ å›¾æè¿°äº†ä¸Šé¢çš„è°ƒç”¨è¿‡ç¨‹
ä¸€å›¾èƒœåƒè¨€

![arouterè°ƒç”¨è¿‡ç¨‹.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/127693fde669493d8e09caf6ee2082d5~tplv-k3u1fbpfcp-watermark.image?)
## æ€»ç»“
æœ¬æ–‡å…ˆä»‹ç»äº†`ARouter`ä½¿ç”¨è¿‡ç¨‹ä¸­ çš„ä¸€äº›**åŸºæœ¬æ¦‚å¿µ**ï¼Œç†è§£äº†è¿™äº›æ¦‚å¿µåï¼Œæˆ‘ä»¬å†ä»ä½¿ç”¨æ­¥éª¤è§¦å‘ï¼Œå¯¹æ¯ä¸ªä½¿ç”¨èŠ‚ç‚¹è¿›è¡Œäº†ä»‹ç»ã€‚
æœ€åä½¿ç”¨ä¸€å¼ å›¾æ€»ç»“äº†æ•´ä¸ª**ä½¿ç”¨åŸç†è¿‡ç¨‹**ï¼š
è¿™é‡Œæˆ‘ä»¬è¿˜æœ‰ä¸€äº›æ‚¬å¿µï¼š
- 1.ARouterå¸®åŠ©ç±»æ˜¯å¦‚ä½•ç”Ÿæˆçš„ï¼Œè¿™é‡Œä½¿ç”¨åˆ°äº†**APTæ³¨è§£å¤„ç†å™¨**çš„æŠ€æœ¯
å…³äºAPTæˆ‘ä»¬ä¼šåœ¨ä¸‹ä¸€ç« ï¼š

Androidå¼€æºç³»åˆ—-ç»„ä»¶åŒ–æ¡†æ¶Arouter-(ä¸‰)APTæŠ€æœ¯è¯¦è§£

- è¿™é‡Œè¿˜æœ‰ä¸ªæœ‰è¶£çš„ç°è±¡ï¼Œæˆ‘ä»¬åœ¨è°ƒç”¨è·¯ç”±è¡¨åŠ è½½çš„æ—¶å€™ï¼š
ä½¿ç”¨äº†`loadRouterMap`åŠ è½½ï¼Œä½†æ˜¯æŸ¥çœ‹é‡Œé¢ä»£ç ï¼š

```java
private static void loadRouterMap() {
	registerByPlugin = false;
	// auto generate register code by gradle plugin: arouter-auto-register
	// looks like below:
	// registerRouteRoot(new ARouter..Root..modulejava());
	// registerRouteRoot(new ARouter..Root..modulekotlin());
}
```

å±…ç„¶æ˜¯ç©ºçš„ã€‚ã€‚
å‘ƒå‘ƒå‘ƒ
æ²¡å…³ç³»çœ‹æ³¨è§£ï¼š

```java
auto generate register code by gradle plugin: arouter-auto-register
```

å¯ä»¥çœ‹åˆ°è¿™é‡Œä½¿ç”¨äº†`arouter-auto-register`æ’ä»¶ä¸­è‡ªåŠ¨ç”Ÿæˆæ³¨å†Œä»£ç çš„æ–¹å¼ï¼š
è¿™é‡Œå…¶å®å°±æ˜¯ä½¿ç”¨åˆ°äº†**å­—èŠ‚ç æ’åº„æŠ€æœ¯**ï¼ŒåŠ¨æ€æ·»åŠ äº†ä»£ç ï¼Œè¿™é‡Œç•™åˆ°ï¼š

Androidå¼€æºç³»åˆ—-ç»„ä»¶åŒ–æ¡†æ¶Arouter-(å››)AGPæ’ä»¶è¯¦è§£

å¥½äº†ï¼Œæœ¬ç¯‡å°±åˆ°è¿™é‡Œäº†ã€‚

**> æŒç»­è¾“å‡ºä¸­ã€‚ã€‚ä½ çš„ç‚¹èµï¼Œå…³æ³¨æ˜¯æˆ‘æœ€å¤§çš„åŠ¨åŠ›ã€‚**





â€‹	