***æœ¬æ–‡æ­£åœ¨å‚åŠ [ã€Œé‡‘çŸ³è®¡åˆ’ . ç“œåˆ†6ä¸‡ç°é‡‘å¤§å¥–ã€](https://juejin.cn/post/7162096952883019783 "https://juejin.cn/post/7162096952883019783")***
> ğŸ”¥ **Hiï¼Œæˆ‘æ˜¯å°ä½™ã€‚æœ¬æ–‡å·²æ”¶å½•åˆ° [GitHub Â· Androider-Planet](https://github.com/ByteYuhb/Androider-Planet) ä¸­ã€‚è¿™é‡Œæœ‰ Android è¿›é˜¶æˆé•¿çŸ¥è¯†ä½“ç³»ï¼Œå…³æ³¨å…¬ä¼—å· [å°ä½™çš„è‡ªä¹ å®¤] ï¼Œåœ¨æˆåŠŸçš„è·¯ä¸Šä¸è¿·è·¯ï¼**
## ä¸ºä»€ä¹ˆè¦å­¦ä¹ å±å¹•åˆ·æ–°çŸ¥è¯†ï¼Ÿ

å¾ˆå¤šåŒå­¦è§‰å¾—å±å¹•åˆ·æ–°ç»˜åˆ¶çŸ¥è¯†ç‚¹å¯¹ä»–ä»¬å¼€å‘ä¸é‡è¦ï¼Œæ²¡å¿…è¦å­¦ä¹ è¿™äº›ä¸œè¥¿ï¼Œè¿™éƒ¨åˆ†åŒå­¦å¯èƒ½å¹³æ—¶ç»´æŠ¤çš„æ˜¯ä¸€äº›ä¸­å°å‹é¡¹ç›®æˆ–è€…åº”ç”¨æ˜¯å®‰è£…åœ¨ç‰¹å®šè®¾å¤‡ä¸Šï¼Œåªè¦æ±‚å†™å†™ä¸»ç•Œé¢ï¼Œåšä¸€äº›ç®€å•çš„ç½‘ç»œè¯·æ±‚ï¼Œä¸šåŠ¡äº¤äº’ç›¸å…³çŸ¥è¯†ï¼Œå¯¹æ€§èƒ½è¿™å—è¦æ±‚ä¸æ˜¯å¾ˆé«˜ï¼Œç¡®å®æ¶‰åŠä¸åˆ°å¤ªå¤šå±å¹•åˆ·æ–°è¿™å—çŸ¥è¯†ã€‚

![åˆä¸æ˜¯ä¸èƒ½ç”¨.jpg](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c7a59d925f7148eaac15e220f2b86cf8~tplv-k3u1fbpfcp-watermark.image?)

ä½†å¯¹ä¸€äº›å¤§ä¸­å‹é¡¹ç›®æ¥è¯´å¯èƒ½å°±ä¸ä¸€æ ·äº†ï¼š**ä»–ä»¬æ¶‰åŠä¸šåŠ¡è¾ƒå¤šï¼Œè®¾å¤‡ç§ç±»è¾ƒå¤šï¼Œå¾€å¾€ä¸€ä¸ªappå†…éƒ¨é›†æˆäº†åå‡ ä¸ªå­ä¸šåŠ¡ç”šè‡³ä¸Šç™¾ä¸ªï¼Œè¿™å¯¹åº”ç”¨æ€§èƒ½è¦æ±‚å°±æ›´åŠ ä¸¥æ ¼äº†ï¼Œappçš„ä½“éªŒä¹Ÿä¼šé—´æ¥å¯¼è‡´ç”¨æˆ·çš„ç•™å­˜é—®é¢˜**ã€‚

æ‰€ä»¥å­¦ä¹ å±å¹•ç»˜åˆ¶è¿™ç±»ç†è®ºæ€§è¾ƒå¼ºçš„çŸ¥è¯†ä¹Ÿæ˜¯éå¸¸æœ‰å¿…è¦çš„ã€‚

> å¦‚æœä½ æƒ³è¿›é˜¶æˆä¸ºé«˜çº§å¼€å‘ï¼šå±å¹•ç»˜åˆ¶è¿™å—çŸ¥è¯†ä¹Ÿæ˜¯ä¸€ä¸ªç»•ä¸è¿‡å»çš„åã€‚
## 1.å¸¦ç€é—®é¢˜å‡ºå‘
å‰é¢ä¸€ç¯‡[å¡é¡¿ä¼˜åŒ–](https://juejin.cn/post/7161757546875715615#heading-4)çš„æ–‡ç« æˆ‘ä»¬è¯´è¿‡ï¼Œ**ä¸»æµå±å¹•åˆ·æ–°é¢‘ç‡æ˜¯æ¯ç§’60æ¬¡**ï¼ˆé«˜çš„æœ‰90,120ç­‰ï¼‰ï¼Œä¹Ÿå°±æ˜¯**16.6msåˆ·æ–°ä¸€æ¬¡å±å¹•**ï¼Œ
å¦‚æœæˆ‘ä»¬åœ¨ä¸»çº¿ç¨‹åšä¸€äº›è€—æ—¶çš„æ“ä½œï¼Œæœ€ç›´è§‚çš„ç°è±¡å°±æ˜¯å±å¹•å¡é¡¿ï¼Œå…¶å®å°±æ˜¯å‘ç”Ÿäº†ä¸¢å¸§ã€‚

**ç”±æ­¤æŠ›å‡ºå‡ ä¸ªé—®é¢˜ï¼š**
- 1.16.6msæ˜¯ä»€ä¹ˆæ„æ€ï¼Œæ¯æ¬¡16.6mséƒ½ä¼šè°ƒç”¨ä¸€ä¸ªç»˜åˆ¶æµç¨‹ä¹ˆï¼Ÿ
- 2.ä¸ºä»€ä¹ˆåœ¨ä¸»çº¿ç¨‹åšä¸€äº›è€—æ—¶æ“ä½œä¼šå‡ºç°å¡é¡¿ï¼Ÿä¸¢å¸§ï¼Ÿ
- 3.ä¸¢å¸§æ˜¯ä¸ªä»€ä¹ˆæ„æ€ï¼Œæ˜¯å­—é¢ä¸Šçš„ç›´æ¥ä¸¢å¼ƒå½“å‰å¸§è¿˜æ˜¯å»¶åæ˜¾ç¤ºå½“å‰å¸§ï¼Ÿ
- 4.åŒç¼“å†²æ˜¯ä»€ä¹ˆï¼Ÿæœ‰äº†åŒç¼“å­˜å°±ä¸ä¼šå‡ºç°ä¸¢å¸§äº†ä¹ˆï¼Ÿä¸‰ç¼“å†²å‘¢ï¼Ÿ
- 5.äº†è§£Vsyncä¹ˆï¼Ÿå®ƒçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ
- 6.ç”»é¢æ’•è£‚æ˜¯æ€ä¹ˆé€ æˆçš„ï¼Ÿ
- 7.ç¼–èˆè€…æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Ÿ

å¸¦ç€è¿™äº›é—®é¢˜æˆ‘ä»¬å‡ºå‘å§ã€‚

## 2.Androidå±å¹•åˆ·æ–°å‰ç½®çŸ¥è¯†
### CPU/GPUï¼š
- **CPU**ï¼š`ä¸­å¤®å¤„ç†å™¨`ï¼Œä¸»è¦ç”¨äºè®¡ç®—æ•°æ®ï¼Œåœ¨Androidä¸­ä¸»è¦ç”¨äºä¸‰å¤§ç»˜åˆ¶æµç¨‹ä¸­Surfaceçš„è®¡ç®—è¿‡ç¨‹ï¼Œèµ·ç€ç”Ÿäº§è€…çš„ä½œç”¨
- **GPU**ï¼š`å›¾åƒå¤„ç†å™¨`ï¼Œä¸»è¦ç”¨äºæ¸¸æˆç”»é¢çš„æ¸²æŸ“ï¼Œåœ¨Androidä¸­ä¸»è¦ç”¨äºå°†CPUè®¡ç®—å¥½çš„Surfaceæ•°æ®åˆæˆåæ”¾åˆ°bufferä¸­ï¼Œè®©æ˜¾ç¤ºå™¨è¿›è¡Œè¯»å–ï¼Œèµ·ç€æ¶ˆè´¹è€…çš„ä½œç”¨ã€‚

å¦‚ä¸‹å›¾ï¼š
	
![å±å¹•åˆ·æ–°è¿‡ç¨‹.gif](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fcd6c36fb3fb47c7b10444e541b74dfc~tplv-k3u1fbpfcp-watermark.image?)
å…¶ä¸­GPUåœ¨æ¶æ„ä¸­æ˜¯ä»¥`SurfaceFlinger`æœåŠ¡çš„å½¢å¼å·¥ä½œ
	
### SurfaceFlingerï¼š
SurfaceFlingerä½œç”¨æ˜¯æ¥å—å¤šä¸ªæ¥æºçš„å›¾å½¢æ˜¾ç¤ºæ•°æ®Surfaceï¼Œåˆæˆåå‘é€åˆ°æ˜¾ç¤ºè®¾å¤‡ã€‚

æ¯”å¦‚æˆ‘ä»¬çš„ä¸»ç•Œé¢ä¸­ï¼š**å¯èƒ½ä¼šæœ‰statusBarï¼Œä¾§æ»‘èœå•ï¼Œä¸»ç•Œé¢ï¼Œè¿™äº›Viewéƒ½æ˜¯ç‹¬ç«‹Surfaceæ¸²æŸ“å’Œæ›´æ–°ï¼Œæœ€åæäº¤ç»™SFåï¼ŒSFæ ¹æ®Zorderï¼Œé€æ˜åº¦ï¼Œå¤§å°ï¼Œä½ç½®ç­‰å‚æ•°ï¼Œåˆæˆä¸ºä¸€ä¸ªæ•°æ®bufferï¼Œä¼ é€’HWComposeræˆ–è€…OpenGLå¤„ç†ï¼Œæœ€ç»ˆç»™æ˜¾ç¤ºå™¨**ã€‚

![cpuå’Œgpu.webp](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/636dd527800349a886eff1696ca49f03~tplv-k3u1fbpfcp-watermark.image?)
	
### é€è¡Œæ‰«æ
å±å¹•åœ¨åˆ·æ–°bufferçš„æ—¶å€™ï¼Œå¹¶ä¸æ˜¯ä¸€æ¬¡æ€§æ‰«æå®Œæˆï¼Œè€Œæ˜¯**ä»å·¦åˆ°å³ï¼Œä»ä¸Šåˆ°ä¸‹çš„ä¸€ä¸ªè¯»å–è¿‡ç¨‹**ï¼Œé¡ºåºæ˜¾ç¤ºä¸€å±çš„æ¯ä¸ªåƒç´ ç‚¹ï¼Œä½ ä¸ºä»€ä¹ˆçœ‹ä¸åˆ°ï¼Œå› ä¸ºå¤ªå¿«äº†å˜›ï¼ŒæŒ‰60HZçš„å±å¹•åˆ·æ–°ç‡æ¥ç®—ï¼Œè¿™ä¸ªè¿‡ç¨‹åªæœ‰16.66666...msã€‚
	
### å¸§ã€å¸§ç‡ï¼ˆæ•°ï¼‰ã€å±å¹•åˆ·æ–°ç‡ï¼š
åœ¨è§†é¢‘é¢†åŸŸä¸­ï¼Œå¸§å°±ä»£è¡¨ä¸€å¼ å›¾ç‰‡ã€‚ç©è¿‡çŸ­è§†é¢‘å‰ªè¾‘çš„æœ‹å‹åº”è¯¥å¯¹æ­¤å¾ˆäº†è§£ã€‚

å›¾ä¸­ä¸ºæ”¾å¤§åçš„**ä¸€å¸§å›¾ç‰‡**ã€‚	

![å¸§æˆªå›¾.jpg](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6d1c7b8b46e34e00bea385123d7d1703~tplv-k3u1fbpfcp-watermark.image?)

è€Œå¸§ç‡å’Œå±å¹•åˆ·æ–°ç‡ç¡®æ˜¯ä¸¤ä¸ªä¸åŒçš„æ¦‚å¿µï¼š
- **å¸§ç‡**ï¼šè¡¨ç¤º**GPUåœ¨1sä¸­å†…å¯ä»¥æ¸²æŸ“å¤šå°‘å¸§åˆ°bufferä¸­**ï¼Œå•ä½æ˜¯fpsï¼Œè¿™é‡Œè¦ç†è§£çš„æ˜¯**å¸§ç‡æ˜¯ä¸€ä¸ªåŠ¨æ€çš„**ï¼Œæ¯”å¦‚æˆ‘ä»¬å¹³æ—¶è¯´çš„60fpsï¼Œåªæ˜¯1så†…æœ€å¤šå¯ä»¥æ¸²æŸ“60å¸§ï¼Œå‡å¦‚æˆ‘ä»¬å±å¹•æ˜¯é™æ­¢çš„ï¼Œåˆ™GPUæ­¤æ—¶å°±æ²¡æœ‰ä»»ä½•æ“ä½œï¼Œå¸§ç‡å°±ä¸º0.
- **å±å¹•åˆ·æ–°ç‡**ï¼šå±å¹•åœ¨**1så†…å»bufferä¸­å–æ•°æ®çš„æ¬¡æ•°**ï¼Œå•ä½ä¸ºHZï¼Œå¸¸è§å±å¹•åˆ·æ–°ç‡ä¸º60HZã€‚å’Œå¸§ç‡ä¸ä¸€æ ·ï¼Œå±å¹•åˆ·æ–°ç‡æ˜¯ä¸€ä¸ªå›ºå®šå€¼å’Œç¡¬ä»¶å‚æ•°æœ‰å…³ã€‚
		
### ç”»é¢æ’•è£‚ï¼š
ç”»é¢æ’•è£‚ç®€å•è¯´å°±æ˜¯æ˜¾ç¤ºå™¨æŠŠå¤šä¸ªå¸§æ˜¾ç¤ºåœ¨åŒä¸€ä¸ªç”»é¢ä¸­ã€‚å¦‚å›¾ï¼š

![å±å¹•æ’•è£‚.webp](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/31ec877ae8e24dda88798c81fe71be14~tplv-k3u1fbpfcp-watermark.image?)

**ç”»é¢æ’•è£‚çš„åŸå› **ï¼šæˆ‘ä»¬çŸ¥é“å±å¹•åˆ·æ–°ç‡æ˜¯å›ºå®šçš„ï¼Œå‡è®¾ä¸º60HZï¼Œæ­£å¸¸æƒ…å†µä¸‹å½“æˆ‘ä»¬çš„GPUçš„å¸§ç‡ä¹Ÿæ˜¯60fpsçš„æ—¶å€™ï¼ŒGPUç»˜åˆ¶å®Œä¸€å¸§ï¼Œå±å¹•åˆ·æ–°ä¸€å¸§ï¼Œè¿™æ ·æ˜¯ä¸ä¼šå‡ºé—®é¢˜çš„ï¼Œä½†æ˜¯éšç€GPUæ˜¾å¡æ€§èƒ½çš„æå‡ï¼ŒGPUçš„å¸§ç‡è¶…è¿‡60fpsåï¼Œå°±ä¼šå‡ºç°ç”»é¢æ’•è£‚çš„æƒ…å†µï¼Œå®é™…**åœ¨å¸§ç‡è¾ƒä½çš„æ—¶å€™ä¹Ÿä¼šå‡ºç°æ’•è£‚çš„æƒ…å†µã€‚**

**æ‰€ä»¥å…¶æœ¬è´¨æ˜¯å¸§ç‡å’Œå±å¹•åˆ·æ–°ç‡çš„ä¸ä¸€è‡´å¯¼è‡´çš„æ’•è£‚**ã€‚
	
é‚£å¯èƒ½å¤§å®¶è¦è¯´äº†ï¼Œç­‰å±å¹•ä¸€å¸§åˆ·æ–°å®Œæˆåï¼Œå†å°†æ–°çš„ä¸€å¸§å­˜åˆ°bufferä¸­ä¸å°±å¯ä»¥äº†ï¼Œé‚£ä½ è¦çŸ¥é“ï¼Œ**æ—©æœŸçš„4.0ä¹‹å‰è®¾å¤‡æ˜¯åªæœ‰ä¸€ä¸ªbufferï¼Œä¸”å…¶å¹¶æ²¡æœ‰bufferåŒæ­¥çš„æ¦‚å¿µï¼Œå±å¹•è¯»å–bufferä¸­çš„æ•°æ®æ—¶ï¼ŒGPUæ˜¯ä¸çŸ¥é“çš„ï¼Œå±å¹•è¯»å–çš„åŒæ—¶ï¼ŒGPUä¹Ÿåœ¨å†™å…¥ï¼Œå¯¼è‡´bufferè¢«è¦†ç›–ï¼Œå‡ºç°åŒä¸€ç”»é¢ä½¿ç”¨çš„æ˜¯ä¸åŒå¸§çš„æ•°æ®**ã€‚

é‚£æ—¢ç„¶æ˜¯å› ä¸ºä½¿ç”¨åŒä¸€ä¸ªBufferå¼•èµ·çš„ç”»é¢æ’•è£‚ï¼Œ**ä½¿ç”¨ä¸¤ä¸ªbufferä¸å°±å¯ä»¥äº†**ï¼Ÿ
### åŒç¼“å†²
å‰é¢æˆ‘ä»¬è¯´åˆ°ç”»é¢æ’•è£‚æ˜¯ç”±äºå•bufferå¼•èµ·çš„ï¼Œåœ¨4.1ä¹‹å‰ï¼Œä½¿ç”¨äº†åŒç¼“å†²æ¥è§£å†³ç”»é¢æ’•è£‚ã€‚

- GPUå†™å…¥çš„ç¼“å­˜ä¸ºï¼š`Back Buffer`
- å±å¹•åˆ·æ–°ä½¿ç”¨çš„ç¼“å­˜ä¸ºï¼š`Frame Buffer`

å¦‚ä¸‹å›¾ï¼š
	
![åŒbuffer.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/db8b95c61c4a4275a8c67a798a503dcc~tplv-k3u1fbpfcp-watermark.image?)
**å› ä¸ºä½¿ç”¨åŒbufferï¼Œå±å¹•åˆ·æ–°æ—¶ï¼Œframe bufferä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œé€šè¿‡äº¤æ¢bufferæ¥å®ç°å¸§æ•°æ®åˆ‡æ¢ï¼Œé‚£ä»€ä¹ˆæ—¶å€™äº¤æ¢bufferå‘¢ï¼Ÿ**
	
è¿™å°±è¦å¼•å…¥Vsyncçš„æ¦‚å¿µäº†ã€‚
	
### VSyncï¼ˆå‚ç›´åŒæ­¥ï¼‰
æˆ‘ä»¬çŸ¥é“å¦‚æœä¸€ä¸ªå±å¹•åœ¨åˆ·æ–°çš„è¿‡ç¨‹ä¸­ï¼Œæ˜¯ä¸èƒ½äº¤æ¢bufferçš„ï¼Œåªæœ‰ç­‰å±å¹•åˆ·æ–°å®Œæˆåä»¥åæ‰å¯ä»¥è€ƒè™‘bufferçš„äº¤æ¢.

**é‚£å…·ä½“ä»€ä¹ˆæ—¶å€™äº¤æ¢å‘¢**ï¼Ÿ`å½“è®¾å¤‡å±å¹•åˆ·æ–°å®Œæ¯•ååˆ°ä¸‹ä¸€å¸§åˆ·æ–°å‰ï¼Œå› ä¸ºæ²¡æœ‰å±å¹•åˆ·æ–°ï¼Œæ‰€ä»¥è¿™æ®µæ—¶é—´å°±æ˜¯ç¼“å­˜äº¤æ¢çš„æœ€ä½³æ—¶é—´`ã€‚

æ­¤æ—¶ç¡¬ä»¶å±å¹•ä¼šå‘å‡ºä¸€ä¸ªè„‰å†²ä¿¡å·ï¼Œå‘ŠçŸ¥GPUå’ŒCPUå¯ä»¥äº¤æ¢äº†ï¼Œè¿™ä¸ªå°±æ˜¯Vsyncä¿¡å·ã€‚
	
æœ‰äº†åŒç¼“å†²å’ŒVSyncæ˜¯ä¸æ˜¯å°±éƒ½okäº†ï¼Ÿè™½ç„¶ä¸Šé¢æ–¹å¼å¯ä»¥è§£å†³å±å¹•æ’•è£‚çš„é—®é¢˜ï¼Œä½†æ˜¯è¿˜æ˜¯ä¼šå‡ºç°ä¸€äº›å…¶ä»–é—®é¢˜ã€‚
### Jank
åŒç¼“å†²bufferäº¤æ¢è¿˜æœ‰ä¸ª**å‰æå°±æ˜¯GPUå·²ç»å‡†å¤‡å¥½äº†back bufferçš„æ•°**æ®ï¼Œå¦‚æœåœ¨Vsyncåˆ°æ¥æ—¶back bufferå¹¶æ²¡æœ‰å‡†å¤‡å¥½ï¼Œå°±ä¸ä¼šè¿›è¡Œç¼“å­˜çš„äº¤æ¢ï¼Œå±å¹•æ˜¾ç¤ºçš„è¿˜æ˜¯å‰ä¸€å¸§ç”»é¢ï¼Œè¿™ç§æƒ…å†µå°±æ˜¯Jankã€‚
	
æœ‰äº†ä¸Šé¢çš„åŸºç¡€æˆ‘ä»¬å†æ¥èŠèŠAndroidå±å¹•åˆ·æ–°æœºåˆ¶çš„æ¼”å˜è¿‡ç¨‹	
## 3.å±å¹•åˆ·æ–°æœºåˆ¶çš„æ¼”å˜è¿‡ç¨‹	
Androidå±å¹•åˆ·æ–°æœºåˆ¶æ¼”å˜è¿‡ç¨‹æŒ‰bufferçš„ä¸ªæ•°å¯ä»¥åˆ†ä¸º3ä¸ªé˜¶æ®µï¼š
- 1.`å•bufferæ—¶ä»£`
- 2.`åŒbufferæ—¶ä»£`
- 3.`ä¸‰bufferæ—¶ä»£`
	
### 1.å•bufferæ—¶ä»£
GPUå’Œæ˜¾ç¤ºå™¨å…±ç”¨ä¸€å—bufferï¼Œä¼šå¼•èµ·ç”»é¢æ’•è£‚ã€‚

### 2.åŒbufferæ—¶ä»£

#### 2.1ï¼šåœ¨å¼•å…¥VSyncå‰ï¼ˆDrawing without VSyncï¼‰

![drawing without vsync.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6abe7cd8a7f54552ae974a1600b793c2~tplv-k3u1fbpfcp-watermark.image?)
- **CPU**ï¼šè¡¨ç¤ºCPUç»˜åˆ¶çš„æ—¶é—´æ®µ
- **GPU**ï¼šè¡¨ç¤ºGPUåˆæˆback bufferçš„æ—¶é—´æ®µ
- **Display**:æ˜¾ç¤ºå™¨è¯»å–frame bufferçš„æ—¶é—´æ®µ
		

æŒ‰æ—¶é—´é¡ºåºï¼š
- 1.Displayæ˜¾ç¤ºç¬¬0å¸§ç”»é¢ï¼Œè€ŒCPUå’ŒGPUæ­£åœ¨åˆæˆç¬¬1å¸§ï¼Œä¸”åœ¨Displayæ˜¾ç¤ºä¸‹ä¸€å¸§ä¹‹å‰å®Œæˆäº†ã€‚
- 2.ç”±äºGPUåœ¨Displayç¬¬ä¸€ä¸ªVSyncæ¥ä¹‹å‰å®Œæˆäº†back bufferçš„å¡«å……ï¼Œæ­¤æ—¶äº¤æ¢back bufferå’Œframe bufferï¼Œå±å¹•è¿›è¡Œåˆ·æ–°ï¼Œå¯ä»¥æ­£å¸¸æ˜¾ç¤ºç¬¬ä¸€å¸§æ•°æ®ã€‚
- 3.å†æ¥çœ‹ç¬¬2ä¸ªVSyncï¼Œç¬¬äºŒä¸ªVSyncåˆ°æ¥ä¹‹æ—¶ï¼ŒGPUå¹¶æ²¡æœ‰åŠæ—¶çš„å¡«å……back bufferï¼Œè¿™ä¸ªæ—¶å€™ä¸èƒ½äº¤äº’bufferï¼Œå±å¹•åˆ·æ–°çš„è¿˜æ˜¯ç¬¬1å¸§çš„ç”»é¢ã€‚å°±è¯´è¿™é‡Œå‘ç”Ÿäº†â€œjankâ€
- 4.åœ¨ç¬¬3ä¸ªVSyncä¿¡å·åˆ°æ¥æ—¶ï¼Œç¬¬2å¸§çš„æ•°æ®å·²ç»å†™å…¥back bufferï¼Œç¬¬3å¸§çš„æ•°æ®GPUè¿˜æ²¡å†™å…¥ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™äº¤äº’bufferæ˜¾ç¤ºçš„æ˜¯ç¬¬2å¸§çš„æ•°æ®
- 5.åŒç†ï¼Œåœ¨ç¬¬4ä¸ªVSyncæ—¶ï¼Œç¬¬3å¸§æ•°æ®å·²ç»å¤„ç†å®Œæ¯•ï¼Œäº¤æ¢bufferåæ˜¾ç¤ºçš„æ˜¯ç¬¬2å¸§çš„æ•°æ®
		

è¿™é‡Œå‘ç”Ÿ`jank`çš„åŸå› æ˜¯ï¼š**åœ¨ç¬¬2å¸§CPUå¤„ç†æ•°æ®çš„æ—¶å€™å¤ªæ™šäº†ï¼ŒGPUæ²¡æœ‰åŠæ—¶å°†æ•°æ®å†™å…¥åˆ°bufferä¸­ï¼Œå¯¼è‡´jankçš„å‘ç”Ÿã€‚**
		
å¦‚æœå¯ä»¥æŠŠCPUç»˜åˆ¶æµç¨‹æå‰åˆ°æ¯ä¸ªVSyncä¿¡å·æ¥çš„æ—¶å€™è¿›è¡ŒCPUçš„ç»˜åˆ¶ï¼Œé‚£æ˜¯ä¸æ˜¯å°±å¯ä»¥è®©CPUçš„è®¡ç®—ä»¥åŠGPUçš„åˆæˆå†™å…¥bufferçš„æ“ä½œæœ‰å®Œæ•´çš„16.6msã€‚
		
#### 2.1ï¼šåœ¨å¼•å…¥VSyncåï¼ˆDrawing with VSyncï¼‰
ä¸ºäº†è¿›ä¸€æ­¥ä¼˜åŒ–æ€§èƒ½ï¼Œè°·æ­Œåœ¨4.1ä¹‹åå¯¹å±å¹•ç»˜åˆ¶ä¸åˆ·æ–°è¿‡ç¨‹å¼•å…¥äº†**Project Butter**ï¼ˆ`é»„æ²¹å·¥ç¨‹`ï¼‰ï¼Œç³»ç»Ÿåœ¨æ”¶åˆ°VSyncä¿¡å·ä¹‹åï¼Œé©¬ä¸Šè¿›è¡ŒCPUçš„ç»˜åˆ¶ä»¥åŠGPUçš„bufferå†™å…¥ã€‚
è¿™æ ·å°±å¯ä»¥è®©cpuå’Œgpuæœ‰ä¸ªå®Œæ•´çš„16.6mså¤„ç†è¿‡ç¨‹ã€‚æœ€å¤§é™åº¦çš„å‡å°‘jankçš„å‘ç”Ÿã€‚
		
![drawing withvsync.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0a3666b07fc3468389319ecade2b817b~tplv-k3u1fbpfcp-watermark.image?)

å¼•å…¥VSyncåï¼Œæ–°çš„é—®é¢˜åˆå‡ºç°äº†ï¼šå¦‚ä¸‹å›¾ï¼š

![withé—®é¢˜.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/842b2c2ab4b1417a9f237a6ad16cd090~tplv-k3u1fbpfcp-watermark.image?)
		
**ç”±äºä¸»çº¿ç¨‹åšäº†ä¸€äº›ç›¸å¯¹å¤æ‚è€—æ—¶é€»è¾‘ï¼Œå¯¼è‡´CPUå’ŒGPUçš„å¤„ç†æ—¶é—´è¶…è¿‡16.6msï¼Œç”±äºæ­¤æ—¶back bufferå†™å…¥çš„æ˜¯Bå¸§æ•°æ®ï¼Œåœ¨äº¤æ¢bufferå‰ä¸èƒ½è¢«è¦†ç›–ï¼Œè€Œframe bufferè¢«Displayç”¨æ¥åšåˆ·æ–°ç”¨ï¼Œæ‰€ä»¥åœ¨Bå¸§å†™å…¥back bufferå®Œæˆåˆ°ä¸‹ä¸€ä¸ªVSyncä¿¡å·åˆ°æ¥ä¹‹å‰ä¸¤ä¸ªbufferéƒ½è¢«å ç”¨äº†ï¼ŒCPUæ— æ³•ç»§ç»­ç»˜åˆ¶ï¼Œè¿™æ®µæ—¶é—´å°±ä¼šè¢«ç©ºç€ï¼Œ
äºæ˜¯åˆå‡ºç°äº†ä¸‰ç¼“å­˜ã€‚**
### 3.ä¸‰bufferæ—¶ä»£
ä¸ºäº†è¿›ä¸€æ­¥ä¼˜åŒ–ç”¨æˆ·ä½“éªŒï¼ŒGoogleåœ¨åŒbufferçš„åŸºç¡€ä¸Šåˆ**å¢åŠ äº†ç¬¬ä¸‰ä¸ªbuffer**ï¼ˆGraphic Bufferï¼‰ï¼Œ
å¦‚å›¾ï¼š
		
![ä¸‰buffer.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4a16ce3c316a4e5bacc0b6ff611c9f01~tplv-k3u1fbpfcp-watermark.image?)
**æŒ‰æ—¶é—´é¡ºåº**ï¼š
- 1.ç¬¬ä¸€ä¸ªjankæ˜¯æ— æ³•é¿å…çš„ï¼Œå› ä¸º**ç¬¬ä¸€ä¸ªBå¸§å¤„ç†è¶…æ—¶ï¼ŒAå¸§è‚¯å®šæ˜¯ä¼šé‡å¤çš„**ã€‚
- 2.åœ¨ç¬¬ä¸€ä¸ªVSyncä¿¡å·æ¥æ—¶ï¼Œè™½ç„¶back bufferä»¥åŠframe bufferéƒ½è¢«å ç”¨äº†ï¼ŒCPUæ­¤æ—¶ä¼šå¯ç”¨ç¬¬ä¸‰ä¸ªGraphic Bufferï¼Œé¿å…äº†CPUçš„ç©ºé—²çŠ¶æ€ã€‚
		

**è¿™é‡Œå¯ä»¥æœ€å¤§é™åº¦é¿å…2ä¸­CPUç©ºé—²çš„æƒ…å†µï¼Œè®°ä½åªæ˜¯æœ€å¤§é™åº¦ï¼Œæ²¡æœ‰è¯´ä¸€å®šèƒ½é¿å…ã€‚**
		
é‚£åˆæœ‰äººè¦è¯´äº†ï¼Œé‚£å°±å†å¤šå¼€å‡ ä¸ªä¸å°±å¯ä»¥äº†ï¼Œæ˜¯çš„ï¼Œbufferè¶Šå¤šjankè¶Šå°‘ï¼Œä½†æ˜¯ä½ å¾—**è€ƒè™‘æ€§ä»·**æ¯”ï¼š
**3 bufferå·²ç»å¯ä»¥æœ€å¤§é™åº¦çš„é¿å…jankçš„å‘ç”Ÿäº†ï¼Œå†å¤šçš„bufferèµ·åˆ°çš„ä½œç”¨å°±å¾®ä¹å…¶å¾®ï¼Œåè€Œå› ä¸ºbufferçš„æ•°é‡å¤ªå¤šï¼Œæµªè´¹æ›´å¤šå†…å­˜ï¼Œå¾—ä¸å¿å¤±ã€‚**
bufferæ”¶ç›Šæ¯”ï¼š


> ä¸è¿‡å‡æƒ³ä¸‹å“ªå¤©ç”±äºç¡¬ä»¶çš„æ”¹è¿›ï¼Œ3 bufferå·²ç»æ»¡è¶³ä¸äº†çš„æ—¶å€™ï¼Œè°·æ­Œåˆä¼šåŠ 4 bufferï¼Œ5 buffer..è¿™éƒ½æ˜¯å¯èƒ½çš„äº‹æƒ…ã€‚


## 4.Choreographer
å‰é¢æˆ‘ä»¬åˆ†æâ€œåŒbufferæ—¶ä»£â€œè¯´è¿‡ï¼š**è°·æ­Œåœ¨4.1ä¹‹åå¯¹å±å¹•ç»˜åˆ¶ä¸åˆ·æ–°è¿‡ç¨‹å¼•å…¥äº†Project Butterï¼ˆé»„æ²¹å·¥ç¨‹ï¼‰ï¼Œç³»ç»Ÿåœ¨æ”¶åˆ°VSyncä¿¡å·ä¹‹åï¼Œé©¬ä¸Šè¿›è¡ŒCPUçš„ç»˜åˆ¶ä»¥åŠGPUçš„bufferå†™å…¥**ã€‚è¿™æ ·å°±å¯ä»¥è®©cpuå’Œgpuæœ‰ä¸ªå®Œæ•´çš„16.6mså¤„ç†è¿‡ç¨‹ã€‚æœ€å¤§é™åº¦çš„å‡å°‘jankçš„å‘ç”Ÿã€‚
	
`é‚£ä¹ˆåœ¨Androidæºç å±‚æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ`
	
é‚£å°±æ˜¯è¿™å°èŠ‚è¦è®²è§£çš„Choreographerï¼Œè¯‘ä¸ºç¼–èˆè€…ï¼Œå¤šä¹ˆå”¯ç¾çš„è¯ï¼Œçœ‹æ¥å†™è¿™ä¸ªæºç çš„å¼€å‘è€…ä¹Ÿæ˜¯ä¸ªå¾ˆä¼˜é›…çš„ç»…å£«ã€‚
	
**Choreographeråœ¨å±å¹•ç»˜åˆ¶ä¸­çš„ä½œç”¨ï¼š**
- 1.æ³¨å†ŒVSyncä¿¡å·å›è°ƒ
- 2.æ¥æ”¶SurfaceFlingeræœåŠ¡å›è°ƒçš„onSyncäº‹ä»¶ï¼ŒSurfaceFlingeræœåŠ¡åœ¨æ¥æ”¶åˆ°ç¡¬ä»¶å‘å‡ºçš„å®šæ—¶ä¸­æ–­ä¿¡å·VSyncåï¼Œå°†ä¿¡å·ä¼ é€’ç»™Appï¼Œè¿™é‡ŒAppçš„æ¥æ”¶è€…å°±æ˜¯1ä¸­æ³¨å†Œçš„å›è°ƒã€‚
		ä¸€èˆ¬SurfaceFlingeræœåŠ¡æ¥æ”¶åˆ°çš„ä¸­æ–­ä¿¡å·VSyncå’ŒAppæ”¶åˆ°çš„VSyncå›è°ƒæ˜¯æœ‰ä¸ªoffsetsçš„ã€‚
	

**ä¸‹é¢å°±æ¥çœ‹ä¸‹Choreographeråœ¨æºç å±‚çš„å·¥ä½œåŸç†ï¼š**

**é¦–å…ˆå£°æ˜å½“å‰ä½¿ç”¨çš„æ˜¯8.0çš„æºç **

### 1.æºç å…¥å£scheduleTraversalsï¼š
æˆ‘ä»¬çŸ¥é“ä¸€ä¸ªViewåœ¨æ·»åŠ åˆ°çª—å£ä¸­æ—¶ï¼Œç»˜åˆ¶æµç¨‹ä¼šè°ƒç”¨åˆ°ViewRootImplçš„setView()æ–¹æ³•ï¼ŒsetViewæ–¹æ³•ä¼šè°ƒç”¨requestLayout()æ–¹æ³•è¯·æ±‚ç»˜åˆ¶ï¼ŒrequestLayoutæ–¹æ³•ä¸­ä¼šè°ƒç”¨scheduleTraversals()æ–¹æ³•ï¼Œ**é‚£å°±ä»scheduleTraversalså¼€å§‹å§ã€‚**
	

```java
void scheduleTraversals() {
		//è¿™ä¸ªå­—æ®µä¿è¯è¯¥Viewå·²ç»ç»˜åˆ¶è¿‡ï¼Œä¸ä¼šé‡å¤ç»˜åˆ¶
        if (!mTraversalScheduled) {
            mTraversalScheduled = true;
			//æ·»åŠ äº†ä¸€ä¸ªåŒæ­¥å±éšœï¼Œä¿è¯å¼‚æ­¥ç»˜åˆ¶æ¶ˆæ¯ä¼˜å…ˆæ‰§è¡Œ
            mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();
			//postä¸€ä¸ªç»˜åˆ¶çš„Runnableä»»åŠ¡ï¼Œå³Viewçš„layout/measure/drawæµç¨‹ä»¥åŠåç»­çš„GPUåˆæˆæµç¨‹ã€‚
            mChoreographer.postCallback(
                    Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, null);
            if (!mUnbufferedInputDispatch) {
                scheduleConsumeBatchedInput();
            }
            notifyRendererOfFramePending();
            pokeDrawLockIfNeeded();
        }
    }
	
	final TraversalRunnable mTraversalRunnable = new TraversalRunnable();
	
	final class TraversalRunnable implements Runnable {
        @Override
        public void run() {
            doTraversal();
        }
    }
	
    void doTraversal() {
		//å·²ç»ç»˜åˆ¶è¿‡ï¼Œæ‰ä¼šèµ°åˆ°å†…éƒ¨
        if (mTraversalScheduled) {
            mTraversalScheduled = false;
			//ç§»é™¤åŒæ­¥å±éšœ
            mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier);

            if (mProfile) {
                Debug.startMethodTracing("ViewAncestor");
            }
			//å¼€å§‹æ‰§è¡ŒperformTraversals
            performTraversals();

            if (mProfile) {
                Debug.stopMethodTracing();
                mProfile = false;
            }
        }
    }
```

scheduleTraversalsæ–¹æ³•ä¸»è¦åšäº†ä¸‹é¢äº‹æƒ…ï¼š	
- 1.å…ˆæ£€æŸ¥mTraversalScheduledæ˜¯å¦å·²ç»ç»˜åˆ¶è¿‡ï¼Œæ²¡æœ‰ç»˜åˆ¶è¿‡ç»§ç»­èµ°ä¸‹é¢æµç¨‹ï¼Œå¹¶å°†mTraversalScheduledæ ‡å¿—ç½®ä¸ºtrueï¼Œé˜²æ­¢é‡å¤ç»˜åˆ¶
- 2.è°ƒç”¨å½“å‰Handlerçš„Looperçš„MessageQueueçš„postSyncBarrierï¼Œè®¾ç½®ä¸€ä¸ª**åŒæ­¥å±éšœ**ã€‚
- 3.ä½¿ç”¨mChoreographerå‘é€ä¸€ä¸ªChoreographer.CALLBACK_TRAVERSALçš„ä»»åŠ¡ã€‚
	

è¿›å…¥mChoreographer.postCallbackæ–¹æ³•é‡Œé¢çœ‹çœ‹ï¼š

### 2.ä»»åŠ¡æäº¤postCallback
postCallbackæœ€ç»ˆä¼šè°ƒç”¨åˆ°postCallbackDelayedInternalæ–¹æ³•.

```java
private void postCallbackDelayedInternal(int callbackType,..) {
         ...
         synchronized (mLock) {
    final long now = SystemClock.uptimeMillis();
    final long dueTime = now + delayMillis;
    //å°†actionå°è£…åˆ°ä¸€ä¸ªCallBackRecordä¸­å¹¶æ”¾åˆ°mCallbackQueuesçš„callbackTypeç´¢å¼•å¤„
    mCallbackQueues[callbackType].addCallbackLocked(dueTime, action, token);

    if (dueTime <= now) {
        //è¡¨ç¤ºdelayMillis=0 ç«‹å³æ‰§è¡Œ
        scheduleFrameLocked(now);
    } else {
        //å‘é€ä¸€ä¸ªå¼‚æ­¥å»¶è¿Ÿä»»åŠ¡msg.what = MSG_DO_SCHEDULE_CALLBACK,action = mTraversalRunnableï¼Œ
        //è¿™é‡Œç»è¿‡Handleråæœ€ç»ˆä¹Ÿä¼šæ‰§è¡Œåˆ°scheduleFrameLocked
        Message msg = mHandler.obtainMessage(MSG_DO_SCHEDULE_CALLBACK, action);
        msg.arg1 = callbackType;
        msg.setAsynchronous(true);
        mHandler.sendMessageAtTime(msg, dueTime);
    }
}
}
```
postCallbackDelayedInternalåšäº†ä¸‹é¢è¿™äº›äº‹æƒ…ï¼š

- 1.å°†actionå°è£…åˆ°ä¸€ä¸ªCallBackRecordä¸­å¹¶æ”¾åˆ°mCallbackQueuesçš„callbackTypeç´¢å¼•å¤„
- 2.å¦‚æœæ˜¯ç«‹å³æ‰§è¡Œçš„æ¶ˆæ¯ï¼Œåˆ™ç›´æ¥è°ƒç”¨scheduleFrameLocked
- 3.å¦‚æœæ˜¯å»¶è¿Ÿæ¶ˆæ¯ï¼Œåˆ™å‘é€ä¸€ä¸ªMSG_DO_SCHEDULE_CALLBACKçš„msg

æˆ‘ä»¬æ¥çœ‹ä¸‹MSG_DO_SCHEDULE_CALLBACKçš„Handleré€»è¾‘ï¼š

è¿™é‡ŒmHandler = FrameHandlerç±»å¯¹è±¡
	
```java
private final class FrameHandler extends Handler {
public FrameHandler(Looper looper) {
    super(looper);
}

@Override
public void handleMessage(Message msg) {
    switch (msg.what) {
        case MSG_DO_FRAME:
            doFrame(System.nanoTime(), 0);
            break;
        case MSG_DO_SCHEDULE_VSYNC:
            doScheduleVsync();
            break;
        case MSG_DO_SCHEDULE_CALLBACK:
            doScheduleCallback(msg.arg1);
            break;
    }
}
```

MSG_DO_SCHEDULE_CALLBACKçš„æ¶ˆæ¯ç±»å‹ä¼šèµ°åˆ°doScheduleCallbackï¼Œmsg.arg1 = callbackTypeï¼Œ

è¿›å…¥doScheduleCallbackæ–¹æ³•ï¼š

```java
void doScheduleCallback(int callbackType) {
    synchronized (mLock) {
        if (!mFrameScheduled) {
            final long now = SystemClock.uptimeMillis();
            if (mCallbackQueues[callbackType].hasDueCallbacksLocked(now)) {
                scheduleFrameLocked(now);
            }
        }
    }
}
```

åˆ¤æ–­mCallbackQueues[callbackType]æ˜¯å¦æœ‰éœ€è¦ä»»åŠ¡ã€‚æœ‰ä»»åŠ¡åˆ™æ‰§è¡ŒscheduleFrameLocked
**	
å¯ä»¥çœ‹åˆ°postCallbackDelayedInternalæœ€ç»ˆéƒ½æ˜¯æ‰§è¡ŒscheduleFrameLockedæ–¹æ³•**
	
ç›´æ¥çœ‹scheduleFrameLockedæ–¹æ³•

### 3.å›è°ƒæ³¨å†ŒscheduleVsync
```java
private void scheduleFrameLocked(long now) {
    //æ£€æµ‹mFrameScheduledæ˜¯å¦å·²ç»ä¸ºtrue
    if (!mFrameScheduled) {
            mFrameScheduled = true;
            //æ˜¯å¦å¼€å¯äº†VSYNCï¼Œ4.1ä¹‹åé»˜è®¤å¼€å¯ï¼Œç›´æ¥çœ‹è¿™é‡Œå³å¯
            if (USE_VSYNC) {
                    if (DEBUG_FRAMES) {
                            Log.d(TAG, "Scheduling next frame on vsync.");
                    }

                    // If running on the Looper thread, then schedule the vsync immediately,
                    // otherwise post a message to schedule the vsync from the UI thread
                    // as soon as possible.
                    //å¦‚æœæ˜¯åœ¨ä¸»çº¿ç¨‹ä¸Šï¼Œåˆ™ç›´æ¥è°ƒç”¨scheduleVsyncLocked
                    if (isRunningOnLooperThreadLocked()) {
                            scheduleVsyncLocked();
                    } else {
                            //å…¶ä»–çº¿ç¨‹åˆ™éœ€è¦ä½¿ç”¨Handlerå°†ä»»åŠ¡æ‰§è¡Œåœ¨ä¸»çº¿ç¨‹ä¸­ã€‚
                            Message msg = mHandler.obtainMessage(MSG_DO_SCHEDULE_VSYNC);
                            msg.setAsynchronous(true);
                            mHandler.sendMessageAtFrontOfQueue(msg);
                    }
            } else {
                    final long nextFrameTime = Math.max(
                                    mLastFrameTimeNanos / TimeUtils.NANOS_PER_MS + sFrameDelay, now);
                    if (DEBUG_FRAMES) {
                            Log.d(TAG, "Scheduling next frame in " + (nextFrameTime - now) + " ms.");
                    }
                    Message msg = mHandler.obtainMessage(MSG_DO_FRAME);
                    msg.setAsynchronous(true);
                    mHandler.sendMessageAtTime(msg, nextFrameTime);
            }
    }
}
```

- 1.æ£€æµ‹mFrameScheduledæ˜¯å¦å·²ç»ä¸ºtrue
- 2.å¦‚æœå¼€å¯äº†VSYNCåˆ™è°ƒç”¨scheduleVsyncLockedæ–¹æ³•ï¼Œæ²¡æœ‰å¼€å¯åˆ™å‘é€ä¸€ä¸ªMSG_DO_FRAMEçš„msgç»™mHandlerã€‚Android 4.1ä¹‹åé»˜è®¤å¼€å¯äº†VSYNCï¼Œæ‰€ä»¥ç›´æ¥çœ‹USE_VSYNCæµç¨‹å³å¯
- 3.å¦‚æœæ˜¯è¿è¡Œåœ¨å½“å‰çº¿ç¨‹çš„ä¸Šï¼Œå½“å‰çº¿ç¨‹æ˜¯UIçº¿ç¨‹ã€‚åˆ™ç›´æ¥è°ƒç”¨scheduleVsyncLockedæ–¹æ³•ã€‚
- 4.å¦‚æœæ²¡æœ‰è¿è¡Œåœ¨ä¸»çº¿ç¨‹ä¸Šï¼Œ åˆ™å‘é€ä¸€ä¸ªMSG_DO_SCHEDULE_VSYNCçš„msgç»™mHandlerã€‚æ ¹æ®FrameHandlerçš„æºç å¯ä»¥çœ‹å‡ºæœ€ç»ˆä¹Ÿæ˜¯èµ°åˆ°scheduleVsyncLockedæ–¹æ³•
	

çœ‹scheduleVsyncLockedæ–¹æ³•ï¼š

```java
private void scheduleVsyncLocked() {
    mDisplayEventReceiver.scheduleVsync();
}
    è¿™ä¸ªmDisplayEventReceiveræ˜¯ä»€ä¹ˆæ—¶å€™èµ‹å€¼çš„å‘¢ã€‚
    æˆ‘ä»¬æ¥çœ‹Choreographerçš„æ„é€ æ–¹æ³•ï¼š
    private Choreographer(Looper looper, int vsyncSource) {
    //è®¾ç½®looper
    mLooper = looper;
    //åˆ›å»ºmHandlerå®ä¾‹
    mHandler = new FrameHandler(looper);
    //4.1é»˜è®¤å¼€å¯ï¼Œæ‰€ä»¥ç›´æ¥ä½¿ç”¨çš„æ˜¯FrameDisplayEventReceiverç±»å¯¹è±¡
    mDisplayEventReceiver = USE_VSYNC
            ? new FrameDisplayEventReceiver(looper, vsyncSource)
            : null;
    mLastFrameTimeNanos = Long.MIN_VALUE;

    mFrameIntervalNanos = (long)(1000000000 / getRefreshRate());

    //åˆå§‹åŒ–ä¸€ä¸ªCallbackQueueæ•°ç»„å¯¹è±¡
    mCallbackQueues = new CallbackQueue[CALLBACK_LAST + 1];
    for (int i = 0; i <= CALLBACK_LAST; i++) {
        mCallbackQueues[i] = new CallbackQueue();
    }
}
```
å›åˆ°scheduleVsyncLockedæ–¹æ³•ï¼šè°ƒç”¨äº†mDisplayEventReceiver.scheduleVsync()ï¼ŒmDisplayEventReceiveræ˜¯FrameDisplayEventReceiverç±»å¯¹è±¡
	
è¿›å…¥FrameDisplayEventReceiverç±»scheduleVsyncæ–¹æ³•ä¸­,å­ç±»æœªå®ç°ï¼Œåœ¨å…¶çˆ¶ç±»DisplayEventReceiverä¸­å®ç°

```java
public void scheduleVsync() {
    if (mReceiverPtr == 0) {
        Log.w(TAG, "Attempted to schedule a vertical sync pulse but the display event "
                + "receiver has already been disposed.");
    } else {
        nativeScheduleVsync(mReceiverPtr);
    }
}

    public DisplayEventReceiver(Looper looper, int vsyncSource) {
    if (looper == null) {
        throw new IllegalArgumentException("looper must not be null");
    }

    mMessageQueue = looper.getQueue();
    //è¿™ä¸ªæ–¹æ³•ä¼šå°†å½“å‰å¯¹è±¡this = mDisplayEventReceiverä»¥åŠmMessageQueueï¼ŒvsyncSourceä¼ é€’ç»™nativeå±‚å¯¹è±¡ï¼Œå¹¶è¿”å›nativeå±‚å¯¹è±¡çš„åœ°å€å€¼mReceiverPtr
    mReceiverPtr = nativeInit(new WeakReference<DisplayEventReceiver>(this), mMessageQueue,
            vsyncSource);

    mCloseGuard.open("dispose");
}
```

scheduleVsyncä¸­è°ƒç”¨çš„æ˜¯nativeScheduleVsyncæ–¹æ³•è¿›è¡Œæ³¨å†Œï¼Œ**æ³¨å†Œçš„æ˜¯ä¸€ä¸ªmReceiverPtr**ï¼Œ**è¿™æ˜¯ä¸€ä¸ªnativeå±‚çš„å¯¹è±¡åœ°å€ï¼Œè¿™ä¸ªåœ°å€æ˜¯åœ¨DisplayEventReceiveræ„é€ æ–¹æ³•ä¸­åˆå§‹åŒ–ï¼Œè°ƒç”¨nativeInitæ–¹æ³•è¿”å›çš„**ï¼Œ**nativeInitæ–¹æ³•ä¼ å…¥ä¸€ä¸ªthisï¼Œè¿™ä¸ªthiså°±æ˜¯å‰é¢çš„mDisplayEventReceiverå¯¹è±¡**ï¼Œæ‰€ä»¥é‡æ–°å›åˆ°å‰é¢çš„mDisplayEventReceiverè®²è§£ï¼Œ
	
	
```java
private final class FrameDisplayEventReceiver extends DisplayEventReceiver
        implements Runnable {
    private boolean mHavePendingVsync;
    private long mTimestampNanos;
    private int mFrame;

    public FrameDisplayEventReceiver(Looper looper, int vsyncSource) {
        super(looper, vsyncSource);
    }

    @Override
    public void onVsync(long timestampNanos, int builtInDisplayId, int frame) {
                    ...           
        mFrame = frame;
        Message msg = Message.obtain(mHandler, this);
        msg.setAsynchronous(true);
        mHandler.sendMessageAtTime(msg, timestampNanos / TimeUtils.NANOS_PER_MS);
    }

    @Override
    public void run() {
        mHavePendingVsync = false;
        doFrame(mTimestampNanos, mFrame);
    }
}
```

**FrameDisplayEventReceiverç±»å®ç°äº†onVsyncæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯nativeå±‚åœ¨æ¥æ”¶åˆ°VSyncä¿¡å·åå›è°ƒçš„æ–¹æ³•ã€‚onVsyncæ–¹æ³•ç›´æ¥å‘é€ä¸€ä¸ªå¼‚æ­¥æ¶ˆæ¯ï¼Œæ‰§è¡Œçš„ä»»åŠ¡æ˜¯è‡ªå·±çš„runæ–¹æ³•**ã€‚

runä¸­æ‰§è¡ŒdoFrame()ï¼Œè¿›å…¥doFrameçœ‹çœ‹ï¼š

### 4.å›¾å¸§ç»˜åˆ¶doFrame
```java
void doFrame(long frameTimeNanos, int frame) {
    ...
    try {
        Trace.traceBegin(Trace.TRACE_TAG_VIEW, "Choreographer#doFrame");
        AnimationUtils.lockAnimationClock(frameTimeNanos / TimeUtils.NANOS_PER_MS);

        mFrameInfo.markInputHandlingStart();
                    //å¤„ç†è¾“å…¥äº‹ä»¶
        doCallbacks(Choreographer.CALLBACK_INPUT, frameTimeNanos);

        mFrameInfo.markAnimationsStart();
                    //å¤„ç†åŠ¨ç”»äº‹ä»¶
        doCallbacks(Choreographer.CALLBACK_ANIMATION, frameTimeNanos);

        mFrameInfo.markPerformTraversalsStart();
                    //å¤„ç†CALLBACK_TRAVERSALï¼Œä¸‰å¤§ç»˜åˆ¶æµç¨‹
        doCallbacks(Choreographer.CALLBACK_TRAVERSAL, frameTimeNanos);
                    //å¤„ç†CALLBACK_COMMITäº‹ä»¶
        doCallbacks(Choreographer.CALLBACK_COMMIT, frameTimeNanos);
    } finally {
        AnimationUtils.unlockAnimationClock();
        Trace.traceEnd(Trace.TRACE_TAG_VIEW);
    }
    ...
}
```

doFrameä¸­ï¼š
- **1.æ‰§è¡Œè¾“å…¥äº‹ä»¶**
- **2.å¤„ç†åŠ¨ç”»äº‹ä»¶**
- **3.å¤„ç†CALLBACK_TRAVERSALï¼Œä¸‰å¤§ç»˜åˆ¶æµç¨‹ï¼Œå…¶å®å°±æ˜¯å‰é¢çš„mTraversalRunnableäº‹ä»¶**
- **4.å¤„ç†CALLBACK_COMMITæäº¤å¸§äº‹ä»¶**
	

è¿›å…¥doCallbacksæ–¹æ³•ï¼š

```java
void doCallbacks(int callbackType, long frameTimeNanos) {
    for (CallbackRecord c = callbacks; c != null; c = c.next) {
            if (DEBUG_FRAMES) {
                    Log.d(TAG, "RunCallback: type=" + callbackType
                                    + ", action=" + c.action + ", token=" + c.token
                                    + ", latencyMillis=" + (SystemClock.uptimeMillis() - c.dueTime));
            }
            c.run(frameTimeNanos);
    }
}
```
å¾ªç¯æ‰§è¡Œcallbacksä¸­çš„è®°å½•ï¼š

```java
private static final class CallbackRecord {
    public CallbackRecord next;
    public long dueTime;
    public Object action; // Runnable or FrameCallback
    public Object token;

    public void run(long frameTimeNanos) {
        if (token == FRAME_CALLBACK_TOKEN) {
            ((FrameCallback)action).doFrame(frameTimeNanos);
        } else {
            ((Runnable)action).run();
        }
    }
}
```


â€‹	
CallbackRecordçš„runæ–¹æ³•åœ¨token = nullçš„æƒ…å†µä¸‹æ‰§è¡Œçš„æ˜¯actionçš„runæ–¹æ³•
è¿™é‡Œå†çœ‹

```java
mChoreographer.postCallback(Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, null);
```
**ä¼ å…¥çš„tokenç¡®å®ä¸ºnullï¼Œä¸”action = mTraversalRunnable**ï¼Œ

**`è¿™æ ·æ•´ä¸ªå¤„ç†æµç¨‹å°±é—­ç¯äº†ã€‚`**
	
**è¿™é‡Œtoken = FRAME_CALLBACK_TOKENæ˜¯åœ¨ä»€ä¹ˆæƒ…å†µä¸‹å‘¢ï¼Ÿ**
### 5.å¸§ç‡è®¡ç®—postFrameCallback
åœ¨Choreographerçš„postFrameCallbackæ–¹æ³•ä¸­ï¼š

```java
public void postFrameCallback(FrameCallback callback) {
        postFrameCallbackDelayed(callback, 0);
}

public void postFrameCallbackDelayed(FrameCallback callback, long delayMillis) {
    if (callback == null) {
        throw new IllegalArgumentException("callback must not be null");
    }

    postCallbackDelayedInternal(CALLBACK_ANIMATION,
            callback, FRAME_CALLBACK_TOKEN, delayMillis);
}
```


æœ€ç»ˆä¹Ÿæ˜¯æ‰§è¡Œåˆ°postCallbackDelayedInternalæ–¹æ³•ï¼Œä¸åŒä¹‹å¤„åœ¨äºï¼Œå…¶ä¼ å…¥çš„tokenæ˜¯FRAME_CALLBACK_TOKEN

é‚£ä¹ˆè¿™ä¸ªæ–¹æ³•æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ**è®¡ç®—ä¸¢å¸§**ã€‚

æˆ‘ä»¬ä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•å¯¹ä¸¢ä¸¢å¸§30æ¬¡ä»¥ä¸Šåœ¨logcatä¸­æ‰“å°ä¸€ä¸ªæ—¥å¿—ã€‚
	

- 1.åˆ›å»ºä¸€ä¸ªFrameCallbackå­ç±»

```java
public class YourFrameCallback implements Choreographer.FrameCallback {

  private static final String TAG = "FPS_TEST";
  private long mLastFrameTimeNanos = 0;
  private long mFrameIntervalNanos;

  public YourFrameCallback(long lastFrameTimeNanos) {
      mLastFrameTimeNanos = lastFrameTimeNanos;
      mFrameIntervalNanos = (long)(1000000000 / 60.0);
  }

  @Override
  public void doFrame(long frameTimeNanos) {

      //åˆå§‹åŒ–æ—¶é—´
      if (mLastFrameTimeNanos == 0) {
          mLastFrameTimeNanos = frameTimeNanos;
      }
      final long jitterNanos = frameTimeNanos - mLastFrameTimeNanos;
      if (jitterNanos >= mFrameIntervalNanos) {
          final long skippedFrames = jitterNanos / mFrameIntervalNanos;
          if(skippedFrames>30){
              //ä¸¢å¸§30ä»¥ä¸Šlogcatæ‰“å°æ—¥å¿—
              Log.i(TAG, "Skipped " + skippedFrames + " frames!  "
                      + "The application may be doing too much work on its main thread.");
          }
      }
      mLastFrameTimeNanos=frameTimeNanos;
      //å› ä¸ºæ¯æ¬¡doFrameéƒ½ä¼šæ¶ˆè´¹æ‰ï¼Œéœ€è¦é‡æ–°æ³¨å†Œä¸‹ä¸€å¸§å›è°ƒ
      Choreographer.getInstance().postFrameCallback(this);
  }
}
```
- 2.åœ¨Applicationå¯åŠ¨çš„æ—¶å€™ï¼šè°ƒç”¨Choreographerçš„postFrameCallbackæ–¹æ³•ï¼Œå¹¶ä¼ å…¥ä¸€ä¸ªFrameCallback

```java
Choreographer.getInstance().postFrameCallback(new YourFrameCallback(System.nanoTime()));
```


**å¯¹è¿™å°èŠ‚æ€»ç»“**ï¼š
- 1.åœ¨Choreographerçš„æ„é€ å‡½æ•°ä¸­ä¼šåˆ›å»ºä¸€ä¸ªFrameDisplayEventReceiverç±»å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å®ç°äº†onVSyncæ–¹æ³•ï¼Œç”¨äºVSyncä¿¡å·å›è°ƒã€‚
- 2.FrameDisplayEventReceiverè¿™ä¸ªå¯¹è±¡çš„çˆ¶ç±»æ„é€ æ–¹æ³•ä¸­ä¼šè°ƒç”¨nativeInitæ–¹æ³•å°†å½“å‰FrameDisplayEventReceiverå¯¹è±¡ä¼ é€’ç»™nativeå±‚ï¼Œnativeå±‚è¿”å›ä¸€ä¸ªåœ°å€mReceiverPtrç»™ä¸Šå±‚ã€‚
- 3.ä¸»çº¿ç¨‹åœ¨scheduleVsyncæ–¹æ³•ä¸­è°ƒç”¨nativeScheduleVsyncï¼Œå¹¶ä¼ å…¥2ä¸­è¿”å›çš„mReceiverPtrï¼Œè¿™æ ·å°±åœ¨nativeå±‚å°±æ­£å¼æ³¨å†Œäº†ä¸€ä¸ªFrameDisplayEventReceiverå¯¹è±¡ã€‚
- 4.nativeå±‚åœ¨GPUçš„é©±ä½¿ä¸‹ä¼šå®šæ—¶å›è°ƒFrameDisplayEventReceiverçš„onVSyncæ–¹æ³•ï¼Œä»è€Œå®ç°äº†ï¼šåœ¨VSyncä¿¡å·åˆ°æ¥æ—¶ï¼Œç«‹å³æ‰§è¡ŒdoFrameæ–¹æ³•
- 5.doFrameæ–¹æ³•ä¸­ä¼šæ‰§è¡Œè¾“å…¥äº‹ä»¶ï¼ŒåŠ¨ç”»äº‹ä»¶ï¼Œlayout/measure/drawæµç¨‹å¹¶æäº¤æ•°æ®ç»™GPUã€‚è¿™æ ·å°±é—­ç¯äº†
	
	

ç»˜åˆ¶æµç¨‹å›¾å¦‚ä¸‹ï¼šæ¥è‡ªã€Š[Android ä¹‹ Choreographer è¯¦ç»†åˆ†æ](https://www.jianshu.com/p/86d00bbdaf60)ã€‹
	
![Android ä¹‹ Choreographer è¯¦ç»†åˆ†æ.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b1576c3cab964dfda06881f3ca2acd82~tplv-k3u1fbpfcp-watermark.image?)
	
## 5.HandleråŒæ­¥å±éšœæœºåˆ¶
æ ¸å¿ƒæ€æƒ³ï¼š**åœ¨ä¸»çº¿ç¨‹Looperè·å–msgçš„æ—¶å€™ï¼Œè®©å¼‚æ­¥æ¶ˆæ¯ä¼˜å…ˆæ‰§è¡Œï¼ŒåŒæ­¥æ¶ˆæ¯æ»å**ã€‚

è¿™é‡Œå…ˆä¸Šä¸€å¼ åŸç†å›¾ï¼š
	
![åŒæ­¥æœºåˆ¶.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/778afe9baca44fc0aee2977912bbc3f4~tplv-k3u1fbpfcp-watermark.image?)
æˆ‘ä»¬ä¾æ¬¡å¯¹å›¾ä¸­å‡ ä¸ªç‚¹è¿›è¡Œæºç è®²è§£ï¼š
- 1.åŒæ­¥å±éšœçš„åˆ›å»º
- 2.å¼‚æ­¥æ¶ˆæ¯çš„ä¼˜å…ˆæ‰§è¡Œ
	
### 1.åŒæ­¥å±éšœçš„åˆ›å»º
ä½¿ç”¨çš„æ˜¯:MessageQueue#postSyncBarrier()

```java
/**
 * åŒæ­¥å±éšœå°±æ˜¯ä¸€ä¸ªåŒæ­¥æ¶ˆæ¯ï¼Œåªä¸è¿‡è¿™ä¸ªæ¶ˆæ¯çš„targetä¸ºnull
 */
private int postSyncBarrier(long when) {
        // Enqueue a new sync barrier token.
        // We don't need to wake the queue because the purpose of a barrier is to stall it.
        synchronized (this) {
            final int token = mNextBarrierToken++;
            // ä»æ¶ˆæ¯æ± ä¸­è·å–Message
            final Message msg = Message.obtain();
            msg.markInUse();
            // åˆå§‹åŒ–Messageå¯¹è±¡çš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰ç»™Message.targetèµ‹å€¼ï¼Œ
            // å› æ­¤Message.target==null
            msg.when = when;
            msg.arg1 = token;

            Message prev = null;
            Message p = mMessages;
            if (when != 0) {
                // è¿™é‡Œçš„whenæ˜¯è¦åŠ å…¥çš„Messageçš„æ—¶é—´
                // è¿™é‡Œéå†æ˜¯æ‰¾åˆ°Messageè¦åŠ å…¥çš„ä½ç½®
                while (p != null && p.when <= when) {
                        // å¦‚æœå¼€å¯åŒæ­¥å±éšœçš„æ—¶é—´ï¼ˆå‡è®¾è®°ä¸ºTï¼‰Tä¸ä¸º0ï¼Œä¸”å½“å‰çš„åŒæ­¥
                        // æ¶ˆæ¯é‡Œæœ‰æ—¶é—´å°äºTï¼Œåˆ™prevä¹Ÿä¸ä¸ºnull
                        prev = p;
                        p = p.next;
                }
            }
            // æ ¹æ®prevæ˜¯å¦ä¸ºnullï¼Œå°†msgæŒ‰ç…§æ—¶é—´é¡ºåºæ’å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„åˆé€‚ä½ç½®
            if (prev != null) { // invariant: p == prev.next
                msg.next = p;
                prev.next = msg;
            } else {
                msg.next = p;
                mMessages = msg;
            }
            return token;
        }
}
```

æ³¨é‡Šä¸­æœ‰è¯´æ˜äº†ï¼Œ**è¿™é‡Œçš„å±éšœæ¶ˆæ¯å°±æ˜¯ä¸€ä¸ªtargetä¸ºnullçš„æ¶ˆæ¯ï¼Œå› ä¸ºå…¶ä¸éœ€è¦æ‰§è¡Œä»»åŠ¡æ¶ˆæ¯ï¼Œåªæ˜¯ç”¨æ¥è®¾ç½®ä¸€å µå¢™**.

å†æ ¹æ®æ—¶é—´æˆ³å°†å…¶æ’å…¥åˆ°åˆé€‚çš„ä½ç½®ã€‚
	
### 2.å¼‚æ­¥æ¶ˆæ¯çš„ä¼˜å…ˆæ‰§è¡Œ
ç§»æ­¥åˆ°ï¼šMessageQueueçš„nextæ–¹æ³•ï¼š

```java
Message next() {
    ...

    int pendingIdleHandlerCount = -1; // -1 only during first iteration
    // 1.å¦‚æœnextPollTimeoutMillis=-1ï¼Œä¸€ç›´é˜»å¡ä¸ä¼šè¶…æ—¶
    // 2.å¦‚æœnextPollTimeoutMillis=0ï¼Œä¸ä¼šé˜»å¡ï¼Œç«‹å³è¿”å›
    // 3.å¦‚æœnextPollTimeoutMillis>0ï¼Œæœ€é•¿é˜»å¡nextPollTimeoutMillisæ¯«ç§’ï¼ˆè¶…æ—¶ï¼‰
    int nextPollTimeoutMillis = 0;
    for (;;) {
        if (nextPollTimeoutMillis != 0) {
                Binder.flushPendingCommands();
        }

        nativePollOnce(ptr, nextPollTimeoutMillis);

        synchronized (this) {
            // è·å–ç³»ç»Ÿå¼€æœºåˆ°ç°åœ¨çš„æ—¶é—´æˆ³
            final long now = SystemClock.uptimeMillis();
            Message prevMsg = null;
            Message msg = mMessages;
            // å–å‡ºtarget==nullçš„æ¶ˆæ¯
            // å¦‚æœtarget==nullï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯å±éšœï¼Œéœ€è¦å¾ªç¯éå†ï¼Œ
            // ä¸€ç›´å¾€åæ‰¾åˆ°ç¬¬ä¸€ä¸ªå¼‚æ­¥æ¶ˆæ¯ï¼Œå³msg.isAsynchronous()ä¸ºtrue
            // è¿™ä¸ªtarget==nullçš„æ¶ˆæ¯ï¼Œä¸ä¼šè¢«å–å‡ºå¤„ç†ï¼Œä¸€ç›´ä¼šå­˜åœ¨
            // æ¯æ¬¡å¤„ç†å¼‚æ­¥æ¶ˆæ¯çš„æ—¶å€™ï¼Œéƒ½ä¼šä»å¤´å¼€å§‹è½®è¯¢
            // éƒ½éœ€è¦ç»å†ä»msg.targetå¼€å§‹çš„éå†
            if (msg != null && msg.target == null) {
                    // ä½¿ç”¨ä¸€ä¸ªdo..whileå¾ªç¯
                    // è½®è¯¢æ¶ˆæ¯é˜Ÿåˆ—é‡Œçš„æ¶ˆæ¯ï¼Œè¿™é‡Œä½¿ç”¨do..whileå¾ªç¯çš„åŸå› 
                    // æ˜¯å› ä¸ºdo..whileå¾ªç¯ä¸­å–å‡ºçš„è¿™ç¬¬ä¸€ä¸ªæ¶ˆæ¯æ˜¯target==nullçš„æ¶ˆæ¯
                    // è¿™ä¸ªæ¶ˆæ¯æ˜¯åŒæ­¥å±éšœçš„æ ‡å¿—æ¶ˆæ¯
                    // æ¥ä¸‹å»è¿›è¡Œéå†å¾ªç¯å–å‡ºMessage.isAsynchronous()ä¸ºtrueçš„æ¶ˆæ¯
                    // isAsynchronous()ä¸ºtrueå°±æ˜¯å¼‚æ­¥æ¶ˆæ¯
                    do {
                            prevMsg = msg;
                            msg = msg.next;
                    } while (msg != null && !msg.isAsynchronous());
            }
            if (msg != null) {
                    // å¦‚æœæœ‰æ¶ˆæ¯éœ€è¦å¤„ç†ï¼Œå…ˆåˆ¤æ–­æ—¶é—´æœ‰æ²¡æœ‰åˆ°ï¼Œå¦‚æœæ²¡æœ‰åˆ°çš„è¯è®¾ç½®é˜»å¡æ—¶é—´
                    if (now < msg.when) {
                            // è®¡ç®—å‡ºç¦»æ‰§è¡Œæ—¶é—´è¿˜æœ‰å¤šä¹…èµ‹å€¼ç»™nextPollTimeoutMillis
                            // è¡¨ç¤ºnativePollOnceæ–¹æ³•è¦ç­‰å¾…nextPollTimeoutMillisæ—¶é•¿åè¿”å›
                            nextPollTimeoutMillis = (int) Math.min(msg.when - now, Integer.MAX_VALUE);
                    } else {
                            // è·å–åˆ°æ¶ˆæ¯
                            mBlocked = false;
                            // é“¾è¡¨æ“ä½œï¼Œè·å–msgå¹¶ä¸”åˆ é™¤è¯¥èŠ‚ç‚¹
                            if (prevMsg != null) {
                                    prevMsg.next = msg.next;
                            } else {
                                    mMessages = msg.next;
                            }
                            msg.next = null;
                            if (DEBUG) Log.v(TAG, "Returning message: " + msg);
                            msg.markInUse();
                            // è¿”å›æ‹¿åˆ°çš„æ¶ˆæ¯
                            return msg;
                    }
            } else {
                    // æ²¡æœ‰æ¶ˆæ¯ï¼ŒnextPollTimeoutMilliså¤ä½
                    nextPollTimeoutMillis = -1;
            }

                ...
        }
    }
}
```

**ä¼˜å…ˆåˆ¤æ–­æ˜¯å¦æœ‰åŒæ­¥å±éšœå­˜åœ¨ï¼Œç„¶åå–åŒæ­¥å±éšœåé¢çš„å¼‚æ­¥æ¶ˆæ¯è¿›è¡Œå¤„ç†**ã€‚å°±è¾¾åˆ°äº†ä¼˜å…ˆæ‰§è¡Œå¼‚æ­¥æ¶ˆæ¯çš„ç›®çš„ã€‚
	
å¥½äº†ï¼Œå…³äºåŒæ­¥å±éšœæœºåˆ¶å°±è®²åˆ°è¿™é‡Œã€‚

æœ‰äº†ä¸Šé¢è¿™äº›åŸºç¡€è®²è§£ã€‚ä¸‹é¢å¯¹ä¸€å¼€å§‹çš„é—®é¢˜è¿›è¡Œä¸€ä¸ªæ€»ç»“å½’çº³ã€‚
	

## 6.é—®é¢˜æ€»ç»“

### 1.16.6msæ˜¯ä»€ä¹ˆæ„æ€ï¼Œæ¯æ¬¡16.6mséƒ½ä¼šè°ƒç”¨ä¸€ä¸ªç»˜åˆ¶æµç¨‹ä¹ˆï¼Ÿ
16.6msæ˜¯æŒ‡åˆ·æ–°é¢‘ç‡ä¸ºæ˜¯60HZï¼Œ1séœ€è¦æ‰§è¡Œ60æ¬¡ï¼Œå¹³å‡æ¯æ¬¡16.6msã€‚ä¹Ÿå¯ä»¥ç†è§£ä¸ºVSyncçš„ä¸€ä¸ªå‘¨æœŸæ˜¯16.6msã€‚
å¹¶éæ¯æ¬¡16.6mséƒ½ä¼šæ‰§è¡Œä¸‰å¤§ç»˜åˆ¶æµç¨‹ï¼Œå±å¹•é™æ­¢çŠ¶æ€ï¼ŒCPUå¹¶ä¸ä¼šæ‰§è¡Œç»˜åˆ¶æµç¨‹

### 2.ç”»é¢æ’•è£‚æ˜¯æ€ä¹ˆé€ æˆçš„ï¼Ÿ
ç”»é¢æ’•è£‚æ˜¯æ—©æœŸä½¿ç”¨çš„æ˜¯ä¸€ä¸ªbufferè¿›è¡Œå±å¹•çš„åˆ·æ–°è¯»å–å’ŒGPUçš„å†™å…¥æ“ä½œï¼Œä¸”ä¸å­˜åœ¨åŒæ­¥é”çš„æƒ…å†µä¸‹ï¼Œæ–°æ•°æ®è¦†ç›–æ—§çš„æ•°æ®å¯¼è‡´ä¸€å¼ ç”»é¢æ˜¾ç¤ºå¤šå¸§çš„åœºæ™¯
### 3.ä¸ºä»€ä¹ˆåœ¨ä¸»çº¿ç¨‹è€—æ—¶ï¼Œå¸ƒå±€å±‚çº§å¤ªå¤šï¼Œä¼šå‡ºç°å¡é¡¿ï¼Ÿä¸¢å¸§ï¼Ÿ
ä¸»çº¿ç¨‹è€—æ—¶ï¼Œå¸ƒå±€å±‚çº§å¤ªå¤šä¼šå½±å“CPUçš„è®¡ç®—å’ŒGPUçš„åˆæˆè¿‡ç¨‹ï¼Œè¶…è¿‡VSyncä¿¡å·åï¼Œéœ€è¦ç­‰ä¸‹ä¸€ä¸ªVSyncä¿¡å·æ¥æ‰èƒ½è¿›è¡Œbufferäº¤æ¢ï¼Œå‘ç”Ÿä¸¢å¸§ç°è±¡

### 4.ä¸¢å¸§æ˜¯ä¸ªä»€ä¹ˆæ„æ€ï¼Œæ˜¯å­—é¢ä¸Šçš„ç›´æ¥ä¸¢å¼ƒå½“å‰å¸§è¿˜æ˜¯å»¶åæ˜¾ç¤ºå½“å‰å¸§ï¼Ÿ
ä¸¢å¸§æ˜¯æŒ‡åœ¨ç¬¬ä¸€ä¸ªVSyncä¿¡å·æ¥ä¹‹å‰å¹¶æ²¡æœ‰åˆæˆå¥½back bufferæ•°æ®ï¼Œæ— æ³•äº¤æ¢bufferï¼Œå±å¹•åˆ·æ–°çš„è¿˜æ˜¯ä¸Šä¸€å¸§æ•°æ®ï¼Œè¿™å°±æ˜¯ä¸¢å¸§ã€‚
ä¸‹ä¸€ä¸ªVSyncä¿¡å·æ¥ä¹‹åï¼Œback bufferç»˜åˆ¶å¥½åï¼Œå†äº¤æ¢bufferï¼Œæ‰€ä»¥å…¶ä¸ä¼šä¸¢å¼ƒï¼Œè€Œæ˜¯å»¶åæ˜¾ç¤ºï¼Œç›´è§‚æ„Ÿå—å°±æ˜¯å¡é¡¿ã€‚

### 5.åŒç¼“å†²æ˜¯ä»€ä¹ˆï¼Ÿæœ‰äº†åŒç¼“å­˜å°±ä¸‡äº‹å¤§å‰äº†ä¹ˆï¼Ÿä¸‰ç¼“å†²å‘¢ï¼Ÿ
åŒç¼“å†²æ˜¯æŒ‡ä½¿ç”¨ä¸¤ä¸ªbufferè¿›è¡Œæ•°æ®çš„ç¼“å­˜ï¼Œä¸€ä¸ªç”¨äºGPUçš„åˆæˆï¼Œä¸€ä¸ªç”¨äºå±å¹•çš„åˆ·æ–°ï¼Œäº’ä¸å¹²æ‰°ï¼Œé˜²æ­¢å‡ºç°ç”»é¢æ’•è£‚çš„åœºæ™¯
æœ‰äº†åŒç¼“å­˜è¿˜æ˜¯ä¼šå‡ºç°ä¸¢å¸§çš„ç°è±¡å’ŒCPUçš„ç©ºé—²ç­‰é—®é¢˜ã€‚
ä¸‰ç¼“å†²å°±æ˜¯åœ¨åŒç¼“å†²ä¸Šå†å¢åŠ ä¸€ä¸ªGraphic Bufferï¼Œé¿å…CPUé•¿æ—¶é—´ç©ºé—²ã€‚
### 6.äº†è§£Vsyncä¹ˆï¼Ÿå®ƒçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ
VSyncï¼ˆå‚ç›´åŒæ­¥ï¼‰æœ‰ä¸¤ä¸ªä½œç”¨ï¼š
1.æé†’GPUè¿›è¡Œbufferçš„äº¤æ¢
2.æé†’CPUç«‹å³è¿›å…¥å±å¹•ç»˜åˆ¶è¿‡ç¨‹ï¼Œåˆ«é—²ç€å•¦ã€‚

### 7.ç¼–èˆè€…æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Ÿ
ç¼–èˆè€…Choreographeræ˜¯4.1ä»¥åå¼•å…¥çš„ï¼š
ä½œç”¨ï¼šç”¨æ¥æé†’CPUåœ¨VSyncä¿¡å·æ¥æ—¶ç«‹å³å¯¹Viewè¿›è¡Œç»˜åˆ¶ï¼Œé˜²æ­¢å‡ºç°CPUç©ºé—²çŠ¶æ€ã€‚


å¥½äº†ï¼Œå°±è®²åˆ°è¿™é‡Œå§ï¼Œä¸Šé¢æ–‡ç« æ¶‰åŠäº†ï¼š**UIç»˜åˆ¶æµç¨‹ï¼ŒHandleråŒæ­¥å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶ï¼Œå±å¹•åˆ·æ–°æµç¨‹ï¼Œå¡é¡¿ä¼˜åŒ–**ç­‰çŸ¥è¯†ç‚¹	

å¦‚æœä½ èƒ½æŠŠæœ¬æ–‡æ¶‰åŠçš„çŸ¥è¯†ç‚¹éƒ½å¸æ”¶ï¼Œå¯¹åæœŸframeworkå±‚çš„å­¦ä¹ æ˜¯å¾ˆæœ‰å¸®åŠ©çš„ã€‚

**å¦‚æœä½ å–œæ¬¢æˆ‘çš„æ–‡ç« ï¼Œè¯·å¸®å¿™ç‚¹èµï¼Œå…³æ³¨ï¼Œè¿™æ˜¯å¯¹æˆ‘çš„å·¨å¤§é¼“åŠ±ï¼**

**æ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·**ï¼š`å°ä½™çš„è‡ªä¹ å®¤`


**å‚è€ƒ**

[æ•°æ®çš„æµåŠ¨â€”â€”è®¡ç®—æœºæ˜¯å¦‚ä½•æ˜¾ç¤ºä¸€ä¸ªåƒç´ çš„](https://zhuanlan.zhihu.com/p/32136704)

[èŠèŠAndroidå±å¹•åˆ·æ–°æœºåˆ¶](https://jishuin.proginn.com/p/763bfbd577a7)

[Androidå‚ç›´åŒæ­¥ä¿¡å·VSyncçš„äº§ç”ŸåŠä¼ æ’­ç»“æ„è¯¦è§£](https://blog.csdn.net/houliang120/article/details/50908098)