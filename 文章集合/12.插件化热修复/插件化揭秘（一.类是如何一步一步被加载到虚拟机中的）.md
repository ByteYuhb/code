> ğŸ”¥ **Hiï¼Œæˆ‘æ˜¯å°ä½™ã€‚**
>
> **æœ¬æ–‡å·²æ”¶å½•åˆ° [GitHub Â· Androider-Planet](https://github.com/ByteYuhb/Androider-Planet) ä¸­ã€‚è¿™é‡Œæœ‰ Android è¿›é˜¶æˆé•¿çŸ¥è¯†ä½“ç³»ï¼Œå…³æ³¨å…¬ä¼—å· [å°ä½™çš„è‡ªä¹ å®¤] ï¼Œåœ¨æˆåŠŸçš„è·¯ä¸Šä¸è¿·è·¯ï¼**
## å‰è¨€
å‰é¢ä¸€ç¯‡æ–‡ç« æˆ‘ä»¬è®²è§£äº†å…³äº`Classæ–‡ä»¶ç±»æ–‡ä»¶ç»“æ„`ï¼Œè€ŒClassæ–‡ä»¶æœ€ç»ˆéœ€è¦åŠ è½½åˆ°è™šæ‹Ÿæœºå†…å­˜ä¸­æ‰èƒ½è¢«ä½¿ç”¨ï¼Œ
æœ¬ç« å°±æ¥è®²è§£ä¸‹ï¼Œ**Classæ–‡ä»¶è¢«åŠ è½½åˆ°è™šæ‹Ÿæœºä¸­çš„è¿‡ç¨‹**

**javaå¤©ç”Ÿå¯ä»¥åŠ¨æ€æ‰©å±•çš„è¯­è¨€ç‰¹æ€§å°±æ˜¯ä¾èµ–è¿è¡ŒæœŸåŠ¨æ€åŠ è½½å’ŒåŠ¨æ€è¿æ¥è¿™ä¸ªç‰¹æ€§å®ç°çš„ã€‚
æˆ‘ä»¬åº”ç”¨ç¨‹åºä½¿ç”¨çš„Classæ–‡ä»¶ä¸ä¸€å®šæ˜¯è¦å®‰è£…è¿è¡Œçš„apké‡Œé¢ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å­˜æ”¾åœ¨æœ¬åœ°æˆ–è€…è¿œç«¯çš„äºŒè¿›åˆ¶Classæ–‡ä»¶ã€‚**

## ç±»åŠ è½½ç”Ÿå‘½å‘¨æœŸ
ä¸€ä¸ªç±»å‹ä»è¢«åŠ è½½åˆ°è™šæ‹Ÿæœºå†…å­˜ä¸­åˆ°ä»å†…å­˜ä¸­å¸è½½éœ€è¦ç»å†ä»¥ä¸‹æ­¥éª¤ã€‚

![ç±»åŠ è½½è¿‡ç¨‹.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/97a8c4ba664444c6b2c6c21aae909146~tplv-k3u1fbpfcp-watermark.image?)
å…¶ä¸­`åŠ è½½`ï¼Œ`éªŒè¯`ï¼Œ`å‡†å¤‡`ï¼Œ`åˆå§‹åŒ–`ï¼Œ`å¸è½½`è¿™äº”ä¸ªæ­¥éª¤æ˜¯æŒ‰é¡ºåºæ‰§è¡Œçš„ï¼Œè€Œ`è§£æ`æ­¥éª¤æ˜¯ä¸ç¡®å®šçš„ï¼Œå¯èƒ½ä¼šåœ¨åˆå§‹åŒ–åæ‰§è¡Œ

ä¸‹é¢åˆ†åˆ«æ¥ä»‹ç»ä¸‹è¿™å‡ ä¸ªé˜¶æ®µ
### 1.åŠ è½½
**è¿™é‡Œè¦è¯´æ˜ä¸‹è¿™ä¸ªåŠ è½½å’Œæˆ‘ä»¬çš„â€œ`classç±»åŠ è½½`â€è¦åŒºåˆ†å¼€ï¼Œè¿™é‡Œçš„åŠ è½½åªæ˜¯ç±»åŠ è½½çš„ä¸€ä¸ªé˜¶æ®µ**ã€‚

`åŠ è½½è¿‡ç¨‹`ï¼š
 - 1.1ï¼šé€šè¿‡ç±»çš„æƒé™å®šåå»è·å–å®šä¹‰æ­¤ç±»çš„äºŒè¿›åˆ¶`class`æ–‡ä»¶å­—èŠ‚æµ
 - 1.2ï¼šå°†è¿™ä¸ªå­—èŠ‚æµæ‰€ä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æ„è½¬åŒ–ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„
 - 1.3ï¼šåœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„`Class`å¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºè¿™ä¸ªç±»çš„å„ç§æ•°æ®çš„è®¿é—®å…¥å£

javaè™šæ‹Ÿæœºè§„èŒƒå¯¹è¿™ä¸‰ç‚¹è¦æ±‚å¹¶ä¸æ˜¯ç‰¹åˆ«å…·ä½“ï¼Œ**ç¬¬ä¸€æ¡å€¼è¦æ±‚ä½¿ç”¨æƒé™å®šåå»è·å–å­—èŠ‚æµï¼Œå¹¶æ²¡æœ‰æŒ‡æ˜å­—èŠ‚æµçš„å­˜å‚¨ä½ç½®ï¼Œ
 å¯èƒ½æ˜¯åœ¨æœ¬åœ°æˆ–è€…è¿œç«¯ï¼Œè¿™é‡Œå°±ç»™å¼€å‘è€…æ‰©å±•æä¾›äº†ä¸€å®šç©ºé—´ï¼Œä¼—å¤šæ’ä»¶åŒ–ç›¸å…³æ¡†æ¶å°±æ˜¯å»ºç«‹åœ¨è¿™ä¸ªåŸºç¡€ä¸Šçš„ã€‚**

å…·ä½“å°±æ˜¯é‡å†™ä¸€ä¸ªç±»åŠ è½½å™¨ï¼Œé‡å†™`findClass`æˆ–è€…`loadClass`æ–¹æ³•å»å®ç°è‡ªå·±çš„`ClassäºŒè¿›åˆ¶æµ`è·å–æ–¹å¼ã€‚

çœ‹ä¸‹`RePlugin`æ¡†æ¶ä¸­çš„æ–¹å¼ï¼š

```java
public class RePluginClassLoader extends PathClassLoader {
	@Override
    protected Class<?> loadClass(String className, boolean resolve) throws ClassNotFoundException {
        //
        Class<?> c = null;
        c = PMF.loadClass(className, resolve);
        if (c != null) {
            return c;
        }
        //
        try {
            c = mOrig.loadClass(className);
            // åªæœ‰å¼€å¯â€œè¯¦ç»†æ—¥å¿—â€æ‰ä¼šè¾“å‡ºï¼Œé˜²æ­¢â€œåˆ·å±â€ç°è±¡
            if (LogDebug.LOG && RePlugin.getConfig().isPrintDetailLog()) {
                LogDebug.d(TAG, "loadClass: load other class, cn=" + className);
            }
            return c;
        } catch (Throwable e) {
            //
        }
        //
        return super.loadClass(className, resolve);
    }

    @Override
    protected Class<?> findClass(String className) throws ClassNotFoundException {
        // INFO Never reach here since override loadClass , unless not found class
        if (LOGR) {
            LogRelease.w(PLUGIN_TAG, "NRH lcl.fc: c=" + className);
        }
        return super.findClass(className);
    }
 }
```
### 2.è¿æ¥ï¼š`åŒ…æ‹¬éªŒè¯ï¼Œå‡†å¤‡ï¼Œè§£æ`
#### 2.1ï¼š**éªŒè¯é˜¶æ®µ**
**è¿™ä¸ªé˜¶æ®µä¸»è¦æ˜¯ä¸ºäº†æ£€æµ‹Classæ–‡ä»¶çš„å®‰å…¨æ€§å’Œåˆæ³•æ€§**
ä¸»è¦åŒ…æ‹¬å‡ ä¸‹å‡ ç§éªŒè¯æ–¹å¼ï¼š
- 1.`æ–‡ä»¶æ ¼å¼`éªŒè¯
- 2.`å…ƒæ•°æ®`éªŒè¯
- 3.`ç¬¦å·å¼•ç”¨`éªŒè¯
- 4.`å­—èŠ‚ç `éªŒè¯

è¿™ä¸ªé˜¶æ®µå¯¹Androidå¼€å‘æ¥è¯´ï¼Œåªéœ€è¦äº†è§£ä¸‹æœ‰è¿™ä¸ªæ­¥éª¤å³å¯ï¼Œæ— éœ€æ·±å…¥ã€‚
#### 2.2ï¼šå‡†å¤‡
å‡†å¤‡é˜¶æ®µæ˜¯æ­£å¼ä¸ºç±»ä¸­å®šä¹‰çš„é™æ€å˜é‡åˆ†é…å†…å­˜ï¼Œå¹¶è®¾ç½®ç±»å˜é‡çš„åˆå§‹å€¼

è¿™é‡Œè¦æä¸¤ç‚¹ï¼š
- 1.è¿™æ—¶å€™çš„å†…å­˜åˆ†é…åªåŒ…æ‹¬ç±»çš„é™æ€å˜é‡ï¼Œä¸åŒ…æ‹¬å®ä¾‹çš„å˜é‡ï¼Œå®ä¾‹å˜é‡ä¼šåœ¨å¯¹è±¡å®ä¾‹åŒ–æ—¶ä¸€èµ·åˆ†é…åˆ°javaå †ä¸­
- 2.è¿™é‡Œçš„åˆå§‹å€¼ï¼Œè¡¨ç¤ºçš„æ•°æ®çš„é›¶å€¼ï¼Œè€Œä¸æ˜¯æ•°æ®çš„çœŸå®å€¼ï¼Œ
å¦‚ä¸‹ï¼š

```java
public static int value = 1234
```
**åœ¨å‡†å¤‡é˜¶æ®µè¿‡åï¼Œvalueåœ¨å†…å­˜ä¸­çš„æ•°æ®æ˜¯0ï¼Œè€Œä¸æ˜¯1234.**
è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

**å› ä¸ºvalueçš„çœŸå®èµ‹å€¼æ“ä½œæ˜¯åœ¨putStaticæ–¹æ³•åï¼Œè€ŒputStaticæ–¹æ³•æ˜¯åœ¨ç±»æ„é€ å™¨cinitæ–¹æ³•ä¸­ï¼Œæ‰€ä»¥ä¼šåœ¨ç±»çš„åˆå§‹åŒ–é˜¶æ®µç»™valueèµ‹å€¼ä¸º1234**

å„æ•°æ®ç±»å‹é›¶å€¼å¦‚ä¸‹ï¼š
| æ•°æ®ç±»å‹  | é›¶å€¼     |
| --------- | -------- |
| int       | 0        |
| long      | 0L       |
| short     | (short)0 |
| char      | '\u0000' |
| byte      | (byte)0  |
| boolean   | false    |
| float     | 0.0f     |
| double    | 0.0d     |
| reference | null     |

ä½†æ˜¯ä¹Ÿæœ‰ç‰¹æ®Šæƒ…å†µï¼š
**å¦‚ä½¿ç”¨finalä¿®é¥°çš„é™æ€å˜é‡ï¼Œåˆ™åœ¨å‡†å¤‡é˜¶æ®µå°±ä¼šèµ‹å€¼ä¸ºçœŸå®çš„finalå€¼å¦‚ä¸Šçš„1234**

#### 2.3.è§£æ
è§£æé˜¶æ®µå°±æ˜¯å°†classæ–‡ä»¶å¸¸é‡æ± ä¸­çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºè™šæ‹Ÿæœºå†…å­˜ä¸­çš„ç›´æ¥å¼•ç”¨

- **ç¬¦å·å¼•ç”¨**ï¼š
è¿™ä¸ªåœ¨å‰é¢è®²è§£Classæ–‡ä»¶ç»“æ„çš„æ—¶å€™æœ‰è¯´æ˜ï¼Œç¬¦å·å¼•ç”¨æ˜¯ç”¨ä¸€ç»„ç¬¦å·æ¥æè¿°æ‰€å¼•ç”¨çš„ç›®æ ‡ï¼Œ
ç¬¦åˆå¯ä»¥æ˜¯ä»»ä½•å½¢å¼çš„å­—é¢é‡ã€‚ç¬¦å·å¼•ç”¨ä¸è™šæ‹Ÿæœºçš„å†…å­˜å¸ƒå±€æ— å…³

- **ç›´æ¥å¼•ç”¨**ï¼š
ç›´æ¥å¼•ç”¨æ˜¯å¯ä»¥ç›´æ¥æŒ‡å‘ç›®æ ‡çš„æŒ‡é’ˆï¼Œç›¸å¯¹åç§»é‡æˆ–è€…èƒ½ç®€ä»‹å®šä½åˆ°ç›®æ ‡çš„å¥æŸ„ï¼Œ
ç›´æ¥å¼•ç”¨æ˜¯ç›´æ¥å’Œè™šæ‹Ÿæœºå†…å­˜å¸ƒå±€å…³è”çš„ã€‚åŒä¸€ä¸ªç¬¦å·å¼•ç”¨å†ä¸åŒè™šæ‹Ÿæœºä¸Šç¿»è¯‘å‡ºæ¥çš„ç›´æ¥å¼•ç”¨ä¹Ÿä¸å°½ç›¸åŒã€‚

ä¸»è¦è§£æä¸‹é¢å‡ ç§å…ƒç´ ï¼š

- 1.ç±»æˆ–è€…æ¥å£è§£æ
- 2.å­—æ®µè§£æ
- 3.æ–¹æ³•è§£æ
- 4.æ¥å£æ–¹æ³•è§£æ

> éªŒè¯ï¼Œå‡†å¤‡ï¼Œè§£æä¸‰ä¸ªé˜¶æ®µä¸€èµ·ç»„æˆäº†ç±»åŠ è½½çš„è¿æ¥é˜¶æ®µ

é€šè¿‡ä¸Šé¢çš„åˆ†æå¯çŸ¥ï¼š
**è¿æ¥é˜¶æ®µä¸»è¦ä»»åŠ¡å°±æ˜¯å®Œæˆå°†classæ–‡ä»¶ä¸­çš„ç±»ä¿¡æ¯ï¼ŒåŠ è½½åˆ°è™šæ‹Ÿæœºçš„å†…å­˜ä¸­ï¼Œ
å¹¶ç»™ç±»çš„é™æ€å˜é‡èµ‹ä¸Šé›¶å€¼ã€‚**


### 3.åˆå§‹åŒ–
**åˆå§‹åŒ–é˜¶æ®µå°±æ˜¯æ‰§è¡Œç±»æ„é€ å™¨`<clinit>`æ–¹æ³•çš„è¿‡ç¨‹**ï¼Œ
`<clinit>`æ–¹æ³•æ˜¯åœ¨ç¼–è¯‘å™¨è‡ªåŠ¨æ”¶é›†ç±»ä¸­æ‰€æœ‰ç±»å˜é‡çš„èµ‹å€¼åŠ¨ä½œå’Œé™æ€è¯­å¥å—`static{}`ä¸­çš„è¯­å¥åˆå¹¶äº§ç”Ÿçš„

**æ³¨æ„äº‹é¡¹**ï¼š
- 1.é™æ€è¯­å¥å—åªèƒ½è®¿é—®å®šä¹‰åœ¨å…¶ä¹‹å‰çš„å˜é‡ï¼Œå¯¹åœ¨å…¶åçš„å˜é‡åªèƒ½èµ‹å€¼ä¸èƒ½è®¿é—®ï¼š
å¦‚ä¸‹ï¼š

```java
public class SuperClass {
    public static int before = 1;
    static {
        //è¿™é‡Œæ­£å¸¸
        before=11;
        //è¿™é‡Œæ­£å¸¸
        System.out.println("before is "+before);
        //è¿™é‡ŒæŠ¥The value 22 assigned to 'after' is never used ï¼Œä½†æ˜¯ä¸ä¼šæŠ¥çº¢ï¼Œç¼–è¯‘æœªæŠ¥é”™
        after = 22;
        //ç¼–è¯‘æœŸæŠ¥éæ³•å‘å‰å¼•ç”¨ï¼ŒæŠ¥çº¢
        System.out.println("before is "+after);
        System.out.println("this is SuperClass!!");
    }
    public static int after = 2;
    public static  String className = "SuperClass";
}

```

- 2.`<clinit>`æ–¹æ³•æ‰§è¡Œå‰ä¼šä¼˜å…ˆåŠ è½½çˆ¶ç±»çš„`<clinit>`ï¼Œæ‰€ä»¥æœ€å…ˆæ‰§è¡Œçš„è‚¯å®šæ˜¯Objectçš„`<clinit>`æ–¹æ³•
çœ‹ä¸‹é¢ä¾‹å­ï¼š

```java
public class SuperClass {
    public static int value = 123;
    static {
        value = 1234;
    }
}
public class SubClass extends SuperClass{
    public static int sunValue = value;
}
@Test
public void classLoaderTest() {
	System.out.println("sub:"+SubClass.sunValue);
}
```
**ç»“æœï¼šsun:1234**

ç”±äºçˆ¶ç±»çš„static{}æ–¹æ³•ä¼˜å…ˆæ‰§è¡Œï¼Œæ‰€ä»¥ç»“æœsunValueæ˜¯æ‰§è¡Œå®Œçˆ¶ç±»æ‰§è¡Œå®Œ<clinit>æ–¹æ³•åçš„å€¼

- 3.`<clinit>`æ–¹æ³•åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹ä¼šåŠ é”åŒæ­¥ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶åˆå§‹åŒ–ä¸€ä¸ªç±»ï¼Œé‚£ä¹ˆåªä¼šæœ‰å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè¿™ä¸ªç±»çš„<clinit>

```java
public class SuperClass {
    public static int value = 123;
    static {
        value = 1234;
        System.out.println(value);
        try {
            Thread.sleep(5000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
public class SubClass extends SuperClass{
    public static int sunValue = value;
}
    @Test
public void classLoaderTest() {

	Runnable runnable = new Runnable() {
		@Override
		public void run() {
			System.out.println(Thread.currentThread()+".start");
			SuperClass superClass = new SuperClass();
			System.out.println(Thread.currentThread()+".end");
		}
	};
	Thread thread1 = new Thread(runnable);
	Thread thread2 = new Thread(runnable);
	thread1.start();
	thread2.start();
}
ç»“æœï¼š
Thread[Thread-1,5,main].start
1234
Thread[Thread-0,5,main].start
Thread[Thread-0,5,main].end
Thread[Thread-1,5,main].end
```

çœ‹åˆ°è¿™é‡Œåªæ‰§è¡Œäº†ä¸€æ¬¡<clinit>æ–¹æ³•ï¼Œä¹ŸéªŒè¯å‰é¢çš„ç»“è®º


### 4.ç±»åˆå§‹åŒ–æ—¶æœºï¼š
- 1.é‡åˆ°**newï¼ŒgetStaticï¼ŒputStatic**ï¼Œæˆ–**invokestatic**è¿™å››æ¡å­—èŠ‚ç æŒ‡ä»¤æ—¶
  åˆ†åˆ«å¯¹åº”:
    - **new**->ä½¿ç”¨newåˆ›å»ºå®ä¾‹å¯¹è±¡
    - **getStaticï¼ŒputStatic**->è¯»å–æˆ–è€…è®¾ç½®ä¸€ä¸ªstaticç±»å‹çš„å­—æ®µï¼Œfinalä¿®é¥°é™¤å¤–
    - **invokestatic**ï¼šè°ƒç”¨ä¸€ä¸ªç±»çš„é™æ€æ–¹æ³•
- 2.å¯¹ç±»è¿›è¡Œ**åå°„**è°ƒç”¨
- 3.å½“å‰ç±»åˆå§‹åŒ–æ—¶ï¼Œ**ä¼˜å…ˆåˆå§‹åŒ–çˆ¶ç±»**
- 4.è™šæ‹Ÿæœºå¯åŠ¨æ—¶ä¼šä¼˜å…ˆåˆå§‹åŒ–åŒ…å«**mainæ–¹æ³•çš„é‚£ä¸ªç±»**ï¼Œåœ¨Androidä¸­å°±æ˜¯**ActivityThread**ç±»
- 5.å½“ä¸€ä¸ª`MethodHandle`å®ä¾‹æœ€åçš„è§£æç»“æœä¸º**REF_getStatic,REF_putStatic,REF_invokeStatic,REF_newInvokeSpecial**å››ç§æ–¹æ³•å¥æŸ„ï¼Œ**ä¼˜å…ˆåˆå§‹åŒ–è¿™ä¸ªæ–¹æ³•å¥æŸ„å¯¹åº”çš„ç±»**
- 6.å½“ä¸€ä¸ªæ¥å£ä¸­å®šä¹‰äº†jdk8ä¸­æ–°åŠ å…¥çš„é»˜è®¤æ–¹æ³•ï¼Œ**è¢«defaultä¿®é¥°çš„çš„æ¥å£æ–¹æ³•ï¼Œå¦‚æœæ¥å£çš„å®ç°ç±»éœ€è¦åˆå§‹åŒ–ï¼Œåˆ™å…¶ä¼šä¼˜å…ˆè¿›è¡Œåˆå§‹åŒ–**
  

æœ‰ä¸”ä»…æœ‰ä¸Šé¢6ç§æƒ…å†µç±»ä¼šè¿›è¡Œåˆå§‹åŒ–ï¼Œè¢«ç§°ä¸º**ä¸»åŠ¨å¼•ç”¨**

æœ‰ä¸»åŠ¨å¼•ç”¨ï¼Œå½“ç„¶ä¼šæœ‰**è¢«åŠ¨å¼•ç”¨**ï¼š`é™¤äº†å‰é¢ä¸»åŠ¨å¼•ç”¨çš„åœºæ™¯ï¼Œæ‰€æœ‰å¼•ç”¨ç±»å‹çš„æ–¹å¼éƒ½ä¸ä¼šè§¦å‘åˆå§‹åŒ–ï¼Œç§°ä¸ºè¢«åŠ¨å¼•ç”¨`
    
ç”¨ä¸ªä¾‹å­æ¥è¯´æ˜ï¼š
    
`æ¼”ç¤º1`ï¼š

```java
public class SuperClass {
    static {
            System.out.println("this is SuperClass!!");
    }
    public static String className = "SuperClass";
}	

public class SubClass extends SuperClass{
    static {
            System.out.println("this is SubClass !!");
    }
}
å•å…ƒæµ‹è¯•ï¼š
@Test
public void classLoaderTest() {
String className = SubClass.className;
}    
```

æ‰“å°ç»“æœï¼š`this is SuperClass!!`,
**åªåˆå§‹åŒ–äº†çˆ¶ç±»SuperClassè€Œæ²¡æœ‰åˆå§‹åŒ–SubClassï¼Œè¯´æ˜æˆ‘ä»¬å­ç±»è¯»å–çˆ¶ç±»çš„staticå­—æ®µçš„æ—¶å€™ï¼Œåªä¼šåˆå§‹åŒ–çˆ¶ç±»ï¼Œè€Œä¸ä¼šåˆå§‹åŒ–å­ç±»ã€‚**
	
`æ¼”ç¤º2`:
	
æˆ‘ä»¬å°†æ¼”ç¤º1ä¸­çš„å•å…ƒæµ‹è¯•æ”¹æˆä¸‹é¢è¿™å¥è¯ï¼š

```java
@Test  
public void classLoaderTest() {
    SuperClass[] classes = new SuperClass[20];
}   
```

å‘ç°å¹¶æ²¡æœ‰æ‰“å°å‡º`this is SuperClass!!`ï¼Œ**è¡¨æ˜è°ƒç”¨æ•°ç»„æ–¹æ³•ï¼Œå¹¶æ²¡æœ‰å»åˆå§‹åŒ–æˆ‘ä»¬çš„`SuperClass`ç±»,æˆ‘ä»¬çŸ¥é“æ•°ç»„çš„åˆ›å»ºï¼Œåœ¨å­—èŠ‚ç æŒ‡ä»¤ä¸­å¯¹åº”`newarray`æŒ‡ä»¤ã€‚è€Œè¿™ä¸ªæŒ‡ä»¤ä¼šè‡ªåŠ¨è§¦å‘æ•°ç»„å¯¹è±¡çš„åˆå§‹åŒ–ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­çš„æ•°ç»„å¯¹è±¡å¯¹åº”çš„ç±»ä¸ºï¼š`[Lcom.anna.music.SuperClass`,å®ƒæ˜¯ç”±è™šæ‹Ÿæœºè‡ªåŠ¨ç”Ÿæˆçš„`ç»§æ‰¿ä¸ºObjectçš„å­ç±»`**
	
`æ¼”ç¤º3`ï¼š

æˆ‘ä»¬å°†æ¼”ç¤º1ä¸­çš„`SuperClass`çš„`className`å­—æ®µæ”¹ä¸º`finalçš„é™æ€å­—æ®µ`ï¼Œåœ¨å†å­ç±»ä¸­å»å¼•ç”¨è¿™ä¸ªç±»ï¼š

```java
public class SuperClass {
    static {
            System.out.println("this is SuperClass!!");
    }
    public static final String className = "SuperClass";
}	

@Test
public void classLoaderTest() {
String className = SubClass.className;
}    
```

ç»“æœï¼š**ä»€ä¹ˆéƒ½æ²¡æœ‰**

è¿™æ˜¯å› ä¸º**finalä¿®é¥°çš„å­—æ®µåœ¨ç¼–è¯‘æœŸä¼šè¢«è¢«å­˜å…¥classçš„å¸¸é‡æ± ä¸­ï¼Œå¹¶æ²¡æœ‰å¼•ç”¨å¸¸é‡çš„ç±»ï¼Œæ‰€ä»¥ä¸ä¼šè§¦å‘ç±»çš„åˆå§‹åŒ–**
	
ä¸Šé¢é€šè¿‡3ä¸ªä¾‹å­è®²è¿°äº†å¸¸è§çš„å‡ ç§`è¢«åŠ¨å¼•ç”¨`ã€‚

## ç±»åŠ è½½å™¨

**ç±»åŠ è½½å™¨ç”¨äºåŠ è½½Classæ–‡ä»¶åˆ°å†…å­˜ä¸­**ã€‚
> æ¯”è¾ƒä¸¤ä¸ªç±»æ˜¯å¦ç›¸ç­‰ï¼Œåªæœ‰è¿™**ä¸¤ä¸ªç±»ä½¿ç”¨åŒä¸€ä¸ªç±»åŠ è½½å™¨åŠ è½½çš„æƒ…å†µä¸‹æ‰æœ‰æ„ä¹‰**ï¼Œå› ä¸ºä½¿ç”¨ä¸åŒç±»åŠ è½½å™¨åŠ è½½çš„ç±»å¿…å®šä¸åŒ

å¦‚ä¸‹ï¼š
    
```java
  @Test
public void classLoaderTest() {

    ClassLoader loader = new ClassLoader() {
        @Override
        public Class<?> loadClass(String name) throws ClassNotFoundException {
            String fileName = name.substring(name.lastIndexOf(".")+1)+".class";
            InputStream is = getClass().getResourceAsStream(fileName);
            if(is == null){
                return super.loadClass(name);
            }

            try {
                byte[] b = new byte[is.available()];
                is.read(b);
                return defineClass(name,b,0,b.length);
            } catch (IOException e) {
                e.printStackTrace();
            }
            return null;
        }
    };
    try {
        Object super1 = loader.loadClass("com.anna.music.SuperClass").newInstance();
        System.out.println(super1.getClass());
        System.out.println(super1 instanceof com.anna.music.SuperClass);
    } catch (ClassNotFoundException e) {
        e.printStackTrace();
    }
    try {
        Thread.sleep(2000);
    } catch (InterruptedException e) {
        e.printStackTrace();
    }

}  
```


ç»“æœï¼š
class com.anna.music.SuperClass
false

**è™½ç„¶ä¸¤ä¸ªç±»éƒ½æ˜¯åŒä¸€ä¸ªè·¯å¾„ä¸‹çš„åŒä¸€ä¸ªç±»ï¼Œä½†æ˜¯ä½¿ç”¨ä¸åŒçš„ç±»åŠ è½½å™¨`ClassLoader`åŠ è½½ï¼Œè·å–çš„Classç±»è‚¯å®šä¸æ˜¯åŒä¸€ä¸ª**ã€‚

**ç±»åŠ è½½å™¨åœ¨`Androidæ’ä»¶åŒ–`æ¡†æ¶ä¸­èµ·ç€å…³é”®ä½œç”¨ï¼ŒåŸºæœ¬ä¸Šå¸‚é¢ä¸Šä½¿ç”¨çš„å‡ ç§æ¡†æ¶éƒ½éœ€è¦è‡ªå®šä¹‰`DexClassLoader`æˆ–è€…`PathClassLoader`è¿›è¡Œå¤„ç†ã€‚**

## åŒäº²å§”æ´¾æ¨¡å‹

**ç±»åŠ è½½å™¨`ClassLoader`ä¸»è¦åˆ†ä»¥ä¸‹å‡ ç§**ï¼š
- 1.**å¯åŠ¨ç±»åŠ è½½å™¨**(`Bootstrap Class Loader`):
è´Ÿè´£åŠ è½½å­˜æ”¾åœ¨`<JAVA_HOME>\lib`ç›®å½•ä¸‹çš„`classæ–‡ä»¶`
- 2.**æ‰©å±•ç±»åŠ è½½å™¨**(`Extension Class Loader`):
è´Ÿè´£åŠ è½½å­˜æ”¾åœ¨`<JAVA_HOME>\lib\ext`ç›®å½•ä¸‹çš„`Classæ–‡ä»¶`ï¼Œä½¿ç”¨`ExtClassLoader`ç±»å®ç°
- 3.**åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨**(`Application Class Loader`):
ä¸€èˆ¬æ˜¯ç³»ç»Ÿé»˜è®¤åŠ è½½å™¨ï¼Œé»˜è®¤å®ç°ç±»`AppClassLoader`ï¼Œç”¨äºåŠ è½½ç”¨æˆ·è·¯å¾„ä¸Šçš„æ‰€æœ‰ç±»åº“
- 4.**è‡ªå®šä¹‰ç±»åŠ è½½**(`User Class Loader`):
è‡ªå·±å®šä¹‰çš„ç±»åŠ è½½ï¼ŒåŠ è½½è‡ªå·±çš„ç‰¹ç‚¹classï¼Œä¸€èˆ¬ç”¨äºæ’ä»¶åŒ–è¿‡ç¨‹ï¼š


ä»–ä»¬çš„å…³ç³»å¦‚ä¸‹ï¼š

![ç±»åŠ è½½åŒäº²å§”æ´¾.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cfaf52da7d1b47649f3f8af3da604f13~tplv-k3u1fbpfcp-watermark.image?)
**åŒäº²å§”æ´¾æ¨¡å‹**å·¥ä½œè¿‡ç¨‹å¦‚ä¸‹ï¼š
> å¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°äº†ç±»åŠ è½½çš„è¯·æ±‚ï¼Œå®ƒé¦–å…ˆä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨å»åŠ è½½ï¼Œæ²¡ä¸€ä¸ªå±‚æ¬¡çš„åŠ è½½å™¨éƒ½æ˜¯å¦‚æ­¤ï¼Œ
> å› æ­¤æ‰€æœ‰çš„åŠ è½½è¯·æ±‚æœ€ç»ˆéƒ½ä¼šä¼ é€åˆ°æœ€åº•å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ï¼Œåªæœ‰çˆ¶åŠ è½½å™¨æ— æ³•å®ŒæˆåŠ è½½çš„æ—¶å€™æ‰ä¼šå°†åŠ è½½ä»»åŠ¡å‘ä¸‹ä¼ é€’ä¸ªå­ç±»è¿›è¡Œã€‚

è¿™ä¸ªè¿‡ç¨‹å°±å¥½æ¯”ï¼š
**å¤ä»£çš‡å¸æ‰“äº†èƒœæˆ˜ï¼Œè¦æŠŠæˆ˜åˆ©å“å…ˆä¸€å±‚ä¸€å±‚æäº¤ä¸Šå»ï¼Œç›´åˆ°çš‡å¸é‚£ï¼Œçš‡å¸è¯´ï¼Œæˆ‘è¦ä¸äº†è¿™ä¹ˆå¤šï¼Œç„¶åæŠŠå‰©ä½™æˆ˜åˆ©å“ä¸€çº§ä¸€çº§å‘ä¸‹åˆ†å‘ç›´åˆ°å£«å…µé‚£ï¼Œä¸‹ä¸€çº§åˆ°å°†å†›é‚£ä¹Ÿæ˜¯åŒæ ·å¤„ç†**ã€‚

**ä¸ºä»€ä¹ˆè¿™ä¹ˆåšï¼Ÿ**
-   **é¿å…é‡å¤åŠ è½½**ï¼Œå½“çˆ¶åŠ è½½å™¨å·²ç»åŠ è½½äº†è¯¥ç±»çš„æ—¶å€™ï¼Œå°±æ²¡æœ‰å¿…è¦å­ClassLoaderå†åŠ è½½ä¸€æ¬¡ã€‚
-   **å®‰å…¨æ€§è€ƒè™‘**ï¼Œé˜²æ­¢æ ¸å¿ƒAPIåº“è¢«éšæ„ç¯¡æ”¹ã€‚

## Androidä¸­çš„ç±»åŠ è½½å™¨ï¼š
**ä¸Šé¢æ‰€è®²çš„éƒ½æ˜¯javaè™šæ‹Ÿæœºç±»åŠ è½½å™¨åŠ è½½Classæ–‡ä»¶çš„è¿‡ç¨‹ï¼Œåœ¨Androidä¸­å› ä¸ºapkä¸­ä½¿ç”¨çš„æ˜¯dexæ–‡ä»¶ï¼Œè¿™æ˜¯ä¸€ç§ç‰¹æ®Šå‹ç¼©æ–¹å¼å¾—åˆ°çš„æ–‡ä»¶ï¼Œå†…éƒ¨ä¸ä»…ä»…åªæœ‰classæ–‡ä»¶ï¼Œè€Œæ˜¯å®Œå…¨å¯¹Classæ–‡ä»¶å†…éƒ¨çš„å„ç§å‡½æ•°è¡¨ã€å˜é‡è¡¨ç­‰è¿›è¡Œä¼˜åŒ–ï¼Œå¹¶äº§ç”Ÿä¸€ä¸ªæ–°çš„æ–‡ä»¶ï¼Œæ‰€ä»¥javaä¸­å’ŒAndroidä¸­çš„ClassLoaderä¹Ÿä¸ä¸€æ ·**

ä¸‹é¢æ¥çœ‹ä¸‹**Androidä¸­çš„ç±»åŠ è½½æ„æˆ**ï¼š

![android classloader.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/15e2bb81264c47718beb2460caabe4ae~tplv-k3u1fbpfcp-watermark.image?)
- `ClassLoader`æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œ**æ‰€æœ‰ç±»åŠ è½½å™¨çš„åŸºç±»**
- `BootClassLoader`ï¼šæ˜¯ClassLoaderçš„å­ç±»ï¼ˆæ³¨æ„ä¸æ˜¯å†…éƒ¨ç±»ï¼‰ï¼Œç”¨äºåŠ è½½ä¸€äº›ç³»ç»Ÿ`Framework`å±‚çº§éœ€è¦çš„ç±»
- `SecureClassLoader`æ‰©å±•äº†ClassLoaderç±»ï¼ŒåŠ å…¥äº†æƒé™æ–¹é¢çš„åŠŸèƒ½ï¼Œ**åŠ å¼ºäº†å®‰å…¨æ€§**
- `BaseDexClassLoader`æ˜¯å®ç°äº†**Android ClassLoaderçš„å¤§éƒ¨åˆ†åŠŸèƒ½**,
**PathClassLoader**å’Œ**DexClassLoade**çš„åŸºç±»
- `PathClassLoader`åŠ è½½åº”ç”¨ç¨‹åºçš„ç±»ï¼Œ**ä¼šåŠ è½½/data/appç›®å½•ä¸‹çš„dexæ–‡ä»¶ä»¥åŠåŒ…å«dexçš„apkæ–‡ä»¶æˆ–è€…javaæ–‡ä»¶**
- `DexClassLoader`å¯ä»¥**åŠ è½½è‡ªå®šä¹‰dexæ–‡ä»¶ä»¥åŠåŒ…å«dexçš„apkæ–‡ä»¶æˆ–jaræ–‡ä»¶ï¼Œæ”¯æŒä»SDå¡è¿›è¡ŒåŠ è½½**ã€‚æˆ‘ä»¬ä½¿ç”¨æ’ä»¶åŒ–æŠ€æœ¯çš„æ—¶å€™ä¼šç”¨åˆ°
- `InMemoryDexClassLoader`:ç”¨äº**åŠ è½½å†…å­˜ä¸­çš„dexæ–‡ä»¶**

è¿™é‡Œæˆ‘ä»¬ä¸»è¦æ¥çœ‹`PathClassLoader`å’Œ`DexClassLoader`è¿™ä¸¤ä¸ªç±»åŠ è½½å™¨æ˜¯æˆ‘ä»¬Androidä¸­æœ€é‡è¦çš„ç±»åŠ è½½å™¨
æŸ¥çœ‹æºç ï¼š

```java
public class DexClassLoader extends BaseDexClassLoader {
    public DexClassLoader(String dexPath, String optimizedDirectory, String librarySearchPath, ClassLoader parent) {
        super((String)null, (File)null, (String)null, (ClassLoader)null);
        throw new RuntimeException("Stub!");
    }
}

```
`DexClassLoader`ç±»ä¸­å°±åªæœ‰ä¸€ä¸ªæ„é€ æ–¹æ³•ï¼Œæ„é€ æ–¹æ³•ä¸­ç›´æ¥è°ƒç”¨äº†çˆ¶ç±»çš„æ„é€ ï¼ŒDexClassLoade**rç»§æ‰¿äº†BaseDexClassLoader**ï¼Œæ„é€ æ–¹æ³•ä¸­çš„å‚æ•°çš„å«ä¹‰æ˜¯ï¼š
- **dexPath**:dexæ–‡ä»¶è·¯å¾„
- **optimizedDirectory**ï¼šdexæ–‡ä»¶é¦–æ¬¡åŠ è½½æ—¶ä¼šè¿›è¡Œä¼˜åŒ–æ“ä½œï¼Œè¿™ä¸ªå‚æ•°å³ä¸ºä¼˜åŒ–åçš„odexæ–‡ä»¶çš„å­˜æ”¾ç›®å½•ï¼Œå®˜æ–¹æ¨èä½¿ç”¨åº”ç”¨ç§æœ‰ç›®å½•æ¥ç¼“å­˜ä¼˜åŒ–åçš„dexæ–‡ä»¶ï¼ŒdexOutputDir = context.getDir(â€œdexâ€, 0);
- **librarySearchPath**ï¼šåŠ¨æ€åº“è·¯å¾„
- **parent**ï¼šå½“å‰ç±»åŠ è½½å™¨çš„çˆ¶ç±»åŠ è½½å™¨



ç»§ç»­çœ‹`PathClassLoader`ï¼š

```java
public class PathClassLoader extends BaseDexClassLoader {
    public PathClassLoader(String dexPath, ClassLoader parent) {
        super((String)null, (File)null, (String)null, (ClassLoader)null);
        throw new RuntimeException("Stub!");
    }

    public PathClassLoader(String dexPath, String librarySearchPath, ClassLoader parent) {
        super((String)null, (File)null, (String)null, (ClassLoader)null);
        throw new RuntimeException("Stub!");
    }
}
```
PathClassLoaderæœ‰ä¸¤ä¸ªæ„é€ æ–¹æ³•ï¼ŒåŒæ ·ä¹Ÿæ˜¯ç›´æ¥è°ƒç”¨äº†çˆ¶ç±»çš„æ„é€ æ–¹æ³•ï¼Œä»æ„é€ æ–¹æ³•ä¸Šæ¥çœ‹ï¼Œ**DexClassLoaderå’ŒPathClassLoaderçš„åŒºåˆ«åªæœ‰ç¬¬äºŒä¸ªå‚æ•°optimizedDirectory**ï¼Œåœ¨PathClassLoaderä¸­optimizedDirectoryé»˜è®¤ä¼ å…¥çš„æ˜¯nullã€‚

ä»æºç ä¸­çœ‹è¿™ä¸¤ä¸ªç±»çš„**ä½œç”¨ä¹Ÿæ˜¯å› ä¸ºoptimizedDirectoryå‚æ•°çš„ä¸åŒè€Œä¸åŒ**ï¼Œ**åœ¨æºç ä¸­çœ‹ä½¿ç”¨PathClassLoaderç”±äºæ²¡æœ‰ä¼ å…¥optimizedDirectoryï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆä»¥åç¼“å­˜ç›®å½•ï¼Œå³/data/dalvik-cache/ï¼Œåœ¨è¿™ä¸ªç›®å½•å­˜æ”¾ä¼˜åŒ–ä»¥åçš„dexæ–‡ä»¶**ã€‚

æ‰€ä»¥**PathClassLoaderåªèƒ½åŠ è½½å·²å®‰è£…çš„apkçš„dex**ï¼Œå³åŠ è½½ç³»ç»Ÿçš„ç±»å’Œå·²ç»å®‰è£…çš„åº”ç”¨ç¨‹åºï¼ˆå®‰è£…çš„apkçš„dexæ–‡ä»¶ä¼šå­˜å‚¨åœ¨/data/dalvik-cacheä¸­ï¼‰ï¼Œè€Œ**DexClassLoaderå¯ä»¥åŠ è½½æŒ‡å®šè·¯å¾„çš„apkã€dexï¼Œä¹Ÿå¯ä»¥ä»sdå¡ä¸­è¿›è¡ŒåŠ è½½**ã€‚

`Androidä¸­æ’ä»¶åŒ–æ¡†æ¶åŸç†`ï¼š

> **å°†apkæ”¾åˆ°åº”ç”¨æ–‡ä»¶å¤¹ï¼Œå¦‚assertç›®å½•ä¸‹ï¼Œç„¶åé‡å†™`DexClassLoader`ï¼Œå®ç°è‡ªå·±loadClassç­‰æ–¹æ³•ï¼Œå¹¶ä½¿ç”¨åå°„æ›¿æ¢ç³»ç»Ÿä¸­çš„ç±»åŠ è½½å™¨ï¼Œåœ¨ç±»è¿›è¡ŒåŠ è½½çš„æ—¶å€™ï¼Œå°±ä¼šè‡ªåŠ¨ä½¿ç”¨é‡å†™åçš„ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥åŠ è½½æœªå®‰è£…çš„apkä¸­çš„æ–‡ä»¶ï¼Œçœ‹åˆ°å…¶å®æ’ä»¶åŒ–ä¹Ÿæ²¡ä»€ä¹ˆæ·±ä¸å¯æµ‹çš„ã€‚**
## æ€»ç»“
æœ¬ç¯‡æ–‡ç« ä»‹ç»äº†ç±»åŠ è½½è¿‡ç¨‹ï¼š
**åŠ è½½ï¼ŒéªŒè¯ï¼Œå‡†å¤‡ï¼Œè§£æå’Œåˆå§‹åŒ–**ï¼Œè¿™5ä¸ªè¿‡ç¨‹ä¸­è™šæ‹Ÿæœºåšäº†å“ªäº›æ“ä½œï¼Œè¿˜ä»‹ç»äº†ç±»åŠ è½½çš„å·¥ä½œåŸç†ï¼ŒåŒäº²å§”æ´¾æ¨¡å‹ã€‚
è¿˜è®²è§£äº†ä¸€äº›å…³äºAndroidä¸­ç±»åŠ è½½çš„åˆ†æä»¥åŠç®€å•æè¿°äº†ä¸‹æ’ä»¶åŒ–æ¡†æ¶çš„åŸç†
ç›¸ä¿¡å¤§å®¶å­¦å®ŒJVMçš„å‡ ç¯‡æ–‡ç« å¯¹Classæ–‡ä»¶å¦‚ä½•åŠ è½½åˆ°è™šæ‹Ÿæœºå†…å­˜ä¸­æœ‰äº†ä¸€ä¸ªæ¯”è¾ƒç³»ç»Ÿçš„äº†è§£ã€‚

> ç æ–‡ä¸æ˜“ï¼Œçœ‹å®Œåˆ«å¿˜è®°ç‚¹èµå…³æ³¨ï¼Œè°¢è°¢