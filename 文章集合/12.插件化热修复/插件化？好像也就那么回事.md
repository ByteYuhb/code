---
theme: smartblue
highlight: a11y-light
---

æˆ‘æŠ¥åå‚åŠ é‡‘çŸ³è®¡åˆ’1æœŸæŒ‘æˆ˜â€”â€”ç“œåˆ†10ä¸‡å¥–æ± ï¼Œè¿™æ˜¯æˆ‘çš„ç¬¬2ç¯‡æ–‡ç« ï¼Œ[ç‚¹å‡»æŸ¥çœ‹æ´»åŠ¨è¯¦æƒ…](https://s.juejin.cn/ds/jooSN7t "https://s.juejin.cn/ds/jooSN7t")
> ğŸ”¥ **Hiï¼Œæˆ‘æ˜¯å°ä½™ã€‚**
>
> **æœ¬æ–‡å·²æ”¶å½•åˆ° [GitHub Â· Androider-Planet](https://github.com/ByteYuhb/Androider-Planet) ä¸­ã€‚è¿™é‡Œæœ‰ Android è¿›é˜¶æˆé•¿çŸ¥è¯†ä½“ç³»ï¼Œå…³æ³¨å…¬ä¼—å· [å°ä½™çš„è‡ªä¹ å®¤] ï¼Œåœ¨æˆåŠŸçš„è·¯ä¸Šä¸è¿·è·¯ï¼**
## å‰è¨€

æƒ³å¿…å¤§å®¶éƒ½çŸ¥é“ï¼Œåœ¨ Android ç³»ç»Ÿä¸­ï¼Œåº”ç”¨æ˜¯ä»¥ Apk çš„å½¢å¼å­˜åœ¨çš„ï¼Œåº”ç”¨éƒ½éœ€è¦å®‰è£…æ‰èƒ½ä½¿ç”¨ã€‚
ä½†å®é™…ä¸Š **Android ç³»ç»Ÿå®‰è£…åº”ç”¨çš„æ–¹å¼ç›¸å½“ç®€å•ï¼Œå…¶å®å°±æ˜¯æŠŠåº”ç”¨ Apk æ‹·è´åˆ°ç³»ç»Ÿä¸åŒçš„ç›®å½•ä¸‹ã€ç„¶åæŠŠ so è§£å‹å‡ºæ¥è€Œå·²**ã€‚

å¸¸è§çš„åº”ç”¨å®‰è£…ç›®å½•æœ‰ï¼š
- `/system/app`ï¼šç³»ç»Ÿåº”ç”¨
- `/system/priv-app`ï¼šç³»ç»Ÿåº”ç”¨
- `/data/app`ï¼šç”¨æˆ·åº”ç”¨

é‚£å¯èƒ½å¤§å®¶ä¼šæƒ³é—®ï¼Œæ—¢ç„¶å®‰è£…è¿™ä¸ªè¿‡ç¨‹å¦‚æ­¤ç®€å•ï¼ŒAndroid æ˜¯æ€ä¹ˆè¿è¡Œåº”ç”¨ä¸­çš„ä»£ç çš„å‘¢ï¼Œæˆ‘ä»¬å…ˆçœ‹ Apk çš„æ„æˆï¼Œä¸€ä¸ªå¸¸è§çš„ Apk ä¼šåŒ…å«å¦‚ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š
- `classes.dex`ï¼šJava ä»£ç å­—èŠ‚ç 
- `res`ï¼šèµ„æºæ–‡ä»¶
- `lib`ï¼šso æ–‡ä»¶
- `assets`ï¼šé™æ€èµ„äº§æ–‡ä»¶
- `AndroidManifest.xml`ï¼šæ¸…å•æ–‡ä»¶

å…¶å® Android ç³»ç»Ÿåœ¨æ‰“å¼€åº”ç”¨ä¹‹åï¼Œä¹Ÿåªæ˜¯å¼€è¾Ÿè¿›ç¨‹ï¼Œç„¶åä½¿ç”¨ `ClassLoader` åŠ è½½ `classes.dex` è‡³è¿›ç¨‹ä¸­ï¼Œæ‰§è¡Œå¯¹åº”çš„ç»„ä»¶è€Œå·²ã€‚

**æ—¢ç„¶ Android æœ¬èº«ä¹Ÿæ˜¯ä½¿ç”¨ç±»ä¼¼åå°„çš„å½¢å¼åŠ è½½ä»£ç æ‰§è¡Œï¼Œå‡­ä»€ä¹ˆæˆ‘ä»¬ä¸èƒ½æ‰§è¡Œä¸€ä¸ª Apk ä¸­çš„ä»£ç å‘¢ï¼Ÿ**
è¿™å°±éœ€è¦å¼•å…¥æ’ä»¶åŒ–ç›¸å…³æ¦‚å¿µï¼š

## æ’ä»¶åŒ–ç›¸å…³æ¦‚å¿µï¼š
- 1.**æ’ä»¶**ï¼šä¸€ä¸ªæ’ä»¶å…¶å®å°±æ˜¯ä¸€ä¸ªapk
- 2.**æ’ä»¶å·¥ç¨‹**:èƒ½å¤Ÿç¼–è¯‘ç”Ÿæˆæ’ä»¶apkçš„å·¥ç¨‹
- 3.**æ’ä»¶åŒ–**ï¼šå°†ä¸€ä¸ªå¤§çš„apkæ‹†åˆ†æˆå¤šä¸ªå°apkçš„è¿‡ç¨‹

**æ’ä»¶åŒ–ç»“æ„å›¾**ï¼š

![æ’ä»¶æ¡†æ¶.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6e1d793725754980bfd11659e5d426b3~tplv-k3u1fbpfcp-watermark.image?)
æ’ä»¶åŒ–æ¡†æ¶ä¸­çš„apkä¸€èˆ¬éƒ½æœ‰è‡ªå·±çš„**æ’ä»¶ClassLoader**ï¼Œ**æ’ä»¶AssetManager**ï¼Œ**æ’ä»¶Context**

è€Œæœ€åº•å±‚çš„æ’ä»¶æ¡†æ¶ç±»ä¼¼äºæˆ‘ä»¬çš„Android Frameworkå±‚

## æ’ä»¶åŒ–ä¼˜ç¼ºç‚¹ï¼š
**ä¼˜ç‚¹**ï¼š
- 1.è¾ƒå°apkçš„ä½“ç§¯ï¼Œå¯ä»¥æ ¹æ®éœ€è¦ä¸‹è½½å¯¹åº”çš„æ’ä»¶æ¨¡å—
- 2.æ’ä»¶å¯ä»¥å•ç‹¬ä½œä¸ºapkè¿›è¡Œè°ƒè¯•ï¼Œä¸”äº’ç›¸è§£è€¦ï¼Œå¯ä»¥å¤šæ¨¡å—åŒæ—¶å¼€å‘ï¼Œæå‡å¼€å‘æ•ˆç‡
- 3.å¯ä»¥åŠ¨æ€æ›´æ–°æ’ä»¶æˆ–æ’ä»¶è¡¥ä¸

**ç¼ºç‚¹**ï¼š
- 1.å¯¹äºå·²ç»æˆå‹çš„é¡¹ç›®é‡æ„æˆæœ¬è¾ƒå¤§
- 2.å¾ˆå¤šæ’ä»¶åŒ–æ¡†æ¶åšä¸åˆ°å¯¹æ‰€æœ‰ç‰ˆæœ¬å…¼å®¹ã€‚

## æ’ä»¶åŒ–å’Œç»„ä»¶åŒ–åŒºåˆ«
- **ç»„ä»¶åŒ–**ï¼šæ˜¯å°†ä¸€ä¸ªAppåˆ†æˆå¤šä¸ªæ¨¡å—ï¼Œæ¯ä¸ªæ¨¡å—éƒ½æ˜¯ä¸€ä¸ªç»„ä»¶ï¼ˆmoduleï¼‰ï¼Œ
å¼€å‘è¿‡ç¨‹ä¸­å¯ä»¥è®©è¿™äº›ç»„ä»¶ç›¸äº’ä¾èµ–æˆ–ç‹¬ç«‹ç¼–è¯‘ã€è°ƒè¯•éƒ¨åˆ†ç»„ä»¶ï¼Œä½†æ˜¯**è¿™äº›ç»„ä»¶æœ€ç»ˆä¼šåˆå¹¶æˆä¸€ä¸ªå®Œæ•´çš„Apkå»å‘å¸ƒåˆ°åº”ç”¨å¸‚åœº**ã€‚
- **æ’ä»¶åŒ–**ï¼šæ˜¯å°†æ•´ä¸ªAppæ‹†åˆ†æˆå¾ˆå¤šæ¨¡å—ï¼Œæ¯ä¸ªæ¨¡å—éƒ½æ˜¯ä¸€ä¸ªApkï¼ˆç»„ä»¶åŒ–çš„æ¯ä¸ªæ¨¡å—æ˜¯ä¸€ä¸ªlibï¼‰ï¼Œ
æœ€ç»ˆæ‰“åŒ…çš„æ—¶å€™å°†å®¿ä¸»Apkå’Œæ’ä»¶Apkåˆ†å¼€æ‰“åŒ…ï¼Œ**åªéœ€å‘å¸ƒå®¿ä¸»Apkåˆ°åº”ç”¨å¸‚åœºï¼Œæ’ä»¶Apké€šè¿‡åŠ¨æ€æŒ‰éœ€ä¸‹å‘åˆ°å®¿ä¸»Apk**ã€‚


## æ’ä»¶åŒ–æ”¹é€ éœ€è¦è§£å†³å“ªäº›é—®é¢˜
- 1.**æ’ä»¶ç±»åŠ è½½**
- 2.**æ’ä»¶èµ„æºåŠ è½½**
- 3.**æ’ä»¶å››å¤§ç»„ä»¶é€šè®¯**
- 4.**æ’ä»¶åŠ¨æ€éƒ¨ç½²**

### 1.æ’ä»¶ç±»åŠ è½½ï¼š
è¿™é‡Œæˆ‘ä»¬é¦–å…ˆå¾—äº†è§£ä¸‹ç±»åŠ è½½çš„**åŒäº²å§”æ´¾åŸåˆ™**ï¼š

> å¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°äº†ç±»åŠ è½½çš„è¯·æ±‚ï¼Œå®ƒé¦–å…ˆä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨å»åŠ è½½ï¼Œ
> æ¯ä¸€ä¸ªå±‚æ¬¡çš„åŠ è½½å™¨éƒ½æ˜¯å¦‚æ­¤ï¼Œ å› æ­¤æ‰€æœ‰çš„åŠ è½½è¯·æ±‚æœ€ç»ˆéƒ½ä¼šä¼ é€åˆ°æœ€åº•å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ï¼Œ
> åªæœ‰çˆ¶åŠ è½½å™¨æ— æ³•å®ŒæˆåŠ è½½çš„æ—¶å€™æ‰ä¼šå°†åŠ è½½ä»»åŠ¡å‘ä¸‹ä¼ é€’ä¸ªå­ç±»è¿›è¡Œã€‚

**Androidä¸­çš„ClassLoaderç±»å…³ç³»**ï¼š

![æ’ä»¶åŒäº²å§”æ´¾.webp](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6d00284b514c46249e529ce1d24bb4b6~tplv-k3u1fbpfcp-watermark.image?)

ç”±äº**åŒäº²å§”æ´¾åŸåˆ™å­˜åœ¨ï¼Œå…¶åŠ è½½è¿‡ç¨‹å¦‚ä¸‹**ï¼š

![æ’ä»¶åŒ–ç±»åŠ è½½è¿‡ç¨‹.webp](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fef1f5b9ad9148d984f8625b64c0f8c5~tplv-k3u1fbpfcp-watermark.image?)


è¿™é‡Œæˆ‘ä»¬ä¸»è¦æ¥çœ‹`PathClassLoader`å’Œ`DexClassLoader`è¿™ä¸¤ä¸ªç±»åŠ è½½å™¨æ˜¯æˆ‘ä»¬Androidä¸­æœ€é‡è¦çš„ç±»åŠ è½½å™¨ æŸ¥çœ‹æºç ï¼š

```java
public class DexClassLoader extends BaseDexClassLoader {
    public DexClassLoader(String dexPath, String optimizedDirectory, String librarySearchPath, ClassLoader parent) {
        super((String)null, (File)null, (String)null, (ClassLoader)null);
        throw new RuntimeException("Stub!");
    }
}
```

`DexClassLoader`ç±»ä¸­å°±åªæœ‰ä¸€ä¸ªæ„é€ æ–¹æ³•ï¼Œæ„é€ æ–¹æ³•ä¸­ç›´æ¥è°ƒç”¨äº†çˆ¶ç±»çš„æ„é€ ï¼ŒDexClassLoade**rç»§æ‰¿äº†BaseDexClassLoader**ï¼Œæ„é€ æ–¹æ³•ä¸­çš„å‚æ•°çš„å«ä¹‰æ˜¯ï¼š
- **dexPath**:dexæ–‡ä»¶è·¯å¾„
- **optimizedDirectory**ï¼šdexæ–‡ä»¶é¦–æ¬¡åŠ è½½æ—¶ä¼šè¿›è¡Œä¼˜åŒ–æ“ä½œï¼Œè¿™ä¸ªå‚æ•°å³ä¸ºä¼˜åŒ–åçš„odexæ–‡ä»¶çš„å­˜æ”¾ç›®å½•ï¼Œå®˜æ–¹æ¨èä½¿ç”¨åº”ç”¨ç§æœ‰ç›®å½•æ¥ç¼“å­˜ä¼˜åŒ–åçš„dexæ–‡ä»¶ï¼ŒdexOutputDir = context.getDir(â€œdexâ€, 0);
- **librarySearchPath**ï¼šåŠ¨æ€åº“è·¯å¾„
- **parent**ï¼šå½“å‰ç±»åŠ è½½å™¨çš„çˆ¶ç±»åŠ è½½å™¨



ç»§ç»­çœ‹`PathClassLoader`ï¼š

```java
public class PathClassLoader extends BaseDexClassLoader {
    public PathClassLoader(String dexPath, ClassLoader parent) {
        super((String)null, (File)null, (String)null, (ClassLoader)null);
        throw new RuntimeException("Stub!");
    }

    public PathClassLoader(String dexPath, String librarySearchPath, ClassLoader parent) {
        super((String)null, (File)null, (String)null, (ClassLoader)null);
        throw new RuntimeException("Stub!");
    }
}
```
PathClassLoaderæœ‰ä¸¤ä¸ªæ„é€ æ–¹æ³•ï¼ŒåŒæ ·ä¹Ÿæ˜¯ç›´æ¥è°ƒç”¨äº†çˆ¶ç±»çš„æ„é€ æ–¹æ³•ï¼Œä»æ„é€ æ–¹æ³•ä¸Šæ¥çœ‹ï¼Œ**DexClassLoaderå’ŒPathClassLoaderçš„åŒºåˆ«åªæœ‰ç¬¬äºŒä¸ªå‚æ•°optimizedDirectory**ï¼Œåœ¨PathClassLoaderä¸­optimizedDirectoryé»˜è®¤ä¼ å…¥çš„æ˜¯nullã€‚

ä»æºç ä¸­çœ‹è¿™ä¸¤ä¸ªç±»çš„**ä½œç”¨ä¹Ÿæ˜¯å› ä¸ºoptimizedDirectoryå‚æ•°çš„ä¸åŒè€Œä¸åŒ**ï¼Œ**åœ¨æºç ä¸­çœ‹ä½¿ç”¨PathClassLoaderç”±äºæ²¡æœ‰ä¼ å…¥optimizedDirectoryï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆä»¥åç¼“å­˜ç›®å½•ï¼Œå³/data/dalvik-cache/ï¼Œåœ¨è¿™ä¸ªç›®å½•å­˜æ”¾ä¼˜åŒ–ä»¥åçš„dexæ–‡ä»¶**ã€‚

æ‰€ä»¥**PathClassLoaderåªèƒ½åŠ è½½å·²å®‰è£…çš„apkçš„dex**ï¼Œå³åŠ è½½ç³»ç»Ÿçš„ç±»å’Œå·²ç»å®‰è£…çš„åº”ç”¨ç¨‹åºï¼ˆå®‰è£…çš„apkçš„dexæ–‡ä»¶ä¼šå­˜å‚¨åœ¨/data/dalvik-cacheä¸­ï¼‰ï¼Œè€Œ**DexClassLoaderå¯ä»¥åŠ è½½æŒ‡å®šè·¯å¾„çš„apkã€dexï¼Œä¹Ÿå¯ä»¥ä»sdå¡ä¸­è¿›è¡ŒåŠ è½½**ã€‚

**åŸºäºä¸Šé¢çš„åˆ†æï¼Œåœ¨åšæ’ä»¶åŒ–æ”¹é€ è¿‡ç¨‹ä¸­åªè¦åˆ›å»ºä¸€ä¸ªDexClassLoader å¯¹è±¡ï¼Œç„¶åä½¿ç”¨è¿™ä¸ªå¯¹è±¡å»åŠ è½½å¤–éƒ¨è·¯å¾„çš„classæ–‡ä»¶å³å¯**ï¼š
ç®€åŒ–è¿‡ç¨‹å¦‚ä¸‹ï¼š

```java
private void loadClass() {
	init();
	try {
        // ä»ä¼˜åŒ–åçš„dexæ–‡ä»¶ä¸­åŠ è½½APK_HELLO_CLASS_PATHç±»
        clazz = pluginClassLoader.loadClass("com.iflytek.test.HelloWorld");
    } catch (ClassNotFoundException e) {
        e.printStackTrace();
    }
}
private fun init() {
	extractPlugin()
	pluginPath = File(filesDir.absolutePath, "plugin.apk").absolutePath
	nativeLibDir = File(filesDir, "pluginlib").absolutePath
	dexOutPath = File(filesDir, "dexout").absolutePath
	// ç”Ÿæˆ DexClassLoader ç”¨æ¥åŠ è½½æ’ä»¶ç±»
	pluginClassLoader = DexClassLoader(pluginPath, dexOutPath, nativeLibDir, this::class.java.classLoader)
}

// ä» assets ä¸­æ‹¿å‡ºæ’ä»¶ apk æ”¾åˆ°å†…éƒ¨å­˜å‚¨ç©ºé—´
private fun extractPlugin() {
	var inputStream = assets.open("plugin.apk")
	File(filesDir.absolutePath, "plugin.apk").writeBytes(inputStream.readBytes())
}
```
è·å–åˆ°æ’ä»¶ä¸­çš„ç±»åŠ è½½å™¨åï¼Œå°±å¯ä»¥é€šè¿‡åå°„çš„æ–¹å¼å»è°ƒç”¨æ’ä»¶ä¸­ç±»çš„æ–¹æ³•ï¼š

```java
val loadClass = pluginClassLoader.loadClass(activityName)
loadClass.getMethod("hello",null).invoke(loadClass)
```
æœ€ååœ¨éœ€è¦åŠ è½½æ’ä»¶ä¸­çš„ç±»æ—¶ï¼š**éœ€è¦æ ¹æ®æ’ä»¶åç§°è·å–å¯¹åº”çš„æ’ä»¶ClassLoaderå³å¯**ï¼š

ç®€åŒ–ä»£ç å¦‚ä¸‹ï¼š

```java
PluginClassLoader.load(â€œæ’ä»¶åâ€,"éœ€è¦åŠ è½½çš„æ’ä»¶ç±»æƒé™å®šå")
```
### 2.æ’ä»¶èµ„æºåŠ è½½ï¼š
**èµ„æºæ³¨å…¥ï¼Œå…¶å®è¿™ä¸€ç‚¹ç›¸å½“é‡è¦**ï¼ŒAndroid åº”ç”¨çš„å¼€å‘å…¶å®å´‡å°šçš„æ˜¯é€»è¾‘ä¸èµ„æºåˆ†ç¦»çš„ç†å¿µï¼Œ
æ‰€æœ‰èµ„æºï¼ˆlayoutã€values ç­‰ï¼‰éƒ½ä¼šè¢«æ‰“åŒ…åˆ° Apk ä¸­ï¼Œç„¶åç”Ÿæˆä¸€ä¸ªå¯¹åº”çš„ R ç±»ï¼Œå…¶ä¸­åŒ…å«å¯¹æ‰€æœ‰èµ„æºçš„å¼•ç”¨ idã€‚

èµ„æºçš„æ³¨å…¥å¹¶ä¸å®¹æ˜“ï¼Œå¥½åœ¨ Android ç³»ç»Ÿç»™æˆ‘ä»¬ç•™äº†ä¸€æ¡åè·¯ï¼Œ**æœ€é‡è¦çš„æ˜¯è¿™ä¸¤ä¸ªæ¥å£**ï¼š

```java
PackageManager#getPackageArchiveInfoï¼šæ ¹æ® Apk è·¯å¾„è§£æä¸€ä¸ªæœªå®‰è£…çš„ Apk çš„ PackageInfo
PackageManager#getResourcesForApplicationï¼šæ ¹æ® ApplicationInfo åˆ›å»ºä¸€ä¸ª Resources å®ä¾‹
```
æˆ‘ä»¬è¦åšçš„å°±æ˜¯åœ¨åŠ è½½æ’ä»¶ Apkä¸­çš„èµ„æºä¹‹å‰åˆ›å»ºä¸€ä¸ªæ’ä»¶èµ„æºå®ä¾‹ã€‚
å…·ä½“æ¥è¯´å°±æ˜¯å…ˆç”¨ `PackageManager#getPackageArchiveInfo` **æ‹¿åˆ°æ’ä»¶ Apk çš„ PackageInfo**ï¼Œ
æœ‰äº† PacakgeInfo ä¹‹åæˆ‘ä»¬å°±å¯ä»¥è‡ªå·±ç»„è£…ä¸€ä»½ `ApplicationInfo`ï¼Œç„¶åé€šè¿‡ `PackageManager#getResourcesForApplication` æ¥åˆ›å»ºèµ„æºå®ä¾‹ï¼Œå¤§æ¦‚ä»£ç åƒè¿™æ ·ï¼š

```java
PackageManager packageManager = getPackageManager();
PackageInfo packageArchiveInfo = packageManager.getPackageArchiveInfo(
    pluginApkPath,
    PackageManager.GET_ACTIVITIES
    | PackageManager.GET_META_DATA
    | PackageManager.GET_SERVICES
    | PackageManager.GET_PROVIDERS
    | PackageManager.GET_SIGNATURES
);
packageArchiveInfo.applicationInfo.sourceDir = pluginApkPath;
packageArchiveInfo.applicationInfo.publicSourceDir = pluginApkPath;

Resources injectResources = null;
try {
    injectResources = packageManager.getResourcesForApplication(packageArchiveInfo.applicationInfo);
} catch (PackageManager.NameNotFoundException e) {
    // ...
}
```
æ‹¿åˆ°èµ„æºå®ä¾‹åï¼Œæˆ‘ä»¬éœ€è¦**å°†å®¿ä¸»çš„èµ„æºå’Œæ’ä»¶èµ„æº Merge ä¸€ä¸‹ï¼Œç¼–å†™ä¸€ä¸ªæ–°çš„ Resources ç±»**ï¼Œç”¨è¿™æ ·çš„æ–¹å¼å®Œæˆè‡ªåŠ¨ä»£ç†ï¼š

```java
public class PluginResources extends Resources {
    private Resources hostResources;
    private Resources injectResources;

    public PluginResources(Resources hostResources, Resources injectResources) {
        super(injectResources.getAssets(), injectResources.getDisplayMetrics(), injectResources.getConfiguration());
        this.hostResources = hostResources;
        this.injectResources = injectResources;
    }

    @Override
    public String getString(int id, Object... formatArgs) throws NotFoundException {
        try {
            return injectResources.getString(id, formatArgs);
        } catch (NotFoundException e) {
            return hostResources.getString(id, formatArgs);
        }
    }

    // ...
}
```


**å½“ç„¶ä½ ä¹Ÿå¯ä»¥ä¹Ÿå¯ä»¥æŠŠæ’ä»¶èµ„æºç‹¬ç«‹å‡ºæ¥ï¼Œç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶é€šè¿‡æ’ä»¶åå»å¯¹åº”è·¯å¾„ä¸‹å¯»æ‰¾apkï¼Œç„¶åæ ¹æ®apkè·¯å¾„åˆ›å»ºä¸€ä¸ªæ’ä»¶çš„PluginResourceså¯¹è±¡
æœ€åç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œä¸‹æ¬¡å°±ä¸ç”¨å†é‡æ–°åˆ›å»ºæ’ä»¶èµ„æº**

ç»“åˆ**ClassLoaderå’Œèµ„æºåŠ è½½**è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªContextæ¥åŒ…è£¹ä½æ’ä»¶ä¸­çš„è¿™äº›å¯¹è±¡ï¼š

```java
public class PluginContext extends ContextThemeWrapper {
	//æ’ä»¶ClassLoader
	private final ClassLoader pluginClassLoader;
	//æ’ä»¶Resources
    private final Resources pluginResource;
	//æ’ä»¶åç§°ï¼Œä¸€èˆ¬æ ¹æ®æ’ä»¶çš„apkåç§°æ¥
    private final String mPlugin;
	...
	
	@Override
    public ClassLoader getClassLoader() {
        if (pluginClassLoader != null) {
            return pluginClassLoader;
        }
        return super.getClassLoader();
    }
	
	@Override
    public Resources getResources() {
        if (pluginResource != null) {
            return pluginResource;
        }
        return super.getResources();
    }
	
	@Override
    public AssetManager getAssets() {
        if (pluginResource != null) {
            return pluginResource.getAssets();
        }
        return super.getAssets();
    }
}
```
æˆ‘ä»¬åœ¨ä½¿ç”¨æ’ä»¶ä¸­ç±»å’Œèµ„æºçš„æ—¶å€™ï¼Œå°±å¯ä»¥**é€šè¿‡PluginContextæ¥è·å–ClassLoaderå’ŒResourcesï¼Œ
å¾—åˆ°æ’ä»¶ä¸­çš„ç±»å’Œèµ„æº**


### 3.æ’ä»¶ä¸­å››å¤§ç»„ä»¶é€šè®¯
åœ¨è®²è§£æ’ä»¶ä¸­å››å¤§ç»„ä»¶é€šè®¯å‰æˆ‘ä»¬å…ˆæ¥äº†è§£ä¸‹**Activityçš„å¯åŠ¨è¿‡ç¨‹**ï¼š


Activityçš„å¯åŠ¨è¿‡ç¨‹ä¸»è¦åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯**æ ¹Activityçš„å¯åŠ¨è¿‡ç¨‹**ï¼Œä¸€ç§æ˜¯**æ™®é€šActivityçš„å¯åŠ¨è¿‡ç¨‹**ã€‚å…³äºæ ¹Activityçš„å¯åŠ¨è¿‡ç¨‹åœ¨å‰é¢æ–‡ç« ä»‹ç»è¿‡ï¼Œè¿™é‡Œæ¥ç®€å•å›é¡¾ä¸‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚
![Activityå¯åŠ¨è¿‡ç¨‹.awebp](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3e07ef730346432e9fec4ee1cb2960f7~tplv-k3u1fbpfcp-watermark.image?)

é¦–å…ˆLauncherè¿›ç¨‹å‘AMSè¯·æ±‚åˆ›å»ºæ ¹Activityï¼ŒAMSä¼šåˆ¤æ–­æ ¹Activityæ‰€éœ€çš„åº”ç”¨ç¨‹åºè¿›ç¨‹æ˜¯å¦å­˜åœ¨å¹¶å¯åŠ¨ï¼Œå¦‚æœä¸å­˜åœ¨å°±ä¼šè¯·æ±‚Zygoteè¿›ç¨‹åˆ›å»ºåº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚åº”ç”¨ç¨‹åºè¿›ç¨‹å¯åŠ¨åï¼ŒAMSä¼šè¯·æ±‚åº”ç”¨ç¨‹åºè¿›ç¨‹åˆ›å»ºå¹¶å¯åŠ¨æ ¹Activityã€‚

æ™®é€šActivityå’Œæ ¹Activityçš„å¯åŠ¨è¿‡ç¨‹å¤§åŒå°å¼‚ï¼Œä½†æ˜¯æ²¡æœ‰è¿™ä¹ˆå¤æ‚ï¼Œå› ä¸ºä¸æ¶‰åŠåº”ç”¨ç¨‹åºè¿›ç¨‹çš„åˆ›å»ºï¼Œè·ŸLaucherä¹Ÿæ²¡å…³ç³»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![æ™®é€šActivityå¯åŠ¨è¿‡ç¨‹.awebp](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c5a9cfaa08a24a3e9c5b4a02db4327bc~tplv-k3u1fbpfcp-watermark.image?)

ä¸Šå›¾æŠ½è±¡çš„ç»™å‡ºäº†æ™®é€šActicityçš„å¯åŠ¨è¿‡ç¨‹ã€‚åœ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­çš„Activityå‘AMSè¯·æ±‚åˆ›å»ºæ™®é€šActivityï¼ˆæ­¥éª¤1ï¼‰ï¼ŒAMSä¼šå¯¹
è¿™ä¸ªActivtyçš„**ç”Ÿå‘½å‘¨æœŸç®¡å’Œæ ˆè¿›è¡Œç®¡ç†ï¼Œæ ¡éªŒActivityç­‰ç­‰ã€‚å¦‚æœActivityæ»¡è¶³AMSçš„æ ¡éªŒï¼ŒAMSå°±ä¼šè¯·æ±‚åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­çš„ActivityThreadå»åˆ›å»ºå¹¶å¯åŠ¨æ™®é€šActivity.**

å¯ä»¥çœ‹å‡º:
> æˆ‘ä»¬éœ€è¦å¯åŠ¨ä¸€ä¸ªActivityï¼Œå°±éœ€è¦ç»è¿‡AMSæ ¡éªŒï¼ŒAMSä¼šæ£€æµ‹å½“å‰Activityæ˜¯å¦åœ¨AndroidManifest.xmlä¸­æ³¨å†Œè¿‡ï¼Œå¦‚æœæ²¡æœ‰æ³¨å†Œå°±ä¼šæŠ¥ActivityNotFoundException

ä¸‹é¢ç»™å‡ºæ–¹æ¡ˆï¼š
- 1.éœ€è¦åœ¨AndroidManifest.xmlä¸­æ³¨å†ŒActivityè¿›è¡Œå å‘ï¼Œ**ä½¿ç”¨å å‘çš„æ–¹å¼éª—è¿‡AMSçš„æ ¡éªŒ**
```java
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.music.anna.pluginactivity">S
    <application
       ...
        <activity android:name=".StubActivity"/>
    </application>
</manifest>
```
- 2.åœ¨AMSè¿”å›åˆ°å®¿ä¸»å·¥ç¨‹åï¼Œ**è¿˜åŸéœ€è¦å¯åŠ¨çš„æ’ä»¶Activity**ï¼Œç„¶ååˆ›å»ºå¯¹åº”çš„Activityå®ä¾‹ã€‚

**ä¸Šé¢çš„æ–¹æ¡ˆæœ‰ä¸‰ç§å®ç°æ–¹å¼ï¼š**

#### æ–¹å¼1ï¼šHook Instrumentation

```java
public class Instrumentation {
    //å¯åŠ¨Activityçš„æ—¶å€™ï¼Œè°ƒç”¨æ­¤æ–¹æ³•æ—¶ï¼Œæ›¿æ¢è°ƒIntent
    public ActivityResult execStartActivity(
            Context who, IBinder contextThread, IBinder token, Activity target,
            Intent intent, int requestCode, Bundle options) {
 
    }
 
    //AMSæ£€æµ‹åï¼Œåˆ›å»ºActivityä¹‹å‰æ›¿æ¢å›Intent
    public Activity newActivity(ClassLoader cl, String className,
                                Intent intent)
            throws InstantiationException, IllegalAccessException,
            ClassNotFoundException {
        
    }
}
```

Instrumentationä»£ç†ç±»å¦‚ä¸‹ï¼š

```java
public class InstrumentationProxy extends Instrumentation {
    private Instrumentation mInstrumentation;
    private PackageManager mPackageManager;
    public InstrumentationProxy(Instrumentation instrumentation, PackageManager packageManager) {
        mInstrumentation = instrumentation;
        mPackageManager = packageManager;
    }
	 //å¯åŠ¨Activityçš„æ—¶å€™ï¼Œè°ƒç”¨æ­¤æ–¹æ³•æ—¶ï¼Œæ›¿æ¢è°ƒIntent
    public ActivityResult execStartActivity(
            Context who, IBinder contextThread, IBinder token, Activity target,
            Intent intent, int requestCode, Bundle options) {
        List<ResolveInfo> infos = mPackageManager.queryIntentActivities(intent, PackageManager.MATCH_ALL);
        if (infos == null || infos.size() == 0) {
            intent.putExtra(HookHelper.TARGET_INTENsT_NAME, intent.getComponent().getClassName());//1
            intent.setClassName(who, "com.music.anna.pluginactivity.StubActivity");//2
        }
        try {
            Method execMethod = Instrumentation.class.getDeclaredMethod("execStartActivity",
                    Context.class, IBinder.class, IBinder.class, Activity.class, Intent.class, int.class, Bundle.class);
            return (ActivityResult) execMethod.invoke(mInstrumentation, who, contextThread, token,
                    target, intent, requestCode, options);
        } catch (Exception e) {
            e.printStackTrace();
        }
        return null;
    }
	
	//AMSæ£€æµ‹åï¼Œåˆ›å»ºActivityä¹‹å‰æ›¿æ¢å›Intent
	public Activity newActivity(ClassLoader cl, String className, Intent intent) throws InstantiationException,
        IllegalAccessException, ClassNotFoundException {
		String intentName = intent.getStringExtra(HookHelper.TARGET_INTENT_NAME);
		if (!TextUtils.isEmpty(intentName)) {
			return super.newActivity(cl, intentName, intent);
		}
		return super.newActivity(cl, className, intent);
	}
}
```

æœ€åä½¿ç”¨HookHelperå·¥å…·ç±»å°†InstrumentationProxyæ›¿æ¢ç³»ç»Ÿä¸­çš„mInstrumentation
ä»£ç å¦‚ä¸‹ï¼š

```java
public static void hookInstrumentation(Context context) throws Exception {
	Class<?> contextImplClass = Class.forName("android.app.ContextImpl");
	Field mMainThreadField  =FieldUtil.getField(contextImplClass,"mMainThread");//1
	Object activityThread = mMainThreadField.get(context);//2
	Class<?> activityThreadClass = Class.forName("android.app.ActivityThread");
	Field mInstrumentationField=FieldUtil.getField(activityThreadClass,"mInstrumentation");//3
	FieldUtil.setField(activityThreadClass,activityThread,"mInstrumentation",new InstrumentationProxy((Instrumentation) mInstrumentationField.get(activityThread),
			context.getPackageManager()));
}
```


#### æ–¹å¼2ï¼šHook IActivityManager.startActivityå’ŒActivityThread.mH.mCallback
- **IActivityManager**ï¼šç”¨äºåº”ç”¨è¿›ç¨‹å’ŒAMSè¿›è¡Œé€šè®¯çš„binderå¯¹è±¡ï¼Œåœ¨è°ƒç”¨AMSæ ¡éªŒActivityå‰ä½¿ç”¨å å‘Activityéª—è¿‡AMS
- **ActivityThread.mH.mCallback**ï¼šç”¨äºå¤„ç†AMSæ ¡éªŒåï¼Œè¿”å›åˆ°å®¿ä¸»çš„ApplicationThreadçº¿ç¨‹ä¸­ï¼Œå¤„ç†Activityåˆ›å»ºè¯·æ±‚ã€‚
ActivityThreadä¼šé€šè¿‡Hå°†ä»£ç çš„é€»è¾‘åˆ‡æ¢åˆ°ä¸»çº¿ç¨‹ä¸­ï¼ŒHç±»æ˜¯ActivityThreadçš„å†…éƒ¨ç±»å¹¶ç»§æ‰¿è‡ªHandlerï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚

```java
frameworks/base/core/java/android/app/ActivityThread.java
private class H extends Handler {
public static final int LAUNCH_ACTIVITY         = 100;
public static final int PAUSE_ACTIVITY          = 101;
...
public void handleMessage(Message msg) {
    if (DEBUG_MESSAGES) Slog.v(TAG, ">>> handling: " + codeToString(msg.what));
    switch (msg.what) {
        case LAUNCH_ACTIVITY: {
            Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, "activityStart");
            final ActivityClientRecord r = (ActivityClientRecord) msg.obj;

            r.packageInfo = getPackageInfoNoCheck(
                    r.activityInfo.applicationInfo, r.compatInfo);
            handleLaunchActivity(r, null, "LAUNCH_ACTIVITY");
            Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);
        } break;
        ...
      }
...
}
```
Hä¸­é‡å†™çš„handleMessageæ–¹æ³•ä¼šå¯¹LAUNCH_ACTIVITYç±»å‹çš„æ¶ˆæ¯è¿›è¡Œå¤„ç†ï¼Œæœ€ç»ˆä¼šè°ƒç”¨Activityçš„onCreateæ–¹æ³•ã€‚é‚£ä¹ˆåœ¨å“ªè¿›è¡Œæ›¿æ¢å‘¢ï¼Ÿæ¥ç€æ¥çœ‹Handlerçš„dispatchMessageæ–¹æ³•ï¼š

```java
frameworks/base/core/java/android/os/Handler.java
public void dispatchMessage(Message msg) {
	if (msg.callback != null) {
		handleCallback(msg);
	} else {
		if (mCallback != null) {
			if (mCallback.handleMessage(msg)) {
				return;
			}
		}
		handleMessage(msg);
	}
}
```
Handlerçš„dispatchMessageç”¨äºå¤„ç†æ¶ˆæ¯ï¼Œçœ‹åˆ°å¦‚æœHandlerçš„Callbackç±»å‹çš„mCallbackä¸ä¸ºnullï¼Œå°±ä¼šæ‰§è¡ŒmCallbackçš„handleMessageæ–¹æ³•ã€‚å› æ­¤ï¼ŒmCallbackå¯ä»¥ä½œä¸ºHookç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨è‡ªå®šä¹‰çš„Callbackæ¥æ›¿æ¢mCallbackï¼Œè‡ªå®šä¹‰çš„Callbackå¦‚ä¸‹æ‰€ç¤ºã€‚

**HCallback.java**

```java
public class HCallback implements Handler.Callback{
    public static final int LAUNCH_ACTIVITY = 100;
    Handler mHandler;
    public HCallback(Handler handler) {
        mHandler = handler;
    }
    @Override
    public boolean handleMessage(Message msg) {
        if (msg.what == LAUNCH_ACTIVITY) {
            Object r = msg.obj;
            try {
                //å¾—åˆ°æ¶ˆæ¯ä¸­çš„Intent(å¯åŠ¨SubActivityçš„Intent)
                Intent intent = (Intent) FieldUtil.getField(r.getClass(), r, "intent");
                //å¾—åˆ°æ­¤å‰ä¿å­˜èµ·æ¥çš„Intent(å¯åŠ¨TargetActivityçš„Intent)
                Intent target = intent.getParcelableExtra(HookHelper.TARGET_INTENT);
                //å°†å¯åŠ¨SubActivityçš„Intentæ›¿æ¢ä¸ºå¯åŠ¨TargetActivityçš„Intent
                intent.setComponent(target.getComponent());
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
        mHandler.handleMessage(msg);
        return true;
    }
}
```

HCallbackå®ç°äº†Handler.Callbackï¼Œå¹¶é‡å†™äº†handleMessageæ–¹æ³•ï¼Œå½“æ”¶åˆ°æ¶ˆæ¯çš„ç±»å‹ä¸ºLAUNCH_ACTIVITYæ—¶ï¼Œå°†å¯åŠ¨SubActivityçš„Intentæ›¿æ¢ä¸ºå¯åŠ¨TargetActivityçš„Intentã€‚æ¥ç€æˆ‘ä»¬åœ¨HookHelperä¸­å®šä¹‰ä¸€ä¸ªhookHandleræ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºã€‚

```java
public static void hookHandler() throws Exception {
	Class<?> activityThreadClass = Class.forName("android.app.ActivityThread");
	Object currentActivityThread= FieldUtil.getField(activityThreadClass ,null,"sCurrentActivityThread");//1
	Field mHField = FieldUtil.getField(activityThread,"mH");//2
	Handler mH = (Handler) mHField.get(currentActivityThread);//3
	FieldUtil.setField(Handler.class,mH,"mCallback",new HCallback(mH));
}
```

ActivityThreadç±»ä¸­æœ‰ä¸€ä¸ªé™æ€å˜é‡sCurrentActivityThreadï¼Œç”¨äºè¡¨ç¤ºå½“å‰çš„ActivityThreadå¯¹è±¡ï¼Œ
å› æ­¤
- åœ¨**æ³¨é‡Š1å¤„**è·å–ActivityThreadä¸­å®šä¹‰çš„sCurrentActivityThreadå¯¹è±¡ã€‚
- **æ³¨é‡Š2å¤„**è·å–ActivityThreadç±»çš„mHå­—æ®µï¼Œ
- æ¥ç€**åœ¨æ³¨é‡Š3å¤„**è·å–å½“å‰ActivityThreadå¯¹è±¡ä¸­çš„mHå¯¹è±¡ï¼Œ
- æœ€åç”¨HCallbackæ¥æ›¿æ¢mHä¸­çš„mCallbackã€‚

åœ¨MyApplicationçš„attachBaseContextæ–¹æ³•ä¸­è°ƒç”¨HookHelperçš„hookHandleræ–¹æ³•ï¼Œè¿è¡Œç¨‹åºï¼Œå½“æˆ‘ä»¬ç‚¹å‡»å¯åŠ¨æ’ä»¶æŒ‰é’®ï¼Œå‘ç°å¯åŠ¨çš„æ˜¯æ’ä»¶TargetActivityã€‚


#### æ–¹å¼3ï¼šHookä½ClassLoader
è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨`RePlugin`æ¡†æ¶çš„åŸç†æ¥è®²è§£ä¸‹ï¼š
**RePluginå…¨å±€åªhookäº†ä¸€ä¸ªç‚¹ï¼Œé‚£å°±æ˜¯ClassLoader**
åŸç†å›¾ï¼š

![repluginæ’ä»¶åŸç†å›¾.webp](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1e869dea5b2a44d7ad71a44c6fb793a5~tplv-k3u1fbpfcp-watermark.image?)
ä»åŸç†å›¾ä¸­æˆ‘ä»¬çœ‹åˆ°Replugin hookäº†ä¸¤ä¸ªClassLoader
- `RePluginClassLoader`ï¼šç»§æ‰¿`PathClassLoader`æ‰€ä»¥åªèƒ½ç”¨äºåŠ è½½å®¿ä¸»ä¸­çš„å·²ç»å®‰è£…çš„ç±»ã€‚
- `PluginDexClassLoader`ï¼šç»§æ‰¿è‡ª`DexClassLoader`ï¼Œå‰é¢æˆ‘ä»¬åˆ†æè¿‡ï¼Œ**DexClassLoaderå¯ä»¥åŠ è½½å¤–éƒ¨è·¯å¾„ä¸Šçš„ç±»**


**åœ¨`æ­¥éª¤2`ä¸­ï¼šæ‰¾åˆ°å¯¹åº”çš„æ’ä»¶ä¸­å››å¤§ç»„ä»¶ä¿¡æ¯**

æ’ä»¶ä¿¡æ¯ä½¿ç”¨ä¸‹é¢æ–¹å¼è·å–ï¼š

- **2.1**ï¼šè·å–æ’ä»¶çš„`mPackageInfo`
```java
 mPackageInfo = pm.getPackageArchiveInfo(mPath,
                        PackageManager.GET_ACTIVITIES | PackageManager.GET_SERVICES | PackageManager.GET_PROVIDERS | PackageManager.GET_RECEIVERS | PackageManager.GET_META_DATA);
```
- **2.2**ï¼šé€šè¿‡`mPackageInfo`è·å–å››å¤§ç»„ä»¶ä¿¡æ¯ä»¥åŠé…ç½®æ¸…å•æ–‡ä»¶ä¿¡æ¯

```java
/**
 * åˆå§‹åŒ–ComponentListå¯¹è±¡ <p>
 * æ³¨æ„ï¼šä»…æ¡†æ¶å†…éƒ¨ä½¿ç”¨
 */
public ComponentList(PackageInfo pi, String path, PluginInfo pli) {
    if (pi.activities != null) {
        for (ActivityInfo ai : pi.activities) {
            if (LOG) {
                    LogDebug.d(PLUGIN_TAG, "activity=" + ai.name);
            }
            ai.applicationInfo.sourceDir = path;
            // todo extract to function
            if (ai.processName == null) {
                    ai.processName = ai.applicationInfo.processName;
            }
            if (ai.processName == null) {
                    ai.processName = ai.packageName;
            }
            mActivities.put(ai.name, ai);
        }
    }
    if (pi.providers != null) {
        for (ProviderInfo ppi : pi.providers) {
            if (LOG) {
                    LogDebug.d(PLUGIN_TAG, "provider=" + ppi.name + "; auth=" + ppi.authority);
            }
            if (ppi.processName == null) {
                    ppi.processName = ppi.applicationInfo.processName;
            }
            if (ppi.processName == null) {
                    ppi.processName = ppi.packageName;
            }
            mProvidersByName.put(ppi.name, ppi);
            mProvidersByAuthority.put(ppi.authority, ppi);
        }
    }
    if (pi.services != null) {
        for (ServiceInfo si : pi.services) {
            if (LOG) {
                    LogDebug.d(PLUGIN_TAG, "service=" + si.name);
            }
            if (si.processName == null) {
                    si.processName = si.applicationInfo.processName;
            }
            if (si.processName == null) {
                    si.processName = si.packageName;
            }
            mServices.put(si.name, si);
        }
    }
    if (pi.receivers != null) {
        for (ActivityInfo ri : pi.receivers) {
            if (LOG) {
                    LogDebug.d(PLUGIN_TAG, "receiver=" + ri.name);
            }
            if (ri.processName == null) {
                    ri.processName = ri.applicationInfo.processName;
            }
            if (ri.processName == null) {
                    ri.processName = ri.packageName;
            }
            mReceivers.put(ri.name, ri);
        }
    }
    // è§£æ Apk ä¸­çš„ AndroidManifest.xml
    String manifest = getManifestFromApk(path);
}	
```


**åœ¨`æ­¥éª¤3`ä¸­ï¼šç»™æ’ä»¶ä¸­çš„Activityåˆ†é…å ä½Activityï¼Œç”¨äºæ¬ºéª—AMS**

```java
// è¿œç¨‹åˆ†é…å‘ä½
container = client.allocActivityContainer(plugin, process, ai.name, intent);
```
**åœ¨`æ­¥éª¤8å’Œ9`ä¸­ï¼šè¿™ä¸¤ä¸ªæ­¥éª¤å°±æ˜¯å–å‡ºå‘ä½Activityä¸­çœŸæ­£è¦å¯åŠ¨çš„æ’ä»¶Activityï¼Œé€šè¿‡æ˜ å°„è·å–**

å‰é¢è¯´è¿‡Activityåœ¨å›è°ƒçš„æ—¶å€™ä¼šå¯åŠ¨`Instrumentation`çš„`newActivity`åˆ›å»ºActivityï¼š

```java
public Activity newActivity(ClassLoader cl, String className,
		Intent intent)
		throws InstantiationException, IllegalAccessException,
		ClassNotFoundException {
	String pkg = intent != null && intent.getComponent() != null
			? intent.getComponent().getPackageName() : null;
	return getFactory(pkg).instantiateActivity(cl, className, intent);
}
public @NonNull Activity instantiateActivity(@NonNull ClassLoader cl, @NonNull String className,
		@Nullable Intent intent)
		throws InstantiationException, IllegalAccessException, ClassNotFoundException {
	return (Activity) cl.loadClass(className).newInstance();
}
```

æœ€ç»ˆè°ƒç”¨cl.loadClass(className).newInstance()åˆ›å»ºä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼š

è¿™ä¸ªæ—¶å€™çš„:
- **cl**ï¼šè¿˜æ˜¯å®¿ä¸»çš„PluginClassLoaderï¼Œ
- **className**ï¼šå å‘Activityç±»å

è¦å®ç°å¯åŠ¨æ’ä»¶Activityï¼Œæˆ‘ä»¬å°±éœ€è¦æ¥çœ‹å®¿ä¸»çš„RePluginClassLoaderçš„loadClassæ–¹æ³•æ˜¯å¦‚ä½•æ“ä½œçš„ï¼š

```java
protected Class<?> loadClass(String className, boolean resolve) throws ClassNotFoundException {
    //
    Class<?> c = null;
    c = PMF.loadClass(className, resolve);
    if (c != null) {
        return c;
    }
    //
    try {
        c = mOrig.loadClass(className);
        // åªæœ‰å¼€å¯â€œè¯¦ç»†æ—¥å¿—â€æ‰ä¼šè¾“å‡ºï¼Œé˜²æ­¢â€œåˆ·å±â€ç°è±¡
        if (LogDebug.LOG && RePlugin.getConfig().isPrintDetailLog()) {
                LogDebug.d(TAG, "loadClass: load other class, cn=" + className);
        }
        return c;
    } catch (Throwable e) {
        //
    }
    //
    return super.loadClass(className, resolve);
}
```


è¿›å…¥PMF.loadClass(className, resolve);

```java
final Class<?> loadClass(String className, boolean resolve) {
    // åŠ è½½Serviceä¸­ä»‹å‘ä½
    if (className.startsWith(PluginPitService.class.getName())) {
        return PluginPitService.class;
    }

    //
    if (mContainerActivities.contains(className)) {
        Class<?> c = mClient.resolveActivityClass(className);
        if (c != null) {
                return c;
        }
        return DummyActivity.class;
    }

    //
    if (mContainerServices.contains(className)) {
        Class<?> c = loadServiceClass(className);
        if (c != null) {
                return c;
        }
        return DummyService.class;
    }

    //
    if (mContainerProviders.contains(className)) {
        Class<?> c = loadProviderClass(className);
        if (c != null) {
                return c;
        }
        return DummyProvider.class;
    }
    ...
    return loadDefaultClass(className);
}
```

**å¯ä»¥çœ‹åˆ°è¿™é‡Œé¢è·å–çš„æ˜¯æ˜ å°„è¡¨ä¸­çš„æ’ä»¶å››å¤§ç»„ä»¶classç±»ï¼Œè¿”å›çš„æ˜¯æ’ä»¶ä¸­çš„ç±»**


è¿™é‡Œclassç±»å°±æ˜¯é€šè¿‡å‰é¢è¯´çš„æ’ä»¶ClassLoaderï¼šPluginDexClassLoaderè¿›è¡ŒåŠ è½½ã€‚

PluginDexClassLoaderä¸­é‡å†™äº†loadClassæ–¹æ³•ï¼Œæˆ‘ä»¬å°±å…¥æºç çœ‹çœ‹ï¼š

```java
@Override
protected Class<?> loadClass(String className, boolean resolve) throws ClassNotFoundException {
    // æ’ä»¶è‡ªå·±çš„Classã€‚ä»è‡ªå·±å¼€å§‹ä¸€ç›´åˆ°BootClassLoaderï¼Œé‡‡ç”¨æ­£å¸¸çš„åŒäº²å§”æ´¾æ¨¡å‹æµç¨‹ï¼Œè¯»åˆ°äº†å°±ç›´æ¥è¿”å›
    Class<?> pc = null;
    ClassNotFoundException cnfException = null;
    try {
        pc = super.loadClass(className, resolve);
        if (pc != null) {
                ...
                return pc;
        }
    } catch (ClassNotFoundException e) {
        if (PluginDexClassLoaderPatch.need2LoadFromHost(className)) {
                try {
                        return loadClassFromHost(className, resolve);
                } catch (ClassNotFoundException e1) {

                }
        }
    }

    // è‹¥æ’ä»¶é‡Œæ²¡æœ‰æ­¤ç±»ï¼Œåˆ™ä¼šä»å®¿ä¸»ClassLoaderä¸­æ‰¾ï¼Œæ‰¾åˆ°äº†åˆ™ç›´æ¥è¿”å›
    // æ³¨æ„ï¼šéœ€è¦è¯»å–isUseHostClassIfNotFoundå¼€å…³ã€‚é»˜è®¤ä¸ºå…³é—­çš„ã€‚å¯å‚è§è¯¥å¼€å…³çš„è¯´æ˜
    if (RePlugin.getConfig().isUseHostClassIfNotFound()) {
        try {
                return loadClassFromHost(className, resolve);
        } catch (ClassNotFoundException e) {

        }
    }
    // At this point we can throw the previous exception
    if (cnfException != null) {
        throw cnfException;
    }
    return null;
}
```

å¯ä»¥çœ‹åˆ°å…¶åœ¨åŠ è½½ç±»çš„æ—¶å€™ï¼Œä¼š**ä¼˜å…ˆåŠ è½½å½“å‰æ’ä»¶ä¸­çš„ç±»ï¼Œå¦‚æœæ²¡æ‰¾åˆ°ï¼Œå†å»åŠ è½½å®¿ä¸»ä¸­çš„ç±»**
æ¥çœ‹ã€‚è¿™æ ·å°±å¯ä»¥æˆåŠŸæ‰¾åˆ°æ’ä»¶ä¸­çš„Activityï¼Œä¹‹åå°±å¯ä»¥è·³è½¬äº†ã€‚

è¿™é‡Œå€Ÿé‰´ä¸‹**æ‹çŒ«deå°éƒ­**çš„å›¾æ¥æè¿°ä¸‹Repluginä¸­çš„ClassLoaderè°ƒç”¨å…³ç³»ï¼š

![åŒClassLoaderå…³ç³».awebp](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/81a70e8f46144b219d5b30ac924cb68e~tplv-k3u1fbpfcp-watermark.image?)

é€šè¿‡è¿™å‡ ä¸ªæ­¥éª¤åŠå®ç°äº†åªhook ClassLoaderå®ç°æ’ä»¶å’Œå®¿ä¸»ä¹‹é—´çš„é€šè®¯ã€‚

### 4.è¿è¡Œæ—¶å®¹å™¨æŠ€æœ¯ï¼ˆProxyActivityä»£ç†ï¼‰
å››å¤§ç»„ä»¶é€šè®¯é™¤äº†ä¸Šé¢çš„Activityå å‘æ–¹å¼å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ä¸€ç§**è¿è¡Œæ—¶å®¹å™¨æŠ€æœ¯**ã€‚

è¿è¡Œæ—¶å®¹å™¨æŠ€æœ¯ï¼Œç®€å•æ¥è¯´å°±æ˜¯åœ¨å®¿ä¸» `Apk` ä¸­é¢„åŸ‹ä¸€äº›ç©ºçš„ `Android` ç»„ä»¶ï¼Œä»¥ `Activity` ä¸ºä¾‹ï¼Œæˆ‘é¢„ç½®ä¸€ä¸ª `ContainerActivity extends Activity` åœ¨å®¿ä¸»ä¸­ï¼Œå¹¶ä¸”åœ¨ `AndroidManifest.xml` ä¸­æ³¨å†Œå®ƒã€‚
å®ƒè¦åšçš„äº‹æƒ…å¾ˆç®€å•ï¼Œå°±æ˜¯å¸®åŠ©æˆ‘ä»¬ä½œä¸ºæ’ä»¶ `Activity` çš„å®¹å™¨ï¼Œå®ƒä» `Intent` æ¥å—å‡ ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯æ’ä»¶çš„ä¸åŒä¿¡æ¯ï¼Œå¦‚ï¼š
-   `pluginName`
-   `pluginApkPath`
-   `pluginActivityName`

ç­‰ï¼Œå…¶å®æœ€é‡è¦çš„å°±æ˜¯ `pluginApkPath` å’Œ `pluginActivityName`ï¼Œå½“ `ContainerActivity` å¯åŠ¨æ—¶ï¼Œæˆ‘ä»¬å°±åŠ è½½æ’ä»¶çš„ `ClassLoader`ã€`Resource`ï¼Œå¹¶åå°„ `pluginActivityName` å¯¹åº”çš„ `Activity` ç±»ã€‚å½“å®ŒæˆåŠ è½½åï¼Œ`ContainerActivity` è¦åšä¸¤ä»¶äº‹ï¼š

-   è½¬å‘æ‰€æœ‰æ¥è‡ªç³»ç»Ÿçš„ç”Ÿå‘½å‘¨æœŸå›è°ƒè‡³æ’ä»¶ `Activity`
-   æ¥å— `Activity` æ–¹æ³•çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå¹¶è½¬å‘å›ç³»ç»Ÿ

æˆ‘ä»¬å¯ä»¥é€šè¿‡å¤å†™ `ContainerActivity` çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•æ¥å®Œæˆç¬¬ä¸€æ­¥ï¼Œè€Œç¬¬äºŒæ­¥æˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ª `PluginActivity`ï¼Œç„¶ååœ¨ç¼–å†™æ’ä»¶ `Apk` ä¸­çš„ `Activity` ç»„ä»¶æ—¶ï¼Œä¸å†è®©å…¶é›†æˆ `android.app.Activity`ï¼Œè€Œæ˜¯é›†æˆè‡ªæˆ‘ä»¬çš„ `PluginActivity`


```java
public class ContainerActivity extends Activity {
    private PluginActivity pluginActivity;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        String pluginActivityName = getIntent().getString("pluginActivityName", "");
        pluginActivity = PluginLoader.loadActivity(pluginActivityName, this);
        if (pluginActivity == null) {
            super.onCreate(savedInstanceState);
            return;
        }

        pluginActivity.onCreate();
    }

    @Override
    protected void onResume() {
        if (pluginActivity == null) {
            super.onResume();
            return;
        }
        pluginActivity.onResume();
    }

    @Override
    protected void onPause() {
        if (pluginActivity == null) {
            super.onPause();
            return;
        }
        pluginActivity.onPause();
    }

    // ...
}
```
å¤§æ¦‚åŸç†å°±æ˜¯è¿™ä¹ˆç®€å•ï¼Œå¯åŠ¨æ’ä»¶ç»„ä»¶éœ€è¦ä¾èµ–å®¹å™¨ï¼Œå®¹å™¨è´Ÿè´£åŠ è½½æ’ä»¶ç»„ä»¶å¹¶ä¸”å®ŒæˆåŒå‘è½¬å‘ï¼Œè½¬å‘æ¥è‡ªç³»ç»Ÿçš„ç”Ÿå‘½å‘¨æœŸå›è°ƒè‡³æ’ä»¶ç»„ä»¶ï¼ŒåŒæ—¶è½¬å‘æ¥è‡ªæ’ä»¶ç»„ä»¶çš„ç³»ç»Ÿè°ƒç”¨è‡³ç³»ç»Ÿã€‚
## æœ€åæ¥ä»‹ç»ä¸‹å‡ ç§ä¸»æµæ’ä»¶åŒ–å¼€æºæ¡†æ¶ï¼š

#### é˜¿é‡Œç³»`Atlas`:https://github.com/alibaba/atlas
**Atlaså®¹å™¨æ¡†æ¶**ï¼š
![atlaså®¹å™¨æ¡†æ¶.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bd9ccf90948b4f2ba6afe0ee464cd4bd~tplv-k3u1fbpfcp-watermark.image?)
**æ”¯æŒç‰¹æ€§**ï¼š

| åŠŸèƒ½           | è¯´æ˜                                                         |
| -------------- | ------------------------------------------------------------ |
| å››å¤§ç»„ä»¶æ”¯æŒ   | æ”¯æŒè¿è¡Œbundleä¸­çš„å››å¤§ç»„ä»¶                                   |
| å…±äº«ä»£ç èµ„æº   | bundleå¯ä»¥ç›´æ¥ä½¿ç”¨hostä¸­çš„ä»£ç å’Œèµ„æº                         |
| bundleæŒ‰éœ€åŠ è½½ | ä¸šåŠ¡éœ€è¦æ—¶ï¼Œæ‰ä¼šå»åŠ è½½å¯¹åº”bundleä¸­çš„ä»£ç å’Œèµ„æº               |
| è¿œç¨‹bundle     | å‡å°‘åŒ…ä½“ç§¯ã€‚ä¸å¸¸ç”¨çš„bundleæ”¾åœ¨äº‘ç«¯ï¼Œéœ€è¦æ—¶æŒ‰éœ€ä¸‹è½½ã€‚å½“ç”¨æˆ·è®¾å¤‡ç©ºé—´ç´§å¼ æ—¶,å¯ä»¥æ¸…ç†æ‰ä¸€äº›é•¿æœŸä¸ç”¨çš„ç»„ä»¶ |
| è§£é‡Šæ‰§è¡Œ       | ä¸ºäº†é™ä½ç”¨æˆ·ç­‰å¾…æ—¶é—´ï¼ŒAtlasæ¡†æ¶åœ¨dalivkç³»ç»Ÿä¸Šé¦–æ¬¡ä½¿ç”¨bundleæ—¶å…³é—­äº†verifyï¼Œåœ¨ARTç³»ç»Ÿä¸Šé¦–æ¬¡ä½¿ç”¨æ—¶å…³é—­äº†dex2oatèµ°è§£é‡Šæ‰§è¡Œã€‚åŒæ—¶åå°é€šè¿‡å¼‚æ­¥ä»»åŠ¡èµ°åŸç”Ÿçš„dexoptè¿‡ç¨‹ï¼Œä¸ºä¸‹æ¬¡ä½¿ç”¨åšå¥½å‡†å¤‡ |


#### 360ç³»`RePlugin`:https://github.com/Qihoo360/RePlugin

RePluginæ˜¯ä¸€å¥—å®Œæ•´çš„ã€ç¨³å®šçš„ã€é€‚åˆå…¨é¢ä½¿ç”¨çš„ï¼Œå å‘ç±»æ’ä»¶åŒ–æ–¹æ¡ˆï¼š
- **å®Œæ•´çš„**ï¼šè®©æ’ä»¶è¿è¡Œèµ·æ¥â€œåƒå•å“é‚£æ ·â€ï¼Œæ”¯æŒå¤§éƒ¨åˆ†ç‰¹æ€§
- **ç¨³å®šçš„**ï¼šå¦‚æ­¤çµæ´»å®Œæ•´çš„æƒ…å†µä¸‹ï¼Œå…¶æ¡†æ¶å´©æºƒç‡ä»…ä¸ºä¸šå†…å¾ˆä½çš„â€œä¸‡åˆ†ä¹‹ä¸€â€
- **é€‚åˆå…¨é¢ä½¿ç”¨çš„**ï¼šå…¶ç›®çš„æ˜¯è®©åº”ç”¨å†…çš„â€œæ‰€æœ‰åŠŸèƒ½çš†ä¸ºæ’ä»¶â€
- **å å‘ç±»**ï¼šä»¥ç¨³å®šä¸ºå‰æçš„Manifestå å‘æ€è·¯
- **æ’ä»¶åŒ–æ–¹æ¡ˆ**ï¼šåŸºäºAndroidåŸç”ŸAPIå’Œè¯­è¨€æ¥å¼€å‘ï¼Œå……åˆ†åˆ©ç”¨åŸç”Ÿç‰¹æ€§

**æ”¯æŒç‰¹æ€§**ï¼š

| Feature                                      | Description                                             |
| -------------------------------------------- | ------------------------------------------------------- |
| Components                                   | Activity, Service, Provider, Receiver(Including static) |
| Not need to upgrade when brand a new Plug-in | Supported                                               |
| Android Feature                              | Supported almost all features                           |
| TaskAffinity & Multi-Process                 | Perfect supported!                                      |
| Support Plug-in Type                         | Built-in (Only Two Step) and External(Download)         |
| Plug-in Coupling                             | Binder, Class Loader, Resources, etc.                   |
| Interprocess communication                   | Sync, Async, Binder and Cross-plug-in broadcast         |
| User-Defined                                 | Theme & AppComat	Supported                           |
| DataBinding                                  | Supported                                               |
| Safety check when installed                  | Supported                                               |
| Resources Solution                           | Independent Resources + Context pass(No Adaptation ROM) |
| Android Version                              | API Level 9 (Android 2.3 and above)                     |


#### é«˜ä¸­ç”Ÿç½—è¿ª`VirtualApp`:https://github.com/asLody/VirtualApp
VirtualApp ä½œè€…æ˜¯é«˜ä¸­ç”Ÿç½—è¿ªï¼Œæ®è¯´è¿™ä¸ª Android å¤§ç‰›åˆä¸‰çš„æ—¶å€™å°±å¼€å§‹ç ”ç©¶åŒå¼€ã€æ’ä»¶åŒ–çš„æŠ€æœ¯ï¼Œç›¸å½“äº†ä¸èµ·ã€‚
é¡¹ç›®çš„æ€è·¯ä¸DroidPlugin ç›¸ä¼¼ï¼Œä¸è¿‡ä»–æ²¡æœ‰æä¾› Service çš„ä»£ç†ï¼Œè€Œæ˜¯ä½¿ç”¨ ContentProvider æ¥ä»£æ›¿ Service åœ¨å®¿ä¸»ä¸­ä½œä¸ºçœŸæ­£çš„è¿è¡Œä½“ã€‚
è¿™æ¬¾æ¡†æ¶åœ¨2017å¹´12æœˆä»½å·²ç»ä½œåºŸï¼Œä¸è¿‡å•†ç”¨ç‰ˆæœ¬åœ¨æ›´æ–°ã€‚

åŸç†ï¼š**hookäº†AMS**
#### è…¾è®¯ç³»`Shadow`:https://github.com/Tencent/Shadow
**æ”¯æŒç‰¹æ€§**ï¼š
- å››å¤§ç»„ä»¶
- Fragmentï¼ˆä»£ç æ·»åŠ å’ŒXmlæ·»åŠ ï¼‰
- DataBindingï¼ˆæ— éœ€ç‰¹åˆ«æ”¯æŒï¼Œä½†å·²éªŒè¯å¯æ­£å¸¸å·¥ä½œï¼‰
- è·¨è¿›ç¨‹ä½¿ç”¨æ’ä»¶Service
- è‡ªå®šä¹‰Theme
- æ’ä»¶è®¿é—®å®¿ä¸»ç±»
- SoåŠ è½½
- åˆ†æ®µåŠ è½½æ’ä»¶ï¼ˆå¤šApkåˆ†åˆ«åŠ è½½æˆ–å¤šApkä»¥æ­¤ä¾èµ–åŠ è½½ï¼‰
- ä¸€ä¸ªActivityä¸­åŠ è½½å¤šä¸ªApkä¸­çš„View
ç­‰ç­‰â€¦â€¦

> å…³äºå¦‚ä½•é€‰æ‹©æ’ä»¶åŒ–æ¡†æ¶ï¼Œè¿™ä¸ªè§ä»è§æ™ºï¼Œå¯ä»¥æ ¹æ®è‡ªèº«é¡¹ç›®éœ€æ±‚å’Œæ¡†æ¶ç‰¹æ€§è¿›è¡Œé€‰æ‹©ã€‚

## æ€»ç»“
è®²äº†é‚£ä¹ˆå¤šè¿™é‡Œæ˜¯è¯¥æ€»ç»“ä¸‹äº†ï¼š
æœ¬æ–‡ä¸»è¦è®²è§£äº†å½“å‰ä¸»æµæ’ä»¶åŒ–ä½¿ç”¨åˆ°çš„æ’ä»¶åŒ–æŠ€æœ¯

ä¸»è¦æœ‰ï¼š
1.**ç±»çš„åŠ è½½è¿‡ç¨‹ä»¥åŠåŸç†**
2.**èµ„æºçš„æ³¨å…¥è¿‡ç¨‹ä»¥åŠåŸç†**
3.**æ’ä»¶å’Œå®¿ä¸»ä¹‹é—´å››å¤§ç»„ä»¶é€šè®¯æœºåˆ¶**ã€‚è¯´åˆ°äº†å‡ ç§hookæ–¹å¼
4.**ä»‹ç»äº†å‡ ç§ä¸»æµæ¡†æ¶çš„ç‰¹æ€§**ã€‚

**ä¸€èˆ¬å¤§å‚éƒ½æœ‰è‡ªå·±çš„å¼€æºæ¡†æ¶ï¼Œè€Œå¼€æºå‡ºæ¥çš„éƒ¨åˆ†åªæ˜¯å†°å±±ä¸€è§’ï¼Œä½†æˆ‘ä»¬ä¹Ÿå¸Œæœ›é€šè¿‡è¿™ä¸€è§’æ¥çª¥æ¢é“æ’ä»¶åŒ–å†…éƒ¨çš„å¥¥ç§˜**ã€‚

**å‚è€ƒèµ„æ–™**

- [Androidæ’ä»¶åŒ–åŸç†ï¼ˆä¸€ï¼‰Activityæ’ä»¶åŒ–](https://juejin.cn/post/6844903613865672718#heading-1)

- [Atlaså®˜æ–¹æ–‡æ¡£](https://alibaba.github.io/atlas/)

- [æµ…è°ˆAndroidæ’ä»¶åŒ–](https://juejin.cn/post/6973888932572315678)
- [RePluginåŸç†ä»‹ç»](https://mp.weixin.qq.com/s?__biz=MzUxMzcxMzE5Ng==&mid=2247488237&idx=1&sn=477d32770ab3c57f2ad6af957be55677&source=41#wechat_redirect)
- [æ’ä»¶åŒ–çš„åŸç†åˆ†æåŠå®ç°](https://blog.csdn.net/cj_286/article/details/103569514)